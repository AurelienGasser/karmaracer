/*! karmaracer 2013-05-09 */
var Karma=Karma||{},KLib=KLib||{};(function(){"use strict";KLib.isFunction=function(t){return"function"==typeof t},KLib.isUndefined=function(t){return void 0===t},KLib.extend=function(t,e){function i(t,e){function i(){return t.apply(this,e)}return i.prototype=t.prototype,new i}var a=i(t,Array.prototype.slice.call(arguments,2));e.base={};for(var n in a)if(KLib.isUndefined(e[n])){var s=a[n];e[n]=s}else e.base[n]=t.prototype[n]}})(),function(){"use strict";var t=function(){function t(t){return n.karma[t]}function e(e){var i=t(e);return void 0===i?!1:!0}function i(){localStorage.karma=JSON.stringify(n.karma)}function a(t,e){n.karma[t]=e,i()}this.karma=_.isUndefined(localStorage.karma)?{}:JSON.parse(localStorage.karma);var n=this;return{get:t,set:a,exists:e}};Karma.LocalStorage=new t}(),function(){"use strict";var t={},e={input:$("#chat_input"),messages:$("#chat_msgs"),label:$("#chat_input_label"),input_wrapper:$("#chat_input_wrapper")};t.sendMsg=function(){if(""!==e.input.val().trim()){var i=Karma.LocalStorage.get("playerName")+": "+$("#chat_input").val();Karma.gameInstance.socketManager.emit("chat",i)}e.input.val(""),t.hideChat()},t.onChatMsgReceived=function(t,i){e.messages.append('<li id="'+i+'">'+t+"</li>"),setTimeout(function(){$("li#"+i).fadeOut(500,function(){$("li#"+i).remove()})},2e4)},t.showChat=function(){e.label.html(Karma.LocalStorage.get("playerName")+" :"),e.input_wrapper.show(),e.input.focus(),e.input_wrapper.addClass("enable")},t.hideChat=function(){e.input.blur(),e.input_wrapper.hide(),e.input_wrapper.removeClass("enable")},t.clearChatInputField=function(){e.input.val("")},Karma.Chat=t}(),function(){"use strict";function t(t,e,i,a,n){this.canvas=t,this.canvasID=e,this.timer=(new Date).getTime(),this.frames=0,this.debugDraw=!1,this.carFlameTicks={},this.items=i,this.worldInfo=a,this.setGScale(32),this.$canvas=$(t),this.init(),this.loaded(),this.loadImages(n)}t.prototype.setGScale=function(t){this.gScaleValue=t,this.gScaleDynamicsRequired=!0,this.gScaleList(this.worldInfo.staticItems),this.gScale(this.worldInfo.size)},t.prototype.loadImages=function(t){function e(){return n===a-1&&KLib.isFunction(t)?t():(n+=1,void 0)}var i=this,a=Object.keys(this.worldInfo.itemsInMap).length+1,n=0;i.createBGPattern(e);var s=function(){if("none"!==this.patternType){var t=i.ctx.createPattern(c,"repeat");i.worldInfo.itemsInMap[this.name].pattern=t}else i.worldInfo.itemsInMap[this.name].pattern=null,i.worldInfo.itemsInMap[this.name].img=c;e()};for(var o in this.worldInfo.itemsInMap){var r=this.worldInfo.itemsInMap[o],c=new Image;c.src=r.image.path,c.onload=s.bind(r)}},t.prototype.createBGPattern=function(t){var e=this,i=new Image;i.src=e.worldInfo.background.path,i.onload=function(){var i=e.ctx.createPattern(this,"repeat");return e.backgroundPattern=i,t()}},t.prototype.gScaleList=function(t){for(var e=t.length-1;e>=0;e--)this.gScale(t[e])},t.prototype.gScaleIfRequired=function(){this.gScaleDynamicsRequired===!0&&(this.gScaleList(this.items.cars),this.gScale(this.items.mycar),this.gScaleDynamicsRequired=!1)},t.prototype.gScale=function(t){null!==t&&(t.x&&(t.x*=this.gScaleValue),t.y&&(t.y*=this.gScaleValue),t.w&&(t.w*=this.gScaleValue),t.h&&(t.h*=this.gScaleValue))},t.prototype.init=function(){this.ctx=this.canvas.getContext("2d"),this.canvas.width=$("#"+this.canvasID).width(),this.canvas.height=$("#"+this.canvasID).height(),this.camera=new Karma.Camera(this.ctx,"#"+this.canvasID),this.camera.setWorldSize(this.worldInfo.size),this.loadCars(),this.explosionImage=new Image,this.explosionImage.src="/sprites/explosion.png",this.rocketImage=new Image,this.rocketImage.src="/sprites/rocket.png",this.gunFlameImage=new Image,this.gunFlameImage.src="/sprites/gun_flame.png"},t.prototype.loaded=function(){$("#loadingtext").html("")},t.prototype.resize=function(){var t={w:this.$canvas.width(),h:this.$canvas.height()};KLib.isUndefined(this.canvasSize)||(t=this.canvasSize),this.camera.ctx.canvas.width=t.w,this.camera.ctx.canvas.height=t.h},t.prototype.draw=function(){if(this.worldInfo.staticItems.length>0){this.resize();var t=this.oldCenter;null!==this.items.mycar&&(t=this.items.mycar,this.camera.update(t)),t&&t!=this.oldCenter&&(this.oldCenter=t),this.drawItems()}},t.prototype.drawLifeBar=function(t,e){t.save(),t.translate(-e.w/2,-40);var i=e.w;t.fillStyle="#0F0",t.fillRect(0,0,i,5),t.fillStyle="#F00";var a=i*(e.life/e.maxLife);t.fillRect(a,0,i-a,5),t.restore()};var e=12;t.prototype.drawSingleGunFlame=function(t,i,a,n){var s=1.5;t.rotate(a);var o=i.w/2,r=i.h/2;i.flame>e/2?t.drawImage(this.gunFlameImage,0,0,135,125,n,-r/2,o,r):t.drawImage(this.gunFlameImage,0,0,135,125,n,-r/2/s,o/s,r/s),t.rotate(-a)},t.prototype.drawGunFlame=function(t,i){switch(KLib.isUndefined(this.carFlameTicks[i.id])&&(this.carFlameTicks[i.id]=0),i.flame=this.carFlameTicks[i.id],i.shootingWithWeapon){case"90 angle machine gun":this.drawSingleGunFlame(t,i,0,i.w/2),this.drawSingleGunFlame(t,i,Math.PI/2,i.w/4),this.drawSingleGunFlame(t,i,-Math.PI/2,i.w/4);break;case"super machine gun":this.drawSingleGunFlame(t,i,0,i.w/2),this.drawSingleGunFlame(t,i,Math.PI/4,i.w/4),this.drawSingleGunFlame(t,i,-Math.PI/4,i.w/4);break;case"machine gun":this.drawSingleGunFlame(t,i,0,i.w/2);break;default:this.drawSingleGunFlame(t,i,0,i.w/2)}this.carFlameTicks[i.id]=(this.carFlameTicks[i.id]+1)%e};var i=56,a=51;t.prototype.drawExplosions=function(t){if(null!==this.items.explosions){t.fillStyle="#FFFFFF";for(var e in this.items.explosions){var n=this.items.explosions[e];t.save(),t.translate(n.x,n.y),t.rotate(n.r);var s=a,o=i;t.globalAlpha=n.alpha,t.drawImage(this.explosionImage,0,0,o,s,-s/2,-s/2,o,s),t.restore()}}},t.prototype.drawProjectiles=function(t){if(null!==this.items.projectiles)for(var e=0;this.items.projectiles.length>e;e++){var i=this.items.projectiles[e];switch(i.name){case"rocket launcher":this.drawRocket(i,t);break;default:this.drawBullet(i,t)}}},t.prototype.drawBullet=function(t,e){e.fillStyle="#0F0";var i=t;e.save(),e.beginPath();var a=i;e.translate(a.x,a.y),e.moveTo(0,0),e.rotate(a.r),e.lineTo(320,0),e.closePath(),e.restore()},t.prototype.drawRocket=function(t,e){e.fillStyle="#FFFFFF";var i=t;e.save(),e.translate(i.x,i.y),e.rotate(i.r),e.drawImage(this.rocketImage,-i.w/2,-i.h/2,40,16),e.restore()},t.prototype.drawOutsideWalls=function(t){var e=this.gScaleValue,i=this.camera.realWorldSize;t.fillStyle=this.debugDraw?"#00FF00":this.worldInfo.itemsInMap.outsideWall.pattern,t.fillRect(-e,i.h,i.w+2*e,e),t.fillRect(-e,-e,i.w+2*e,e),t.fillRect(-e,0,e,i.h),t.fillRect(i.w,0,e,i.h)},t.prototype.drawStaticItems=function(t){var e=this;null!==e.worldInfo.staticItems&&_.each(e.worldInfo.staticItems,function(i){var a=e.worldInfo.itemsInMap[i.name];KLib.isUndefined(a)||KLib.isUndefined(a.pattern)||(null===a.pattern?t.drawImage(a.img,i.x-i.w/2,i.y-i.h/2,i.w,i.h):(t.fillStyle=a.pattern,t.fillRect(i.x-i.w/2,i.y-i.h/2,i.w,i.h)))})},t.prototype.drawBackground=function(t){KLib.isUndefined(this.backgroundPattern)||(t.fillStyle=this.backgroundPattern,t.fillRect(0,0,this.camera.realWorldSize.w,this.camera.realWorldSize.h))},t.prototype.drawItems=function(){this.drawBackground(this.ctx),this.drawBodies(this.ctx),this.drawOutsideWalls(this.ctx),this.drawStaticItems(this.ctx),this.drawCars(this.ctx),this.drawExplosions(this.ctx),this.drawProjectiles(this.ctx)},t.prototype.tick=function(){requestAnimFrame(this.tick.bind(this)),this.gScaleIfRequired(),this.draw(),this.frames++;var t=(new Date).getTime();t-this.timer>1e3&&(this.timer=t,$("#fps").html("fps: "+this.frames),this.frames=0)},Karma.Engine2DCanvas=t}(),function(){"use strict";function t(t,e){this.ctx=t,this.translate={x:0,y:0},this.center={x:0,y:0},this.scale=1.2,this.realWorldSize={w:0,h:0},this.canvasSelector=e}t.prototype.setWorldSize=function(t){this.realWorldSize=t;var e=this.getCanvasSize();this.scaledSized={w:e.w*this.scale,h:e.h*this.scale},this.scaleLimits={min:.1,max:5}},t.prototype.updateScale=function(){},t.prototype.getCanvasSize=function(){return{w:this.ctx.canvas.width,h:this.ctx.canvas.height}},t.prototype.resizeCanvas=function(t){null!==this.ctx&&(this.ctx.canvas.width=t.w,this.ctx.canvas.height=t.h,$(this.canvasSelector).width(t.w),$(this.canvasSelector).height(t.h))},t.prototype.getScreenRatio=function(){var t=this.getCanvasSize(),e=t.w/this.realWorldSize.w,i=t.h/this.realWorldSize.h;return i>e?e:i},t.prototype.drawDebug=function(){var t=this.getCanvasSize(),e=[];e.push("<ul>"),e.push("<li>","Canvas Size : ",t.w,", ",t.h,"</li>"),e.push("<li>","Translate X : ",this.translate.x,"</li>"),e.push("<li>","Translate Y : ",this.translate.y,"</li>"),e.push("<li>","Scale : ",this.scale,"</li>"),e.push("<li>","Scaled Size : ",this.scaledSized.w,", ",this.scaledSized.h,"</li>"),e.push("<li>","myCar Pos : ",this.center.x,", ",this.center.y,", rÂ°:",this.center.r,"</li>"),e.push("<li>","Orientation : ",window.orientation,"</li>"),null!==window.orientation,e.push("</ul>"),$("#camera-debug").html(e.join(""))},t.prototype.update=function(t){t!==void 0&&(this.center=t),this.updateScale();var e=this.getCanvasSize();this.scaledSized={w:e.w/this.scale,h:e.h/this.scale},this.translate.x=this.scaledSized.w/2-this.center.x,this.translate.y=this.scaledSized.h/2-this.center.y,this.ctx.scale(this.scale,this.scale),this.ctx.translate(this.translate.x,this.translate.y)},Karma.Camera=t}(),function(t){"use strict";function e(t,e,i){t.save(),t.beginPath(),t.fillStyle=i||"#FF0000",t.arc(e.x,e.y,10,0,2*Math.PI,!1),t.fill(),t.closePath(),t.fillStyle=i||"#00FF00",e.name&&t.fillText(e.name,e.x,e.y),t.restore()}function i(t,e){t.strokeStyle="#000000",t.beginPath(),t.moveTo(-e.x*a,-e.y*a),t.lineTo(e.x*a,e.y*a),t.closePath(),t.stroke()}var a=192;t.prototype.drawBodies=function(t){var a,n;if(this.debugDraw&&null!==this.bodies){for(n=0;this.bodies.length>n;n++){a=this.bodies[n],t.save(),t.fillStyle=a.color,t.translate(a.x,a.y),t.beginPath(),t.moveTo(a.ul.x,a.ul.y),t.lineTo(a.ur.x,a.ur.y),t.lineTo(a.br.x,a.br.y),t.lineTo(a.bl.x,a.bl.y),t.closePath(),t.fill(),t.restore(),t.save();var s=t.measureText(a.playerName),o=25;t.translate(a.x,a.y),t.fillText(a.playerName,-s.width/2,-o),t.restore()}for(n=0;this.bodies.length>n;n++){a=this.bodies[n],t.save(),t.translate(a.x,a.y);var r=!1;if(r&&!_.isUndefined(a.collision))for(i(t,a.collision.a1),i(t,a.collision.a2),i(t,a.collision.a3),i(t,a.collision.a4),n=1;4>=n;++n)e(t,a.collision.axesMinMax[n].minA,"#000"),e(t,a.collision.axesMinMax[n].maxA,"#F00"),e(t,a.collision.axesMinMax[n].minB,"#0F0"),e(t,a.collision.axesMinMax[n].maxB,"#00F");t.restore()}}},t.prototype.drawCollisionPoints=function(){if(this.items.collisionPoints){var t=this.ctx;for(var i in this.items.collisionPoints){var a=this.items.collisionPoints[i];e(t,a,"#F00")}}}}(Karma.Engine2DCanvas),function(t){"use strict";t.prototype.loadCars=function(){var t=this,e=function(t,e,i,a){var n={name:t,path:"/sprites/"+e,w:i,h:a};return n.image=new Image,n.image.src=n.path,n},i=function(e){t.carsImages[e.name]=e};this.carsImages={},i(e("c1","car.png",128,64)),i(e("c2","car2.png",82,36)),i(e("c3","car3.png",72,32)),i(e("c4","car4.png",74,34)),i(e("c5","car5.png",81,35))},t.prototype.drawCars=function(t){if(null!==this.items.cars)for(var e=0;this.items.cars.length>e;e++){var i=this.items.cars[e];t.save(),t.translate(i.x,i.y),t.rotate(i.r);var a=this.carsImages[i.carImageName];t.drawImage(a.image,0,0,a.w,a.h,-i.w/2,-i.h/2,i.w,i.h),i.shootingWithWeapon&&this.drawGunFlame(t,i),t.restore();var n=t.measureText(i.playerName),s=25;t.save(),t.translate(i.x,i.y),t.font="10px Trebuchet MS",t.fillStyle="white",t.fillText(i.playerName,-n.width/2,-s),this.drawLifeBar(t,i),t.restore(),this.drawBullet(i,t)}}}(Karma.Engine2DCanvas),function(){"use strict";function t(t,e,i,a,n){var s=document.getElementById(t),o=e,r=function(t,e,s){switch(t){case"CANVAS":return new Karma.Engine2DCanvas(s,e,i,a,n)}};return o="CANVAS",r(o,t,s)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),Karma.getDrawEngine=t}(),function(){"use strict";function t(){FB.getLoginStatus(function(t){"connected"===t.status?a(t):"not_authorized"===t.status?s():s()})}function e(){FB.getLoginStatus(function(t){"not_logged_in"===t.status&&s(),"connected"===t.status&&a()})}function i(t){try{FB.api("/"+t.id+"/scores/"+l.conf.appName,function(t){if(!t||t.error)Karma.Log.error(t);else{var e=0;t.data.length>0&&(e=t.data[0].score),$("#fbHighScore").html('<div title="High Score">High Score : '+e+"</div>"),Karma.TopBar.show()}})}catch(e){Karma.Log.error(e)}}function a(){c()}function n(){FB.Event.subscribe("auth.login",function(){a()}),e(),$("#fb-login").on("click",function(){t(),$(this).off("click")})}function s(){FB.login(function(t){t.authResponse&&a()},{scope:"publish_actions"})}function o(){window.fbAsyncInit=function(){var t="http://"+l.host+"/channel.html",e={appId:l.conf.appID,channelUrl:t,status:!0,cookie:!0,xfbml:!0};FB.init(e),n()},function(t){var e,i="facebook-jssdk",a=t.getElementsByTagName("script")[0];t.getElementById(i)||(e=t.createElement("script"),e.id=i,e.async=!0,e.src="//connect.facebook.net/en_US/all.js",a.parentNode.insertBefore(e,a))}(document)}function r(t,e){FB.api("/me/picture?width=180&height=180",function(i){return t.html('<img class="fb-picture" src="'+i.data.url+'">'),e(null,i)})}function c(){FB.api("/me",function(t){r($("#fbLoginImage"),function(){});var e=Karma.LocalStorage.exists("playerName"),a=Karma.LocalStorage.get("playerName");e&&""!==a?$("#playerName").val(a):(Karma.LocalStorage.set("playerName",t.name),$("#playerName").val(t.name)),i(t)})}var l={};l.host=function(){var t=window.location.hostname+":"+window.location.port;return t}(),l.conf=function(){var t={appID:"156724717828757",appName:"karmaracer_dev"},e={appID:"512708015460560",appName:"karmaracer"};return-1!==l.host.indexOf("localhost")?t:e}(),l.setup=o,l.getLoginStatus=t,l.afterLogin=a,l.setup(),Karma.FB=l}(),function(){"use strict";function t(t){console&&console.error(t)}function e(t){console&&console.info(t)}Karma.Log={error:t,info:e}}(),function(){"use strict";var t=function(t,e,i){this.$container=t,this.connection=i,this.canvasID="minimap-"+e,this.$canvas=$('<canvas id="'+this.canvasID+'" class="miniMap"></canvas>'),this.$container.append(this.$canvas),this.canvas=this.$canvas[0],this.getMap(e,function(){})};t.prototype.getMap=function(t,e){var i=this,a=function(t,a){var n={cars:[],mycar:null,projectiles:[],explosions:[]};return i.drawEngine=Karma.getDrawEngine(i.canvasID,"CANVAS",n,a,function(){i.drawEngine.setGScale(1/6),i.drawEngine.canvasSize=i.drawEngine.worldInfo.size,i.drawEngine.resize(),i.drawEngine.tick()}),KLib.isFunction(e)?e(null):void 0};this.connection.emit("getMiniMap",{name:t},a)},Karma.MiniMap=t}(),function(){"use strict";function t(){var t=document.URL,e=t.split("/"),i=e[e.length-1];return-1!==i.indexOf("#")&&(i=i.split("#")[0]),i}function e(){var e=[];e.push('<div id="topBar" class="init"><ul id="topBarBoxes">');var i=t();""!==i&&e.push('<li id="topHelp"><a href="/"><img src="/images/iconHome.png" id="iconHome"/></a></li>'),e.push('<li><form id="playerNameForm" href="#">'),e.push('Welcome to Karma Racer, <input title="change your name here" id="playerName" type="text" placeholder="Your name" required="required" name="playerName" autocomplete="off"></input>'),e.push('<input type="submit" style="display:none"/>'),e.push("</form></li>"),e.push('<li id="fbHighScore"/>'),e.push('<li id="topHelp"><img src="/images/iconHelp.png" id="iconHelp" title="Home"/>'),e.push('<div id="keys"></div>'),e.push("</li>"),e.push('<li id="fbLoginImage"/>'),e.push("</ul>");var n=$(e.join(""));n.hide(),$("body").append(n);var s=$("#keys");$("#iconHelp").hover(function(){s.show()},function(){s.hide()}),$("#keys").html(a());var o=$("#playerName");o.keyup(function(){Karma.LocalStorage.set("playerName",o.val())}),n.children().hide()}function i(t,e){return{key:t,text:e}}function a(){var t=[];t.push(i("&#8593;&nbsp;&#8595;","accelerate / go backward")),t.push(i("&#8592;&nbsp;&#8594;","turn left / right")),t.push(i("&#60;space&#62;","shoot")),t.push(i("L/P","zoom / unzoom")),t.push(i("B","break")),t.push(i("Mouse Click","drive"));for(var e=[],a=0;t.length>a;a++){var n=t[a];e.push('<td class="help_keys">'+n.key+'</td><td class="help_keys_text">'+n.text+"</td>")}var s="<table><tr>"+e.join("</tr><tr>")+"</tr></table>";return s}function n(){var t=$("#topBar");t.slideDown(function(){t.children().fadeIn()}),setTimeout(function(){t.removeClass("init")},2500)}Karma.TopBar={setTopBar:e,show:n}}(),function(){"use strict";Modernizr.load([{complete:function(){Modernizr.load([{test:$("html.touch").length,yep:["/dist/mobile.js","/dist/mobile.css"],nope:["src/mobile/no-touch.css"],complete:function(){if(Karma.gameInstance=new Karma.GameInstance,"function"==typeof Karma.MobileTerminalHandler){var t=new Karma.MobileTerminalHandler(Karma.gameInstance);t.init()}new Karma.SteeringWheelController(Karma.gameInstance)}}])}}])}(),function(t){"use strict";function e(e,i){function a(){var t=(new Date).getTime();t-r.timestamp>1e3&&(r.timestamp=t,$("#socketps").html("socket/ps: "+r.socketCounter),r.socketCounter=0),r.socketCounter+=1}function n(t,e,i){KLib.isUndefined(i)&&(i=""),$("#announce").remove();var a=$('<div id="announce" class=" '+i+" announce-"+e+'"><span>'+t+"</span></div>");a.appendTo($("body")),setTimeout(function(){$("#announce").fadeOut(function(){$("#announce").remove()})},4e3)}function s(t,e,i,a,s){setTimeout(function(){return n(t,e,a),KLib.isFunction(s)?s(null):void 0},1e3*i)}var o=window.location.hostname;this.connection=t.connect(o),this.gameInstance=e,this.init_done=!1,this.socketCounter=0,this.timestamp=(new Date).getTime(),this.msg_id=0,this.gameInstance.bodies=[];var r=this;$(window).on("beforeunload",function(){r.connection.emit("disconnect")}),$(function(){$("#addBot").click(function(){r.connection.emit("add bot")}),$("#removeBot").click(function(){r.connection.emit("remove bot")})}),$("#debug").append('<div id="socketps" class="info"></div>'),$("#debug").append('<div id="debug-sockets" class="info">sockets</div>'),r.connection.on("connect",function(){_.isUndefined(G_mapName)||(r.connection.emit("enter_map",G_mapName),n("Shoot them all !","blue"))}),this.connection.on("init",function(t){i(null,t),Karma.LocalStorage.get("playerName")&&0!==Karma.LocalStorage.get("playerName").length||Karma.LocalStorage.set("playerName",prompt("Welcome to Karmaracer !\nWhat's your name ?")),r.connection.emit("init_done",{playerName:Karma.LocalStorage.get("playerName")}),this.init_done=!0}),this.connection.on("chat_msg",function(t){var e="msg_"+r.msg_id;Karma.Chat.onChatMsgReceived(t,e),++r.msg_id}),this.connection.on("dead",function(){n("You' re dead !","red")}),this.connection.on("game end",function(t){$("table.scores").addClass("big").removeClass("default");var e=function(){$("table.scores").removeClass("big").addClass("default")};n(t.winnerName+" wins the game !!!!","black","freeze"),s("2","red",3,"freeze"),s("1","orange",4,"freeze",e),s("GO","green",5,"")}),r.connection.on("objects",function(t){e.items.cars=t.cars,e.items.mycar=t.myCar,e.items.projectiles=t.projectiles,e.items.collisionPoints=t.collisionPoints,e.updateScoresHTML(),e.drawEngine.gScaleDynamicsRequired=!0,$("#debug-sockets").html(JSON.stringify(_.map(t,function(t){return t?t.length:0}))),a()}),r.connection.on("explosion",function(t){e.addExplosion(t)})}e.prototype.getConnection=function(){return this.connection},e.prototype.emit=function(t,e){this.connection.emit(t,e)},Karma.SocketManager=e}(io),function(){"use strict";var t=function(){};t.prototype.init=function(t){function e(t){if(null===t)return 0;var e={x:0,y:0},i=Math.atan2(t.y,t.x)-Math.atan2(e.y,e.x);return _.isNaN(i)&&(i=0),i}this.m=$('<div id="SteeringWheelController"/>'),this.acc=$('<div id="SteeringWheelControllerAcc"/>'),this.m.append(this.acc),this.enable=!1,$("body").append(this.m),this.gameInstance=t,this.gameInstance.steeringWheel=this,this.resize(),this.accSize={w:this.acc.width(),h:this.acc.height()},this.force={x:0,y:0},this.updateCenter();var i=this,a=function(){var t=$(this);t.toggleClass("enable"),i.enable=t.hasClass("enable")};i.m.click(a),$(window).resize(function(){i.resize()}),window.onorientationchange=function(){i.resize()},window.webkitfullscreenchange=function(){};var n=null,s=function(){i.enable&&i.gameInstance.socketManager.emit("move_car",{force:i.force,angle:e(i.force)})},o=function(){null===n&&(n=setInterval(s,62.5))},r=function(){clearInterval(n),n=null},c=function(t){var e={x:t.pageX,y:t.pageY};i.gameInstance.isMobile&&(e.x=t.originalEvent.touches[0].pageX,e.y=t.originalEvent.touches[0].pageY);var a=e.x-i.mCenter.x,n=e.y-i.mCenter.y;i.acc.css("left",e.x-i.m.position().left-i.accSize.w/2),i.acc.css("top",e.y-i.m.position().top-i.accSize.h/2);var s={x:a/(i.mSize.w/2),y:n/(i.mSize.h/2)},o=10;i.gameInstance.isMobile&&(o=5),s.x*=o,s.y*=o,i.force=s};i.gameInstance.isMobile?(i.m.bind("touchstart",o),i.m.bind("touchend",r),i.m.bind("touchmove",c),i.enable=!0):(i.m.mousemove(c),i.m.hover(o,r)),i.acc.mousemove(function(t){return t.preventDefault(),!1})},t.prototype.setMSize=function(t,e){var i=this;i.m.css("width",t+"px"),i.m.css("height",e+"px"),i.mSize={w:i.m.width(),h:i.m.height()},i.updateCenter()},t.prototype.updateCenter=function(){var t=this;t.mSize={w:t.m.width(),h:t.m.height()},t.mCenter={x:t.mSize.w/2+t.m.position().left,y:t.mSize.h/2+t.m.position().top}},t.prototype.setMPosition=function(t,e){var i=this,a=t-i.mSize.w/2,n=e-i.mSize.h/2;i.m.css("left",a+"px"),i.m.css("top",n+"px"),i.updateCenter()},t.prototype.resize=function(){this.m.css({width:"100%",height:"100%"})},Karma.SteeringWheelController=t}(),function(){"use strict";function t(t){return this.gameInstance=t,this}var e=13,i=32,a=37,n=39,s=38,o=40,r=27,c=76,l=80,h=66;t.prototype.sendKeyboardEvent=function(t,e){this.gameInstance.socketManager.getConnection()&&this.gameInstance.socketManager.getConnection().emit("drive",t,e)},t.prototype.handleKey=function(t,e){switch(t){case h:this.sendKeyboardEvent("break",e);break;case i:this.sendKeyboardEvent("shoot",e);break;case a:this.sendKeyboardEvent("left",e);break;case n:this.sendKeyboardEvent("right",e);break;case s:this.sendKeyboardEvent("forward",e);break;case o:this.sendKeyboardEvent("backward",e);break;case c:"start"==e&&(this.gameInstance.drawEngine.camera.scale*=1.05);break;case l:"start"==e&&(this.gameInstance.drawEngine.camera.scale*=.95);break;default:}},t.prototype.handleKeyDown=function(t){switch(t.keyCode){case r:Karma.Chat.clearChatInputField(),Karma.Chat.hideChat();break;case s:case o:$("#chat_input").is(":focus")&&Karma.Chat.hideChat(),this.handleKey(t.keyCode,"start");break;case e:$("#chat_input").is(":focus")?Karma.Chat.sendMsg():Karma.Chat.showChat();break;case c:case l:case i:$("#chat_input").is(":focus")||this.handleKey(t.keyCode,"start");break;default:this.handleKey(t.keyCode,"start")}},t.prototype.handleKeyUp=function(t){this.handleKey(t.keyCode,"end")},Karma.KeyboardHandler=t}(),function(){"use strict";function t(){function t(){for(var t in e.items.explosions)e.items.explosions[t].alpha-=.1,0>e.items.explosions[t].alpha&&delete e.items.explosions[t]}Karma.TopBar.setTopBar(),this.items={},this.items.cars=[],this.items.explosions={},this.items.mycar=null,this.items.projectiles=[],this.worldInfo={},this.drawEngine=null,this.socketManager=new Karma.SocketManager(this,this.onInitReceived.bind(this)),this.setUIEvents(),this.isMobile=!1,this.scoresTable=$("tbody#scores");var e=this;setInterval(t,60)}t.prototype.updateScoresHTML=function(){function t(){var t=_.map(e.items.cars,function(t){return{score:t.s,level:t.l,name:t.playerName,highScore:t.highScore,id:t.id}});return t=_.sortBy(t,function(t){return t.score}).reverse()}for(var e=this,i=t(),a=[],n=0;i.length>n;n++){var s=i[n],o=null!==e.items.mycar&&e.items.mycar.id===s.id?"userCar":"";a.push('<tr class="',o,'"><td>',s.name,"</td><td>",s.score,"</td><td>",s.level,"</td><td>",s.highScore,"</td></tr>")}this.scoresTable.html(a.join(""))},t.prototype.updatePlayerName=function(t){this.socketManager.emit("updatePlayerName",t),Karma.LocalStorage.set("playerName",t)},t.prototype.setUIEvents=function(){var t=this;$("#playerName").keyup(function(){t.updatePlayerName($(this).val())})},t.prototype.onInitReceived=function(t,e){var i=this;this.worldInfo=e,this.bullets=[],this.rockets=[];var a="CANVAS",n=function(){i.keyboardHandler=new Karma.KeyboardHandler(i),document.onkeydown=i.keyboardHandler.handleKeyDown.bind(i.keyboardHandler),document.onkeyup=i.keyboardHandler.handleKeyUp.bind(i.keyboardHandler),i.drawEngine.tick()};i.drawEngine=Karma.getDrawEngine("game-canvas",a,i.items,i.worldInfo,n)},t.prototype.addExplosion=function(t){var e=Math.random();this.items.explosions[e]={x:t.x,y:t.y,r:3.14/6*Math.random()-3.14,alpha:.4*Math.random()-.2+.25}},Karma.GameInstance=t}(),function(){"use strict";Karma.GameInstance.prototype.setupSound=function(){},Karma.GameInstance.prototype.setSound=function(t,e){var i;this.play_html5_audio?(i=new Audio(e),i.load()):(i=$("<embed id='"+t+"' type='audio/mpeg' />"),i.attr("src",e),i.attr("loop",!1),i.attr("hidden",!0),i.attr("autostart",!1),i.attr("enablejavascript",!0),$("body").append(i)),this.sounds[t]=i},Karma.GameInstance.prototype.play_sound=function(t){if(this.play_html5_audio){var e=new Audio(t);e.load(),e.play()}else{$("#sound").remove();var i=$("<embed type='audio/mpeg' />");i.attr("src",t),i.attr("loop",!1),i.attr("hidden",!0),i.attr("autostart",!0),$("body").append(i)}}}();