/*! karmaracer 2013-05-09 */
var Karma=Karma||{},KLib=KLib||{};(function(){"use strict";KLib.isFunction=function(t){return"function"==typeof t},KLib.isUndefined=function(t){return void 0===t},KLib.extend=function(t,e){function a(t,e){function a(){return t.apply(this,e)}return a.prototype=t.prototype,new a}var i=a(t,Array.prototype.slice.call(arguments,2));e.base={};for(var s in i)if(KLib.isUndefined(e[s])){var n=i[s];e[s]=n}else e.base[s]=t.prototype[s]}})(),function(){"use strict";var t=function(){function t(t){return s.karma[t]}function e(e){var a=t(e);return void 0===a?!1:!0}function a(){localStorage.karma=JSON.stringify(s.karma)}function i(t,e){s.karma[t]=e,a()}this.karma=_.isUndefined(localStorage.karma)?{}:JSON.parse(localStorage.karma);var s=this;return{get:t,set:i,exists:e}};Karma.LocalStorage=new t}(),function(){"use strict";var t={},e={input:$("#chat_input"),messages:$("#chat_msgs"),label:$("#chat_input_label"),input_wrapper:$("#chat_input_wrapper")};t.sendMsg=function(){if(""!==e.input.val().trim()){var a=Karma.LocalStorage.get("playerName")+": "+$("#chat_input").val();Karma.gameInstance.socketManager.emit("chat",a)}e.input.val(""),t.hideChat()},t.onChatMsgReceived=function(t,a){e.messages.append('<li id="'+a+'">'+t+"</li>"),setTimeout(function(){$("li#"+a).fadeOut(500,function(){$("li#"+a).remove()})},2e4)},t.showChat=function(){e.label.html(Karma.LocalStorage.get("playerName")+" :"),e.input_wrapper.show(),e.input.focus(),e.input_wrapper.addClass("enable")},t.hideChat=function(){e.input.blur(),e.input_wrapper.hide(),e.input_wrapper.removeClass("enable")},t.clearChatInputField=function(){e.input.val("")},Karma.Chat=t}(),function(){"use strict";function t(t,e,a){return this.canvas=e,this.canvasID=a,this.gameInstance=t,this.init(),this.loaded(),this.timer=(new Date).getTime(),this.frames=0,this.debugDraw=!1,this.carFlameTicks={},this}function e(t,e){t.strokeStyle="#000000",t.beginPath(),t.moveTo(-e.x*i,-e.y*i),t.lineTo(e.x*i,e.y*i),t.closePath(),t.stroke()}function a(t,e,a){t.save(),t.beginPath(),t.fillStyle=a||"#FF0000",t.arc(e.x,e.y,10,0,2*Math.PI,!1),t.fill(),t.closePath(),t.fillStyle=a||"#00FF00",e.name&&t.fillText(e.name,e.x,e.y),t.restore()}var i=192;t.prototype.initBackgroundCanvas=function(){this.backgroundCanvas=document.createElement("canvas");var t=this.camera.realWorldSize,e=1;this.backgroundCanvas.width=t.w*e,this.backgroundCanvas.height=t.h*e,this.backgroundContext=this.backgroundCanvas.getContext("2d"),this.backgroundContext.save(),this.drawBackground(this.backgroundContext),this.drawOutsideWalls(this.backgroundContext),this.drawStaticItems(this.backgroundContext),this.backgroundContext.restore()},t.prototype.init=function(){this.ctx=this.canvas.getContext("2d"),this.canvas.width=$("#"+this.canvasID).width(),this.canvas.height=$("#"+this.canvasID).height(),this.camera=new Karma.Camera(this.ctx,"#"+this.canvasID),this.camera.setWorldSize(this.gameInstance.world.size),this.loadCarsImages(),this.explosionImage=new Image,this.explosionImage.src="/sprites/explosion.png",this.rocketImage=new Image,this.rocketImage.src="/sprites/rocket.png",this.gunFlameImage=new Image,this.gunFlameImage.src="/sprites/gun_flame.png"},t.prototype.loadCarsImages=function(){this.carImages={};for(var t in this.gameInstance.carsImages){var e=this.gameInstance.carsImages[t],a=new Image;a.src=e.path,this.carImages[e.name]=a}},t.prototype.loaded=function(){$("#loadingtext").html("")},t.prototype.draw=function(){if(this.gameInstance.walls.length>0){this.camera.ctx.canvas.width=$("#"+this.canvasID).width(),this.camera.ctx.canvas.height=$("#"+this.canvasID).height();var t=this.gameInstance.mycar||this.oldCenter;this.camera.update(t),t&&t!=this.oldCenter&&(this.oldCenter=t),this.drawItems()}},t.prototype.drawBodies=function(t){var i,s;if(this.debugDraw&&null!==this.gameInstance.bodies){for(s=0;this.gameInstance.bodies.length>s;s++){i=this.gameInstance.bodies[s],t.save(),t.fillStyle=i.color,t.translate(i.x,i.y),t.beginPath(),t.moveTo(i.ul.x,i.ul.y),t.lineTo(i.ur.x,i.ur.y),t.lineTo(i.br.x,i.br.y),t.lineTo(i.bl.x,i.bl.y),t.closePath(),t.fill(),t.restore(),t.save();var n=t.measureText(i.playerName),o=25;t.translate(i.x,i.y),t.fillText(i.playerName,-n.width/2,-o),t.restore()}for(s=0;this.gameInstance.bodies.length>s;s++){i=this.gameInstance.bodies[s],t.save(),t.translate(i.x,i.y);var r=!1;if(r&&!_.isUndefined(i.collision))for(e(t,i.collision.a1),e(t,i.collision.a2),e(t,i.collision.a3),e(t,i.collision.a4),s=1;4>=s;++s)a(t,i.collision.axesMinMax[s].minA,"#000"),a(t,i.collision.axesMinMax[s].maxA,"#F00"),a(t,i.collision.axesMinMax[s].minB,"#0F0"),a(t,i.collision.axesMinMax[s].maxB,"#00F");t.restore()}}},t.prototype.drawLifeBar=function(t,e){t.save(),t.translate(-e.w/2,-40);var a=e.w;t.fillStyle="#0F0",t.fillRect(0,0,a,5),t.fillStyle="#F00";var i=a*(e.life/e.maxLife);t.fillRect(i,0,a-i,5),t.restore()};var s=12;t.prototype.drawSingleGunFlame=function(t,e,a,i){var n=1.5;t.rotate(a);var o=e.w/2,r=e.h/2;e.flame>s/2?t.drawImage(this.gunFlameImage,0,0,135,125,i,-r/2,o,r):t.drawImage(this.gunFlameImage,0,0,135,125,i,-r/2/n,o/n,r/n),t.rotate(-a)},t.prototype.drawGunFlame=function(t,e){switch(KLib.isUndefined(this.carFlameTicks[e.id])&&(this.carFlameTicks[e.id]=0),e.flame=this.carFlameTicks[e.id],e.shootingWithWeapon){case"90 angle machine gun":this.drawSingleGunFlame(t,e,0,e.w/2),this.drawSingleGunFlame(t,e,Math.PI/2,e.w/4),this.drawSingleGunFlame(t,e,-Math.PI/2,e.w/4);break;case"super machine gun":this.drawSingleGunFlame(t,e,0,e.w/2),this.drawSingleGunFlame(t,e,Math.PI/4,e.w/4),this.drawSingleGunFlame(t,e,-Math.PI/4,e.w/4);break;case"machine gun":this.drawSingleGunFlame(t,e,0,e.w/2);break;default:this.drawSingleGunFlame(t,e,0,e.w/2)}this.carFlameTicks[e.id]=(this.carFlameTicks[e.id]+1)%s},t.prototype.drawCars=function(t){if(null!==this.gameInstance.cars)for(var e=0;this.gameInstance.cars.length>e;e++){var a=this.gameInstance.cars[e];t.save(),t.translate(a.x,a.y),t.rotate(a.r);var i=this.gameInstance.carsImages[a.carImageName];t.drawImage(this.carImages[i.name],0,0,i.w,i.h,-a.w/2,-a.h/2,a.w,a.h),a.shootingWithWeapon&&this.drawGunFlame(t,a),t.restore();var s=t.measureText(a.playerName),n=25;t.save(),t.translate(a.x,a.y),t.font="10px Trebuchet MS",t.fillStyle="white",t.fillText(a.playerName,-s.width/2,-n),this.drawLifeBar(t,a),t.restore(),this.drawBullet(a,t)}};var n=56,o=51;t.prototype.drawExplosions=function(t){if(null!==this.gameInstance.explosions){t.fillStyle="#FFFFFF";for(var e in this.gameInstance.explosions){var a=this.gameInstance.explosions[e];t.save(),t.translate(a.x,a.y),t.rotate(a.r);var i=o,s=n;t.globalAlpha=a.alpha,t.drawImage(this.explosionImage,0,0,s,i,-i/2,-i/2,s,i),t.restore()}}},t.prototype.drawProjectiles=function(t){if(null!==this.gameInstance.projectiles)for(var e=0;this.gameInstance.projectiles.length>e;e++){var a=this.gameInstance.projectiles[e];switch(a.name){case"rocket launcher":this.drawRocket(a,t);break;default:this.drawBullet(a,t)}}},t.prototype.drawCollisionPoints=function(){if(this.gameInstance.collisionPoints){var t=this.ctx;for(var e in this.gameInstance.collisionPoints){var i=this.gameInstance.collisionPoints[e];a(t,i,"#F00")}}},t.prototype.drawBullet=function(t,e){e.fillStyle="#0F0";var a=t;e.save(),e.beginPath();var i=a;e.translate(i.x,i.y),e.moveTo(0,0),e.rotate(i.r),e.lineTo(320,0),e.closePath(),e.restore()},t.prototype.drawRocket=function(t,e){e.fillStyle="#FFFFFF";var a=t;e.save(),e.translate(a.x,a.y),e.rotate(a.r),e.drawImage(this.rocketImage,-a.w/2,-a.h/2,40,16),e.restore()},t.prototype.drawOutsideWalls=function(t){var e=50,a=this.camera.realWorldSize;t.fillStyle=this.debugDraw?"#00FF00":this.gameInstance.itemsInMap.outsideWall.pattern,t.fillRect(-e,a.h,a.w+2*e,e),t.fillRect(-e,-e,a.w+2*e,e),t.fillRect(-e,0,e,a.h),t.fillRect(a.w,0,e,a.h)},t.prototype.drawStaticItems=function(t){var e=this;null!==e.gameInstance.walls&&_.each(e.gameInstance.walls,function(a){var i=e.gameInstance.itemsInMap[a.name];KLib.isUndefined(i)||KLib.isUndefined(i.pattern)||(null===i.pattern?t.drawImage(i.img,a.x-a.w/2,a.y-a.h/2,a.w,a.h):(t.fillStyle=i.pattern,t.fillRect(a.x-a.w/2,a.y-a.h/2,a.w,a.h)))})},t.prototype.drawBackground=function(t){KLib.isUndefined(this.gameInstance.backgroundPattern)||(t.fillStyle=this.gameInstance.backgroundPattern,t.fillRect(0,0,this.camera.realWorldSize.w,this.camera.realWorldSize.h))},t.prototype.drawItems=function(){this.drawBackground(this.ctx),this.drawBodies(this.ctx),this.drawOutsideWalls(this.ctx),this.drawStaticItems(this.ctx),this.drawCars(this.ctx),this.drawExplosions(this.ctx),this.drawProjectiles(this.ctx),this.drawCollisionPoints()},t.prototype.tick=function(){requestAnimFrame(this.tick.bind(this)),this.gameInstance.drawEngine.draw(),this.frames++;var t=(new Date).getTime();t-this.timer>1e3&&(this.timer=t,$("#fps").html("fps: "+this.frames),this.frames=0)},Karma.Engine2DCanvas=t}(),function(){"use strict";function t(t,e){this.ctx=t,this.translate={x:0,y:0},this.center={x:0,y:0},this.scale=1.2,this.realWorldSize={w:0,h:0},this.canvasSelector=e}t.prototype.setWorldSize=function(t){this.realWorldSize=t;var e=this.getCanvasSize();this.scaledSized={w:e.w*this.scale,h:e.h*this.scale},this.scaleLimits={min:.1,max:5}},t.prototype.updateScale=function(){},t.prototype.getCanvasSize=function(){return{w:this.ctx.canvas.width,h:this.ctx.canvas.height}},t.prototype.resizeCanvas=function(t){null!==this.ctx&&(this.ctx.canvas.width=t.w,this.ctx.canvas.height=t.h,$(this.canvasSelector).width(t.w),$(this.canvasSelector).height(t.h))},t.prototype.getScreenRatio=function(){var t=this.getCanvasSize(),e=t.w/this.realWorldSize.w,a=t.h/this.realWorldSize.h;return a>e?e:a},t.prototype.drawDebug=function(){var t=this.getCanvasSize(),e=[];e.push("<ul>"),e.push("<li>","Canvas Size : ",t.w,", ",t.h,"</li>"),e.push("<li>","Translate X : ",this.translate.x,"</li>"),e.push("<li>","Translate Y : ",this.translate.y,"</li>"),e.push("<li>","Scale : ",this.scale,"</li>"),e.push("<li>","Scaled Size : ",this.scaledSized.w,", ",this.scaledSized.h,"</li>"),e.push("<li>","myCar Pos : ",this.center.x,", ",this.center.y,", r°:",this.center.r,"</li>"),e.push("<li>","Orientation : ",window.orientation,"</li>"),null!==window.orientation,e.push("</ul>"),$("#camera-debug").html(e.join(""))},t.prototype.update=function(t){t!==void 0&&(this.center=t),this.updateScale();var e=this.getCanvasSize();this.scaledSized={w:e.w/this.scale,h:e.h/this.scale},this.translate.x=this.scaledSized.w/2-this.center.x,this.translate.y=this.scaledSized.h/2-this.center.y,this.ctx.scale(this.scale,this.scale),this.ctx.translate(this.translate.x,this.translate.y)},Karma.Camera=t}(),function(){"use strict";function t(t,e,a){var i,s=document.getElementById(e),n=a,o=function(t,e,a,i){switch(e){case"CANVAS":return new Karma.Engine2DCanvas(t,i,a)}};return n="CANVAS",o(t,n,e,s,i)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),Karma.getDrawEngine=t}(),function(){"use strict";function t(){FB.getLoginStatus(function(t){"connected"===t.status?i(t):"not_authorized"===t.status?n():n()})}function e(){FB.getLoginStatus(function(t){"not_logged_in"===t.status&&n(),"connected"===t.status&&i()})}function a(t){try{FB.api("/"+t.id+"/scores/"+h.conf.appName,function(t){if(!t||t.error)Karma.Log.error(t);else{var e=0;t.data.length>0&&(e=t.data[0].score),$("#fbHighScore").html('<div title="High Score">High Score : '+e+"</div>"),Karma.TopBar.show()}})}catch(e){Karma.Log.error(e)}}function i(){c()}function s(){FB.Event.subscribe("auth.login",function(){i()}),e(),$("#fb-login").on("click",function(){t(),$(this).off("click")})}function n(){FB.login(function(t){t.authResponse&&i()},{scope:"publish_actions"})}function o(){window.fbAsyncInit=function(){var t="http://"+h.host+"/channel.html",e={appId:h.conf.appID,channelUrl:t,status:!0,cookie:!0,xfbml:!0};FB.init(e),s()},function(t){var e,a="facebook-jssdk",i=t.getElementsByTagName("script")[0];t.getElementById(a)||(e=t.createElement("script"),e.id=a,e.async=!0,e.src="//connect.facebook.net/en_US/all.js",i.parentNode.insertBefore(e,i))}(document)}function r(t,e){FB.api("/me/picture?width=180&height=180",function(a){return t.html('<img class="fb-picture" src="'+a.data.url+'">'),e(null,a)})}function c(){FB.api("/me",function(t){r($("#fbLoginImage"),function(){});var e=Karma.LocalStorage.exists("playerName"),i=Karma.LocalStorage.get("playerName");e&&""!==i?$("#playerName").val(i):(Karma.LocalStorage.set("playerName",t.name),$("#playerName").val(t.name)),a(t)})}var h={};h.host=function(){var t=window.location.hostname+":"+window.location.port;return t}(),h.conf=function(){var t={appID:"156724717828757",appName:"karmaracer_dev"},e={appID:"512708015460560",appName:"karmaracer"};return-1!==h.host.indexOf("localhost")?t:e}(),h.setup=o,h.getLoginStatus=t,h.afterLogin=i,h.setup(),Karma.FB=h}(),function(){"use strict";function t(t){console&&console.error(t)}function e(t){console&&console.info(t)}Karma.Log={error:t,info:e}}(),function(){"use strict";var t=function(t){this.$container=t,this.$container.append('<canvas class="miniMap"></canvas>')};Karma.MiniMap=t}(),function(){"use strict";function t(){var t=document.URL,e=t.split("/"),a=e[e.length-1];return-1!==a.indexOf("#")&&(a=a.split("#")[0]),a}function e(){var e=[];e.push('<div id="topBar" class="init"><ul id="topBarBoxes">');var a=t();""!==a&&e.push('<li id="topHelp"><a href="/"><img src="/images/iconHome.png" id="iconHome"/></a></li>'),e.push('<li><form id="playerNameForm" href="#">'),e.push('Welcome to Karma Racer, <input title="change your name here" id="playerName" type="text" placeholder="Your name" required="required" name="playerName" autocomplete="off"></input>'),e.push('<input type="submit" style="display:none"/>'),e.push("</form></li>"),e.push('<li id="fbHighScore"/>'),e.push('<li id="topHelp"><img src="/images/iconHelp.png" id="iconHelp" title="Home"/>'),e.push('<div id="keys"></div>'),e.push("</li>"),e.push('<li id="fbLoginImage"/>'),e.push("</ul>");var s=$(e.join(""));s.hide(),$("body").append(s);var n=$("#keys");$("#iconHelp").hover(function(){n.show()},function(){n.hide()}),$("#keys").html(i());var o=$("#playerName");o.keyup(function(){Karma.LocalStorage.set("playerName",o.val())}),s.children().hide()}function a(t,e){return{key:t,text:e}}function i(){var t=[];t.push(a("&#8593;&nbsp;&#8595;","accelerate / go backward")),t.push(a("&#8592;&nbsp;&#8594;","turn left / right")),t.push(a("&#60;space&#62;","shoot")),t.push(a("L/P","zoom / unzoom")),t.push(a("B","break")),t.push(a("Mouse Click","drive"));for(var e=[],i=0;t.length>i;i++){var s=t[i];e.push('<td class="help_keys">'+s.key+'</td><td class="help_keys_text">'+s.text+"</td>")}var n="<table><tr>"+e.join("</tr><tr>")+"</tr></table>";return n}function s(){var t=$("#topBar");t.slideDown(function(){t.children().fadeIn()}),setTimeout(function(){t.removeClass("init")},2500)}Karma.TopBar={setTopBar:e,show:s}}(),function(t){"use strict";$(function(){Karma.Home.start()});var e=function(){function e(){$(".mapLink").click(function(t){return $("#playerNameForm")[0].checkValidity()?(Karma.LocalStorage.set("playerName",$("#playerName").val()),Karma.LocalStorage.set("map",$(this).text()),!0):($("#playerNameForm").find(":submit").click(),t.preventDefault(),!1)})}function a(t){for(var a=[],i=0;t.length>i;i++){var s=t[i];a.push('<li id="map-',s,'"><a class="mapLink" href="game.'+s+'" >'+s),a.push('</a></br><a class="editLink" href="mm.'+s+'" >edit</a></br><span class="players"/></li>')}$("ul#maps").html(a.join("")),e()}Karma.TopBar.setTopBar();var i=window.location.hostname,s=t.connect(i,{secure:!0});s.emit("get_maps",function(t,e){a(e),$("#loadingImage").fadeOut(),$("#mapsContainer").fadeIn(2e3)}),s.on("maps_state",function(t){var e=function(t){return t.name};for(var a in t){var i=t[a],s=_.map(i.players,e).join(", ");s.length>0&&(s="Players : "+s),$("#map-"+i.map+" .players").html(s)}}),$("#playerNameForm").submit(function(){return!1}),$("#playerName").keyup(function(){Karma.LocalStorage.set("playerName",$(this).val())})};Karma.Home={start:e}}(io);