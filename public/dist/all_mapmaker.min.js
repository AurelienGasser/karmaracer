/*! karmaracer 2013-05-10 */
var Karma=Karma||{},KLib=KLib||{};(function(){"use strict";KLib.isFunction=function(t){return"function"==typeof t},KLib.isUndefined=function(t){return void 0===t},KLib.extend=function(t,e){function i(t,e){function i(){return t.apply(this,e)}return i.prototype=t.prototype,new i}var a=i(t,Array.prototype.slice.call(arguments,2));e.base={};for(var s in a)if(KLib.isUndefined(e[s])){var n=a[s];e[s]=n}else e.base[s]=t.prototype[s]}})(),function(){"use strict";var t=function(){function t(t){return s.karma[t]}function e(e){var i=t(e);return void 0===i?!1:!0}function i(){localStorage.karma=JSON.stringify(s.karma)}function a(t,e){s.karma[t]=e,i()}this.karma=_.isUndefined(localStorage.karma)?{}:JSON.parse(localStorage.karma);var s=this;return{get:t,set:a,exists:e}};Karma.LocalStorage=new t}(),function(){"use strict";var t={},e={input:$("#chat_input"),messages:$("#chat_msgs"),label:$("#chat_input_label"),input_wrapper:$("#chat_input_wrapper")};t.sendMsg=function(){if(""!==e.input.val().trim()){var i=Karma.LocalStorage.get("playerName")+": "+$("#chat_input").val();Karma.gameInstance.socketManager.emit("chat",i)}e.input.val(""),t.hideChat()},t.onChatMsgReceived=function(t,i){e.messages.append('<li id="'+i+'">'+t+"</li>"),setTimeout(function(){$("li#"+i).fadeOut(500,function(){$("li#"+i).remove()})},2e4)},t.showChat=function(){e.label.html(Karma.LocalStorage.get("playerName")+" :"),e.input_wrapper.show(),e.input.focus(),e.input_wrapper.addClass("enable")},t.hideChat=function(){e.input.blur(),e.input_wrapper.hide(),e.input_wrapper.removeClass("enable")},t.clearChatInputField=function(){e.input.val("")},Karma.Chat=t}(),function(){"use strict";function t(t,e,i,a,s){this.canvas=t,this.canvasID=e,this.timer=(new Date).getTime(),this.frames=0,this.debugDraw=!1,this.carFlameTicks={},this.items=i,this.worldInfo=a,this.setGScale(32),this.$canvas=$(t),this.init(),this.loaded(),this.loadImages(s)}t.prototype.setGScale=function(t){this.gScaleValue=t,this.gScaleDynamicsRequired=!0,this.gScaleList(this.worldInfo.staticItems),this.gScale(this.worldInfo.size)},t.prototype.loadImages=function(t){function e(){return s===a-1&&KLib.isFunction(t)?t():(s+=1,void 0)}var i=this,a=Object.keys(this.worldInfo.itemsInMap).length+1,s=0;i.createBGPattern(e);var n=function(){if("none"!==this.patternType){var t=i.ctx.createPattern(c,"repeat");i.worldInfo.itemsInMap[this.name].pattern=t,i.worldInfo.itemsInMap[this.name].img=c}else i.worldInfo.itemsInMap[this.name].pattern=null;e()};for(var o in this.worldInfo.itemsInMap){var r=this.worldInfo.itemsInMap[o],c=new Image;c.src=r.image.path,c.onload=n.bind(r),r.img=c}},t.prototype.createBGPattern=function(t){var e=this,i=new Image;i.src=e.worldInfo.background.path,i.onload=function(){var i=e.ctx.createPattern(this,"repeat");return e.backgroundPattern=i,t()}},t.prototype.gScaleList=function(t){for(var e=t.length-1;e>=0;e--)this.gScale(t[e])},t.prototype.gScaleIfRequired=function(){this.gScaleDynamicsRequired===!0&&(this.gScaleList(this.items.cars),this.gScale(this.items.mycar),this.gScaleDynamicsRequired=!1)},t.prototype.gScale=function(t){null!==t&&(t.x&&(t.x*=this.gScaleValue),t.y&&(t.y*=this.gScaleValue),t.w&&(t.w*=this.gScaleValue),t.h&&(t.h*=this.gScaleValue))},t.prototype.init=function(){this.ctx=this.canvas.getContext("2d"),this.canvas.width=$("#"+this.canvasID).width(),this.canvas.height=$("#"+this.canvasID).height(),this.camera=new Karma.Camera(this.ctx,"#"+this.canvasID),this.camera.setWorldSize(this.worldInfo.size),this.loadCars(),this.explosionImage=new Image,this.explosionImage.src="/sprites/explosion.png",this.rocketImage=new Image,this.rocketImage.src="/sprites/rocket.png",this.gunFlameImage=new Image,this.gunFlameImage.src="/sprites/gun_flame.png"},t.prototype.loaded=function(){$("#loadingtext").html("")},t.prototype.resize=function(){var t={w:this.$canvas.width(),h:this.$canvas.height()};KLib.isUndefined(this.canvasSize)||(t=this.canvasSize),this.camera.ctx.canvas.width=t.w,this.camera.ctx.canvas.height=t.h},t.prototype.draw=function(){if(this.worldInfo.staticItems.length>0){this.resize();var t=this.oldCenter;null!==this.items.mycar&&(t=this.items.mycar,this.camera.update(t)),t&&t!=this.oldCenter&&(this.oldCenter=t),this.drawItems()}},t.prototype.drawLifeBar=function(t,e){t.save(),t.translate(-e.w/2,-40);var i=e.w;t.fillStyle="#0F0",t.fillRect(0,0,i,5),t.fillStyle="#F00";var a=i*(e.life/e.maxLife);t.fillRect(a,0,i-a,5),t.restore()};var e=12;t.prototype.drawSingleGunFlame=function(t,i,a,s){var n=1.5;t.rotate(a);var o=i.w/2,r=i.h/2;i.flame>e/2?t.drawImage(this.gunFlameImage,0,0,135,125,s,-r/2,o,r):t.drawImage(this.gunFlameImage,0,0,135,125,s,-r/2/n,o/n,r/n),t.rotate(-a)},t.prototype.drawGunFlame=function(t,i){switch(KLib.isUndefined(this.carFlameTicks[i.id])&&(this.carFlameTicks[i.id]=0),i.flame=this.carFlameTicks[i.id],i.shootingWithWeapon){case"90 angle machine gun":this.drawSingleGunFlame(t,i,0,i.w/2),this.drawSingleGunFlame(t,i,Math.PI/2,i.w/4),this.drawSingleGunFlame(t,i,-Math.PI/2,i.w/4);break;case"super machine gun":this.drawSingleGunFlame(t,i,0,i.w/2),this.drawSingleGunFlame(t,i,Math.PI/4,i.w/4),this.drawSingleGunFlame(t,i,-Math.PI/4,i.w/4);break;case"machine gun":this.drawSingleGunFlame(t,i,0,i.w/2);break;default:this.drawSingleGunFlame(t,i,0,i.w/2)}this.carFlameTicks[i.id]=(this.carFlameTicks[i.id]+1)%e};var i=56,a=51;t.prototype.drawExplosions=function(t){if(null!==this.items.explosions){t.fillStyle="#FFFFFF";for(var e in this.items.explosions){var s=this.items.explosions[e];t.save(),t.translate(s.x,s.y),t.rotate(s.r);var n=a,o=i;t.globalAlpha=s.alpha,t.drawImage(this.explosionImage,0,0,o,n,-n/2,-n/2,o,n),t.restore()}}},t.prototype.drawProjectiles=function(t){if(null!==this.items.projectiles)for(var e=0;this.items.projectiles.length>e;e++){var i=this.items.projectiles[e];switch(i.name){case"rocket launcher":this.drawRocket(i,t);break;default:this.drawBullet(i,t)}}},t.prototype.drawBullet=function(t,e){e.fillStyle="#0F0";var i=t;e.save(),e.beginPath();var a=i;e.translate(a.x,a.y),e.moveTo(0,0),e.rotate(a.r),e.lineTo(320,0),e.closePath(),e.restore()},t.prototype.drawRocket=function(t,e){e.fillStyle="#FFFFFF";var i=t;e.save(),e.translate(i.x,i.y),e.rotate(i.r),e.drawImage(this.rocketImage,-i.w/2,-i.h/2,40,16),e.restore()},t.prototype.drawOutsideWalls=function(t){var e=this.gScaleValue,i=this.camera.realWorldSize;t.fillStyle=this.debugDraw?"#00FF00":this.worldInfo.itemsInMap.outsideWall.pattern,t.fillRect(-e,i.h,i.w+2*e,e),t.fillRect(-e,-e,i.w+2*e,e),t.fillRect(-e,0,e,i.h),t.fillRect(i.w,0,e,i.h)},t.prototype.drawStaticItems=function(t){var e=this;null!==e.worldInfo.staticItems&&_.each(e.worldInfo.staticItems,function(i){var a=e.worldInfo.itemsInMap[i.name];KLib.isUndefined(a)||KLib.isUndefined(a.pattern)||(null===a.pattern?t.drawImage(a.img,i.x-i.w/2,i.y-i.h/2,i.w,i.h):(t.fillStyle=a.pattern,t.fillRect(i.x-i.w/2,i.y-i.h/2,i.w,i.h)))})},t.prototype.drawBackground=function(t){KLib.isUndefined(this.backgroundPattern)||(t.fillStyle=this.backgroundPattern,t.fillRect(0,0,this.camera.realWorldSize.w,this.camera.realWorldSize.h))},t.prototype.drawItems=function(){this.drawBackground(this.ctx),this.drawBodies(this.ctx),this.drawOutsideWalls(this.ctx),this.drawStaticItems(this.ctx),this.drawCars(this.ctx),this.drawExplosions(this.ctx),this.drawProjectiles(this.ctx)},t.prototype.tick=function(){requestAnimFrame(this.tick.bind(this)),this.gScaleIfRequired(),this.draw(),this.frames++;var t=(new Date).getTime();t-this.timer>1e3&&(this.timer=t,$("#fps").html("fps: "+this.frames),this.frames=0)},Karma.Engine2DCanvas=t}(),function(){"use strict";function t(t,e){this.ctx=t,this.translate={x:0,y:0},this.center={x:0,y:0},this.scale=1.2,this.realWorldSize={w:0,h:0},this.canvasSelector=e}t.prototype.setWorldSize=function(t){this.realWorldSize=t;var e=this.getCanvasSize();this.scaledSized={w:e.w*this.scale,h:e.h*this.scale},this.scaleLimits={min:.1,max:5}},t.prototype.updateScale=function(){},t.prototype.getCanvasSize=function(){return{w:this.ctx.canvas.width,h:this.ctx.canvas.height}},t.prototype.resizeCanvas=function(t){null!==this.ctx&&(this.ctx.canvas.width=t.w,this.ctx.canvas.height=t.h,$(this.canvasSelector).width(t.w),$(this.canvasSelector).height(t.h))},t.prototype.getScreenRatio=function(){var t=this.getCanvasSize(),e=t.w/this.realWorldSize.w,i=t.h/this.realWorldSize.h;return i>e?e:i},t.prototype.drawDebug=function(){var t=this.getCanvasSize(),e=[];e.push("<ul>"),e.push("<li>","Canvas Size : ",t.w,", ",t.h,"</li>"),e.push("<li>","Translate X : ",this.translate.x,"</li>"),e.push("<li>","Translate Y : ",this.translate.y,"</li>"),e.push("<li>","Scale : ",this.scale,"</li>"),e.push("<li>","Scaled Size : ",this.scaledSized.w,", ",this.scaledSized.h,"</li>"),e.push("<li>","myCar Pos : ",this.center.x,", ",this.center.y,", rÂ°:",this.center.r,"</li>"),e.push("<li>","Orientation : ",window.orientation,"</li>"),null!==window.orientation,e.push("</ul>"),$("#camera-debug").html(e.join(""))},t.prototype.update=function(t){t!==void 0&&(this.center=t),this.updateScale();var e=this.getCanvasSize();this.scaledSized={w:e.w/this.scale,h:e.h/this.scale},this.translate.x=this.scaledSized.w/2-this.center.x,this.translate.y=this.scaledSized.h/2-this.center.y,this.ctx.scale(this.scale,this.scale),this.ctx.translate(this.translate.x,this.translate.y)},Karma.Camera=t}(),function(t){"use strict";function e(t,e,i){t.save(),t.beginPath(),t.fillStyle=i||"#FF0000",t.arc(e.x,e.y,10,0,2*Math.PI,!1),t.fill(),t.closePath(),t.fillStyle=i||"#00FF00",e.name&&t.fillText(e.name,e.x,e.y),t.restore()}function i(t,e){t.strokeStyle="#000000",t.beginPath(),t.moveTo(-e.x*a,-e.y*a),t.lineTo(e.x*a,e.y*a),t.closePath(),t.stroke()}var a=192;t.prototype.drawBodies=function(t){var a,s;if(this.debugDraw&&null!==this.bodies){for(s=0;this.bodies.length>s;s++){a=this.bodies[s],t.save(),t.fillStyle=a.color,t.translate(a.x,a.y),t.beginPath(),t.moveTo(a.ul.x,a.ul.y),t.lineTo(a.ur.x,a.ur.y),t.lineTo(a.br.x,a.br.y),t.lineTo(a.bl.x,a.bl.y),t.closePath(),t.fill(),t.restore(),t.save();var n=t.measureText(a.playerName),o=25;t.translate(a.x,a.y),t.fillText(a.playerName,-n.width/2,-o),t.restore()}for(s=0;this.bodies.length>s;s++){a=this.bodies[s],t.save(),t.translate(a.x,a.y);var r=!1;if(r&&!_.isUndefined(a.collision))for(i(t,a.collision.a1),i(t,a.collision.a2),i(t,a.collision.a3),i(t,a.collision.a4),s=1;4>=s;++s)e(t,a.collision.axesMinMax[s].minA,"#000"),e(t,a.collision.axesMinMax[s].maxA,"#F00"),e(t,a.collision.axesMinMax[s].minB,"#0F0"),e(t,a.collision.axesMinMax[s].maxB,"#00F");t.restore()}}},t.prototype.drawCollisionPoints=function(){if(this.items.collisionPoints){var t=this.ctx;for(var i in this.items.collisionPoints){var a=this.items.collisionPoints[i];e(t,a,"#F00")}}}}(Karma.Engine2DCanvas),function(t){"use strict";t.prototype.loadCars=function(){var t=this,e=function(t,e,i,a){var s={name:t,path:"/sprites/"+e,w:i,h:a};return s.image=new Image,s.image.src=s.path,s},i=function(e){t.carsImages[e.name]=e};this.carsImages={},i(e("c1","car.png",128,64)),i(e("c2","car2.png",82,36)),i(e("c3","car3.png",72,32)),i(e("c4","car4.png",74,34)),i(e("c5","car5.png",81,35))},t.prototype.drawCars=function(t){if(null!==this.items.cars)for(var e=0;this.items.cars.length>e;e++){var i=this.items.cars[e];t.save(),t.translate(i.x,i.y),t.rotate(i.r);var a=this.carsImages[i.carImageName];t.drawImage(a.image,0,0,a.w,a.h,-i.w/2,-i.h/2,i.w,i.h),i.shootingWithWeapon&&this.drawGunFlame(t,i),t.restore();var s=t.measureText(i.playerName),n=25;t.save(),t.translate(i.x,i.y),t.font="10px Trebuchet MS",t.fillStyle="white",t.fillText(i.playerName,-s.width/2,-n),this.drawLifeBar(t,i),t.restore(),this.drawBullet(i,t)}}}(Karma.Engine2DCanvas),function(){"use strict";function t(t,e,i,a,s){var n=document.getElementById(t),o=e,r=function(t,e,n){switch(t){case"CANVAS":return new Karma.Engine2DCanvas(n,e,i,a,s)}};return o="CANVAS",r(o,t,n)}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),Karma.getDrawEngine=t}(),function(){"use strict";function t(){FB.getLoginStatus(function(t){"connected"===t.status?a(t):"not_authorized"===t.status?n():n()})}function e(){FB.getLoginStatus(function(t){"not_logged_in"===t.status&&n(),"connected"===t.status&&a()})}function i(t){try{FB.api("/"+t.id+"/scores/"+l.conf.appName,function(t){if(!t||t.error)Karma.Log.error(t);else{var e=0;t.data.length>0&&(e=t.data[0].score),$("#fbHighScore").html('<div title="High Score">High Score : '+e+"</div>"),Karma.TopBar.show()}})}catch(e){Karma.Log.error(e)}}function a(){c()}function s(){FB.Event.subscribe("auth.login",function(){a()}),e(),$("#fb-login").on("click",function(){t(),$(this).off("click")})}function n(){FB.login(function(t){t.authResponse&&a()},{scope:"publish_actions"})}function o(){window.fbAsyncInit=function(){var t="http://"+l.host+"/channel.html",e={appId:l.conf.appID,channelUrl:t,status:!0,cookie:!0,xfbml:!0};FB.init(e),s()},function(t){var e,i="facebook-jssdk",a=t.getElementsByTagName("script")[0];t.getElementById(i)||(e=t.createElement("script"),e.id=i,e.async=!0,e.src="//connect.facebook.net/en_US/all.js",a.parentNode.insertBefore(e,a))}(document)}function r(t,e){FB.api("/me/picture?width=180&height=180",function(i){return t.html('<img class="fb-picture" src="'+i.data.url+'">'),e(null,i)})}function c(){FB.api("/me",function(t){r($("#fbLoginImage"),function(){});var e=Karma.LocalStorage.exists("playerName"),a=Karma.LocalStorage.get("playerName");e&&""!==a?$("#playerName").val(a):(Karma.LocalStorage.set("playerName",t.name),$("#playerName").val(t.name)),i(t)})}var l={};l.host=function(){var t=window.location.hostname+":"+window.location.port;return t}(),l.conf=function(){var t={appID:"156724717828757",appName:"karmaracer_dev"},e={appID:"512708015460560",appName:"karmaracer"};return-1!==l.host.indexOf("localhost")?t:e}(),l.setup=o,l.getLoginStatus=t,l.afterLogin=a,l.setup(),Karma.FB=l}(),function(){"use strict";function t(t){console&&console.error(t)}function e(t){console&&console.info(t)}Karma.Log={error:t,info:e}}(),function(){"use strict";var t=function(t,e,i,a,s){this.$container=t,this.connection=i,this.canvasID="minimap-"+e,this.$canvas=$('<canvas id="'+this.canvasID+'" class="miniMap"></canvas>'),this.$container.append(this.$canvas),this.canvas=this.$canvas[0],this.items=a,KLib.isUndefined(s)||(this.playerPositionID="player-position-on-minimap-"+e,this.$playerPosition=$('<div class="miniMapPlayerPosition" id="'+this.playerPositionID+'"></div>'),this.$container.append(this.$playerPosition),this.mycarPosition=s),this.getMap(e,function(){})};t.prototype.getMap=function(t,e){var i=this,a={cars:[],mycar:null,projectiles:[],explosions:[]},s=function(t,s){return i.drawEngine=Karma.getDrawEngine(i.canvasID,"CANVAS",a,s,function(){i.drawEngine.setGScale(1/8),i.drawEngine.canvasSize=i.drawEngine.worldInfo.size,i.drawEngine.resize(),i.drawEngine.tick()}),setInterval(function(){KLib.isUndefined(i.mycarPosition)||(i.$playerPosition.css("left",i.$canvas.position().left+4*i.mycarPosition.x+"px"),i.$playerPosition.css("top",i.$canvas.position().top+4*i.mycarPosition.y+"px"))},50),KLib.isFunction(e)?e(null):void 0};this.connection.emit("getMiniMap",{name:t},s)},Karma.MiniMap=t}(),function(){"use strict";function t(){var t=document.URL,e=t.split("/"),i=e[e.length-1];return-1!==i.indexOf("#")&&(i=i.split("#")[0]),i}function e(){var e=[];e.push('<div id="topBar" class="init"><ul id="topBarBoxes">');var i=t();""!==i&&e.push('<li id="topHelp"><a href="/"><img src="/images/iconHome.png" id="iconHome"/></a></li>'),e.push('<li><form id="playerNameForm" href="#">'),e.push('Welcome to Karma Racer, <input title="change your name here" id="playerName" type="text" placeholder="Your name" required="required" name="playerName" autocomplete="off"></input>'),e.push('<input type="submit" style="display:none"/>'),e.push("</form></li>"),e.push('<li id="fbHighScore"/>'),e.push('<li id="topHelp"><img src="/images/iconHelp.png" id="iconHelp" title="Home"/>'),e.push('<div id="keys"></div>'),e.push("</li>"),e.push('<li id="fbLoginImage"/>'),e.push("</ul>");var s=$(e.join(""));s.hide(),$("body").append(s);var n=$("#keys");$("#iconHelp").hover(function(){n.show()},function(){n.hide()}),$("#keys").html(a());var o=$("#playerName");o.keyup(function(){Karma.LocalStorage.set("playerName",o.val())}),s.children().hide()}function i(t,e){return{key:t,text:e}}function a(){var t=[];t.push(i("&#8593;&nbsp;&#8595;","accelerate / go backward")),t.push(i("&#8592;&nbsp;&#8594;","turn left / right")),t.push(i("&#60;space&#62;","shoot")),t.push(i("L/P","zoom / unzoom")),t.push(i("B","break")),t.push(i("Mouse Click","drive"));for(var e=[],a=0;t.length>a;a++){var s=t[a];e.push('<td class="help_keys">'+s.key+'</td><td class="help_keys_text">'+s.text+"</td>")}var n="<table><tr>"+e.join("</tr><tr>")+"</tr></table>";return n}function s(){var t=$("#topBar");t.slideDown(function(){t.children().fadeIn()}),setTimeout(function(){t.removeClass("init")},2500)}Karma.TopBar={setTopBar:e,show:s}}(),function(){"use strict";function t(t,e,i){this.id=i,this.jsonItem=t,this.position={x:0,y:0},this.size={w:this.jsonItem.image.size,h:this.jsonItem.image.size},this.name=this.jsonItem.name,this.patternType=this.jsonItem.patternType,this.pattern=void 0,this.zIndex=0,this.path=this.jsonItem.image.path,this.ctx=e,this.image=null}t.prototype.initImage=function(t){this.image=new Image,this.image.src=this.jsonItem.image.path,this.image.crop=this.jsonItem.image.crop;var e=this;e.image.onerror=function(){},e.image.onload=function(){return"none"===e.patternType||KLib.isUndefined(e.ctx)||(e.pattern=e.ctx.createPattern(e.image,"repeat")),t(null,e)}},t.prototype.scale=function(t,e,i){var a,s=t.x-e.x,n=t.y-e.y;if(i.shift){var o=Math.min(s,n);a={x:o,y:o}}else a={x:s,y:n};"vertical"==this.patternType?this.size.w=this.image.crop.w:this.size.w+=a.x,"horizontal"==this.patternType?this.size.h=this.image.crop.h:this.size.h+=a.y,this.size.w=Math.max(this.size.w,1),this.size.h=Math.max(this.size.h,1)},Karma.MapItem=t}(),function(){"use strict";function t(t){e(t),a(t),i(t)}function e(t){var e=$("#map-name");e.keyup(function(){t.mapName=e.val(),t.loadMap(t.mapName)}),e.val(t.mapName)}function i(t){function e(){var e=parseInt(i.val(),10)*t.gScale,s=parseInt(a.val(),10)*t.gScale;t.realWorldSize.w=e,t.realWorldSize.h=s,t.resize()}var i=$("#map-width"),a=$("#map-height");i.change(e),a.change(e)}function a(t){var e=$("#map-bg"),i=[];i.push('<datalist id="bg-list">');for(var a=0;t.backgroundItems.length>a;a++){var s=t.backgroundItems[a];i.push('<option value="',s.name,'">'),i.push(s.name,"</option>")}i.push("</datalist>"),e.after(i.join("")),e.keyup(function(){t.mapBackgroundName=e.val(),t.svgDrawBackground()}),e.val(t.mapBackgroundName)}function s(){var e="map-canvas",i=new Karma.Map("#"+e);i.connection.emit("get_items",function(a,s){var n=[];for(var o in s)n.push(s[o]);i.loadItems(n,function(){i.loadMap(i.mapName,function(){t(i),i.svgInit(e)})})}),$("#save-map-node").click(function(){i.saveMap()})}$(function(){s()})}(),function(t){"use strict";function e(e){var i=window.location.hostname;this.connection=t.connect(i),this.MapItems={},this.selectedItems=[],this.canvasMousePosition={x:0,y:0},this.mouseDownPosition={x:0,y:0},this.translateMousePosition={x:0,y:0},this.idCount=0,this.keyPress={shift:!1},this.selectedZone={x:0,y:0,w:0,h:0},this.keyboardHandler=new Karma.KeyboardHandlerMap(this),this.scale=1,this.gScale=16,this.translate={x:0,y:0},this.realWorldSize={w:64*this.gScale,h:32*this.gScale},this.mapName=G_mapName,this.mapBackgroundName="",this.itemsByName={},this.zoomBox=null,this.enable=!1,this.backgroundItems=[],this.$map=$(e),this.$map.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h),this.itemsGlow={}}function i(t,e,i){function a(){return n===s-1&&_.isFunction(i)?i(null):(n+=1,void 0)}for(var s=t.length,n=0,o=0;t.length>o;o++){var r=t[o];e(r,a)}}e.prototype.resize=function(){this.$map.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h)},e.prototype.loadMap=function(t,e){var i=this;i.connection.emit("get_map",t,function(a,s){if(null!==a)return Karma.Log.error("no map with name",t),e({msg:"no map with name",type:"warn"});i.mapBackgroundName=s.background.name,i.enable=s.enable,$("#map-width").val(s.size.w),$("#map-height").val(s.size.h);var n=$("#map-enable");s.enable===!0&&n.prop("checked",!0),n.click(function(){i.enable=this.checked}),i.realWorldSize.w=s.size.w*i.gScale,i.realWorldSize.h=s.size.h*i.gScale,i.resize();for(var o=0;s.staticItems.length>o;o++){var r=s.staticItems[o],c=i.itemsByName[r.name],l=i.createMapItem(c);l.position.x=r.position.x*i.gScale,l.position.y=r.position.y*i.gScale,l.size.w=r.size.w*i.gScale,l.size.h=r.size.h*i.gScale}return _.isFunction(e)?e(null):void 0})},e.prototype.startTick=function(){var t=new Date;this.tickStart=t.getTime(),this.tickCount=0,this.tick()},e.prototype.outputDebug=function(){var t=[];t.push("<li>Canvas Mouse Pos : ",this.canvasMousePosition.x,", ",this.canvasMousePosition.y,"</li>"),t.push("<li>Canvas Down Pos : ",this.mouseDownPosition.x,", ",this.mouseDownPosition.y,"</li>"),t.push("<li>Translate Down Pos : ",this.translateMousePosition.x,", ",this.translateMousePosition.y,"</li>"),t.push("<li>Action : ",this.action,"</li>"),t.push("<li>ScaleCanvas : ",this.scale,"</li>"),t.push("<li>TranslateCanvas : ",this.translate.x,", ",this.translate.y,"</li>"),t.push("<li>--------</li>"),t.push("<li>Help</li>"),t.push("<li>Arrows (move canvas)</li>"),t.push("<li>R (release items)</li>"),t.push("<li>P/L (zoom/unzoom)</li>"),t.push("<li>S (set scale to 1)</li>"),t.push("<li>Z (zoom to selected items)</li>"),$("#canvas-debug").html(t.join(""))},e.prototype.tick=function(){this.tickCount++;var t=new Date,e=t.getTime()-this.tickStart;e>1e3&&($("#fps").html("fps:"+this.tickCount),this.tickCount=0,this.tickStart=t.getTime()),requestAnimFrame(this.tick.bind(this)),this.outputDebug()},e.prototype.loadItems=function(t,e){var a=this;i(t,function(t,e){a.loadItemFromServer(t,function(){return e()})},e)},e.prototype.addMapItemInDoForSelection=function(t,e){function i(){r.css("background-image",'url("'+e.image.src+'")')}var a=this,s="item-"+e.name,n=$('<li class="item" id="'+s+'"></li>'),o=$('<ul class="item-properties"/>');n.append(o);var r=$('<li class="kr-mm-demo"/>');switch(e.patternType){case"both":var c={name:e.name,path:e.image.src};a.backgroundItems.push(c),i();break;case"horizontal":i();break;case"vertical":i();break;default:r.append('<img class="kr-item-demo" src="'+e.image.src+'"/>')}r.addClass("kr-mm-demo-"+e.patternType),o.append('<li class="kr-pp-item-name">'+e.name+"</li>"),o.append(r),t.append(n),$("#"+s).click(function(){var t=a.itemsByName[e.name];Karma.Log.info("add map item",t);var i=a.createMapItem(t);i.size.w=t.size.w*a.gScale,i.size.h=t.size.h*a.gScale,a.svgRaphaelAddItem(i)})},e.prototype.createMapItem=function(t){var e=this,i=e.idCount++,a=new Karma.MapItem(t,e.ctx,i);return a.image=t.image,a.pattern=t.pattern,e.MapItems[i]=a,a},e.prototype.removeMapItem=function(t){delete this.MapItems[t]},e.prototype.loadItemFromServer=function(t,e){var i=this,a=$("#items");if(_.isFunction(e)){var s=new Karma.MapItem(t,i.ctx,t.name);s.initImage(function(t,n){return i.addMapItemInDoForSelection(a,n),i.itemsByName[s.name]=n,e(null,n)})}},Karma.Map=e}(io),function(t){"use strict";t.prototype.startTranslating=function(){this.action="translate",this.translateMousePosition=this.mouseDownPosition},t.prototype.translateSelectedItemsUsingMousePosition=function(){var t={x:this.canvasMousePosition.x-this.translateMousePosition.x,y:this.canvasMousePosition.y-this.translateMousePosition.y};_.each(this.selectedItems,function(e){var i=this.MapItems[e];i.position={x:i.position.x+t.x,y:i.position.y+t.y}}.bind(this)),this.translateMousePosition=this.canvasMousePosition},t.prototype.startScaling=function(){this.action="scale",this.scaleMousePosition=this.mouseDownPosition},t.prototype.scaleItemsUsingCanvasMouse=function(){_.each(this.selectedItems,function(t){var e=this.MapItems[t];e.scale(this.canvasMousePosition,this.scaleMousePosition,this.keyPress)}.bind(this)),this.scaleMousePosition=this.canvasMousePosition}}(Karma.Map),function(t){"use strict";t.prototype.canvasInit=function(t){var e="canvas-map";this.canvasTag=$('<canvas id="'+e+'"/>'),$(t).append(this.canvasTag),this.canvas=$(t).children("canvas")[0],this.ctx=this.canvas.getContext("2d"),this.canvas.onmousemove=this.mouseMove.bind(this),this.canvas.onmousedown=this.mouseDown.bind(this),this.canvas.onmouseup=this.mouseUp.bind(this),this.canvasTag.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h)},t.prototype.canvasDrawBackground=function(){if(""!==this.mapBackgroundName){var t=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(t)||(this.ctx.fillStyle=t.pattern,this.ctx.fillRect(0,0,this.realWorldSize.w,this.realWorldSize.h))}},t.prototype.canvasDraw=function(){this.ctx.canvas.width=$(this.canvas).width(),this.ctx.canvas.height=$(this.canvas).height(),this.ctx.save(),this.ctx.scale(this.scale,this.scale),this.canvasDrawBackground(),this.ctx.fillStyle="00f",this.ctx.strokeRect(0,0,this.realWorldSize.w,this.realWorldSize.h),this.ctx.translate(this.translate.x,this.translate.y),this.ctx.scale(this.scale,this.scale);for(var t in this.MapItems){var e=this.MapItems[t];this.canvasDrawItem(e)}"selectZone"==this.action&&this.canvasDrawSelectedZone(),this.ctx.restore(),null!==this.zoomBox&&(this.scale=this.realWorldSize.w*this.scale/this.zoomBox.w,this.translate.x=-this.zoomBox.x*this.scale,this.translate.y=-this.zoomBox.y*this.scale,this.zoomBox=null)},t.prototype.canvasDrawItem=function(t){var e=_.include(this.selectedItems,t.id);e?(this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2,this.ctx.shadowBlur=4,this.ctx.shadowColor="rgba(0, 0, 0, 0.5)"):(this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0),"none"!==t.patternType?(this.ctx.fillStyle=t.pattern,this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),this.ctx.fillRect(0,0,t.size.w,t.size.h),this.ctx.restore()):this.ctx.drawImage(t.image,t.position.x,t.position.y,t.size.w,t.size.h),e&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(t.position.x+.8*t.size.w,t.position.y+.8*t.size.h,.2*t.size.w,.2*t.size.h))},t.prototype.canvasDrawSelectedZone=function(){this.selectedZone.x=this.mouseDownPosition.x,this.selectedZone.y=this.mouseDownPosition.y,this.selectedZone.w=this.canvasMousePosition.x-this.mouseDownPosition.x,this.selectedZone.h=this.canvasMousePosition.y-this.mouseDownPosition.y,0>this.selectedZone.w&&(this.selectedZone.x+=this.selectedZone.w,this.selectedZone.w*=-1),0>this.selectedZone.h&&(this.selectedZone.y+=this.selectedZone.h,this.selectedZone.h*=-1),this.ctx.strokeStyle="f00",this.ctx.strokeRect(this.selectedZone.x,this.selectedZone.y,this.selectedZone.w,this.selectedZone.h)}}(Karma.Map||{}),function(t){"use strict";t.prototype.svgRaphaelAddItem=function(t){function e(t){var e=$('<div><a href="#">'+t+"</a></div>");return e}function i(t){var i=e(t);i.click(function(e){return"toFront"===t?(o[t](),c[t]()):(c[t](),o[t](),a.bgImg.toBack()),e.preventDefault(),!1}),l.append(i)}t.position.x-=t.size.w/2,t.position.y-=t.size.h/2;var a=this,s=1,n=.5,o=this.R.rect(t.position.x,t.position.y,t.size.w,t.size.h).attr({fill:"url('"+t.image.src+"')",stroke:"none",opacity:s,cursor:"move"}),r=32,c=this.R.rect(t.position.x+t.size.w-r,t.position.y+t.size.h-r,r,r).attr({fill:"hsb(0.8, 0.5, .5)",stroke:"none",opacity:s}),l=$("<li></li>");i("toFront"),i("toBack");var h=e("removeItem");l.append(h),h.click(function(){a.removeMapItem(t.id),$(o.node).remove(),$(c.node).remove()}),o.li=l,$("#canvas-debug").append(l),$("#canvas-debug").children().hide();var m=function(){this.ox=this.attr("x"),this.oy=this.attr("y"),this.attr({opacity:n}),this.sizer.ox=this.sizer.attr("x"),this.sizer.oy=this.sizer.attr("y"),this.sizer.attr({opacity:s})},p=function(e,i){this.attr({x:this.ox+e,y:this.oy+i}),t.position.x=this.ox+e,t.position.y=this.oy+i,this.sizer.attr({x:this.sizer.ox+e,y:this.sizer.oy+i}),0>t.position.x&&(t.position.x=0),0>t.position.y&&(t.position.y=0)},u=function(){this.attr({opacity:s}),this.sizer.attr({opacity:s})},d=function(){this.ox=this.attr("x"),this.oy=this.attr("y"),this.box.ow=this.box.attr("width"),this.box.oh=this.box.attr("height")},f=function(e,i){this.attr({x:this.ox+e,y:this.oy+i}),this.box.attr({width:this.box.ow+e,height:this.box.oh+i}),t.size.w=this.box.attr("width"),t.size.h=this.box.attr("height")};return $(o.node).click(function(e){return $("#canvas-debug").children().hide(),o.li.show(),l.find("div.mm-clean").remove(),l.append('<div class="mm-clean">pos : '+JSON.stringify(t.position)+"</div>"),l.append('<div class="mm-clean">size : '+JSON.stringify(t.size)+"</div>"),e.preventDefault(),!1}),o.drag(p,m,u),o.sizer=c,c.drag(f,d),c.box=o,o},t.prototype.svgInit=function(t){this.R=new Raphael(t,this.realWorldSize.w,this.realWorldSize.h),$(this.R.canvas).click(function(t){return $("#canvas-debug").children().hide(),t.preventDefault(),!1}),this.svgLoad()},t.prototype.svgLoad=function(){this.svgDraw()},t.prototype.svgDraw=function(){this.svgDrawBackground();for(var t in this.MapItems){var e=this.MapItems[t];this.svgRaphaelAddItem(e)}},t.prototype.svgDrawBackground=function(){if(KLib.isUndefined(this.bgImg)||$(this.bgImg.node).remove(),""!==this.mapBackgroundName){var t=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(t)||(this.bgImg=this.R.rect(0,0,this.realWorldSize.w,this.realWorldSize.h),this.bgImg.attr({fill:"url('"+t.path+"')"}))}}}(Karma.Map||{}),function(){"use strict";function t(t){this.canvasMap=t,document.onkeydown=this.handleKeyDown.bind(this),document.onkeyup=this.handleKeyUp.bind(this)}t.prototype.handleKey=function(t,e){switch(t){case 37:this.canvasMap.translate.x+=5;break;case 39:this.canvasMap.translate.x-=5;break;case 38:this.canvasMap.translate.y+=5;break;case 40:this.canvasMap.translate.y-=5;break;case 90:if(!e)break;this.canvasMap.zoomToSelectedItems();break;case 83:if(!e)break;this.canvasMap.scale=1,this.canvasMap.translate={x:0,y:0};break;case 76:if(!e)break;this.canvasMap.scale*=1.1;break;case 77:this.canvasMap.actionTranslate=e,e&&(this.canvasMap.mouseDownPosition=this.canvasMap.canvasMousePosition);break;case 80:if(!e)break;this.canvasMap.scale*=.9;break;case 82:e&&this.canvasMap.deselectAllItems();break;case 16:this.canvasMap.keyPress.shift=e;break;default:}},t.prototype.handleKeyDown=function(t){this.handleKey(t.keyCode,!0)},t.prototype.handleKeyUp=function(t){this.handleKey(t.keyCode,!1)},Karma.KeyboardHandlerMap=t}(),function(t){"use strict";t.prototype.mouseDown=function(){this.mouseDownPosition=this.canvasMousePosition,this.action="",this.keyPress.shift?_.each(this.MapItems,function(t){this.isMousePositionInItem(t)&&(this.isItemSelected(t.id)?this.deselectItem(t.id):this.selectItem(t.id))}.bind(this)):(_.each(this.MapItems,function(t){this.isMousePositionInItem(t)&&(this.isItemSelected(t.id)||(this.deselectAllItems(),this.selectItem(t.id)),this.mouseDownOnItem=t,this.mouseDownInItemScaleZone(t,.8)?this.startScaling():this.startTranslating())}.bind(this)),"translate"!=this.action&&"scale"!=this.action&&(this.deselectAllItems(),this.action="selectZone"))},t.prototype.mouseMove=function(t){this.canvasMousePosition={x:t.pageX-this.canvas.offsetLeft-this.translate.x,y:t.pageY-this.canvas.offsetTop-this.translate.y},this.canvasMousePosition.x*=1/this.scale,this.canvasMousePosition.y*=1/this.scale;var e="s-resize";if("scale"==this.action)document.body.style.cursor=e;else{var i=!1;_.each(this.MapItems,function(t){i||this.mouseDownInItemScaleZone(t,.9)&&(i=!0)}.bind(this)),document.body.style.cursor=i?e:"default"}if(0===t.button&&1===t.which)switch(this.action){case"translate":this.translateSelectedItemsUsingMousePosition();break;case"scale":this.scaleItemsUsingCanvasMouse()
}},t.prototype.mouseUp=function(){switch(this.action){case"selectZone":this.selectItemsInSelectedZone();break;case"scale":case"translate":break;default:}this.action=""}}(Karma.Map),function(t){"use strict";t.prototype.saveMap=function(){var t=this,e=this.realWorldSize.w,i=this.realWorldSize.h,a={name:$("#map-name").val(),enable:t.enable,size:{w:parseInt(e/this.gScale,10),h:i/this.gScale}},s="/sprites/bg_grass1.png",n=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(n)||(s=n.path),KLib.isUndefined(s)||(a.background={path:s,name:this.mapBackgroundName}),a.staticItems=[],$.each(this.MapItems,function(e,i){var s={};s.name=i.name,s.position={x:(i.position.x+i.size.w/2)/t.gScale,y:(i.position.y+i.size.h/2)/t.gScale},s.size={w:parseInt(i.size.w/t.gScale,10),h:parseInt(i.size.h/t.gScale,10)},a.staticItems.push(s)}),this.connection.emit("saveMap",a)}}(Karma.Map),function(t){"use strict";t.prototype.zoomToSelectedItems=function(){var t,e,i,a;_.each(this.selectedItems,function(s){var n=this.MapItems[s];t===void 0&&(t=n),e===void 0&&(e=n),i===void 0&&(i=n),a===void 0&&(a=n),n.position.x<t.position.x&&(t=n),n.position.x+n.size.w>e.position.x+e.size.w&&(e=n),n.position.y<i.position.y&&(i=n),n.position.y+n.size.h>a.position.y+a.size.h&&(a=n)}.bind(this));var s=20;this.selectedItems.length>0&&(this.zoomBox={x:t.position.x-s,y:i.position.y-s,w:e.position.x+e.size.w-t.position.x+2*s,h:a.position.y+a.size.h-i.position.y+2*s})},t.prototype.mouseDownInItemScaleZone=function(t,e){return this.canvasMousePosition.x<t.position.x+t.size.w*e?!1:this.canvasMousePosition.x>t.position.x+t.size.w?!1:this.canvasMousePosition.y<t.position.y+t.size.h*e?!1:this.canvasMousePosition.y>t.position.y+t.size.h?!1:!0},t.prototype.selectItemsInSelectedZone=function(){_.each(this.MapItems,function(t){t.position.x<this.selectedZone.x||t.position.y<this.selectedZone.y||t.position.x+t.size.w>this.selectedZone.x+this.selectedZone.w||t.position.y+t.size.h>this.selectedZone.y+this.selectedZone.h||this.selectItem(t.id)}.bind(this))},t.prototype.isMousePositionInItem=function(t){return this.canvasMousePosition.x<t.position.x?!1:this.canvasMousePosition.x>t.position.x+t.size.w?!1:this.canvasMousePosition.y<t.position.y?!1:this.canvasMousePosition.y>t.position.y+t.size.h?!1:!0},t.prototype.deselectAllItems=function(){for(var t in this.itemsGlow)this.deselectItem(t);this.selectedItems=[]},t.prototype.isItemSelected=function(t){return _.include(this.selectedItems,t)},t.prototype.selectItem=function(t,e){this.selectedItems.push(t),KLib.isUndefined(e)||(e.isSelected=!0,this.itemsGlow[t]=e,$(e).attr("stroke","#000"),$(e.rectSelected).show())},t.prototype.deselectItem=function(t){this.selectedItems.splice(this.selectedItems.indexOf(t),1);var e=this.itemsGlow[t];KLib.isUndefined(e)||(e.isSelected=!1,$(e.rectSelected).hide(),$(e).attr("stroke","transparent"))}}(Karma.Map);