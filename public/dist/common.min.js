/*! karmaracer 2013-05-08 */
function setGoogleAnalytics(){var e=e||[];e.push(["_setAccount","UA-27170619-1"]),e.push(["_trackPageview"]),function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()}function sendMsg(){if(""!==$("#chat_input").val().trim()){var e=Karma.get("playerName")+": "+$("#chat_input").val();G_gameInstance.socketManager.emit("chat",e)}$("#chat_input").val(""),hideChat()}function onChatMsgReceived(e,t){$("#chat_msgs").append('<li id="'+t+'">'+e+"</li>"),setTimeout(function(){$("li#"+t).fadeOut(500,function(){$("li#"+t).remove()})},2e4)}function showChat(){$("#chat_input_label").html(Karma.get("playerName")+" :"),$("#chat_input_wrapper").show(),$("#chat_input").focus(),$("#chat_input_wrapper").addClass("enable")}function hideChat(){$("#chat_input").blur(),$("#chat_input_wrapper").hide(),$("#chat_input_wrapper").removeClass("enable")}function clearChatInputField(){$("#chat_input").val("")}function Engine2DCanvas(e,t,i){return this.canvas=t,this.canvasID=i,this.gameInstance=e,this.init(),this.loaded(),this.timer=(new Date).getTime(),this.frames=0,this.debugDraw=!1,this.carFlameTicks={},this}function drawAxis(e,t){e.strokeStyle="#000000",e.beginPath(),e.moveTo(-t.x*scale2,-t.y*scale2),e.lineTo(t.x*scale2,t.y*scale2),e.closePath(),e.stroke()}function drawLine(e,t,i){drawPoint(e,i),e.save(),e.strokeStyle="#0000FF",e.fillStyle="#0000FF",e.translate(i.x,i.y),e.rotate(c.r);var a=5;e.fillRect(-a/2,-a/2,a,a),e.restore(),e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.closePath(),e.stroke()}function drawPoint(e,t,i){e.save(),e.beginPath(),e.fillStyle=i||"#FF0000",e.arc(t.x,t.y,10,0,2*Math.PI,!1),e.fill(),e.closePath(),e.fillStyle=i||"#00FF00",t.name&&e.fillText(t.name,t.x,t.y),e.restore()}function Camera(e,t){this.ctx=e,this.translate={x:0,y:0},this.center={x:0,y:0},this.scale=1.2,this.realWorldSize={w:0,h:0},this.canvasSelector=t}function DrawEngineFactory(e,t,i){var a,s=document.getElementById(t),n=i,o=function(e,t,i,a){switch(t){case"CANVAS":return new Engine2DCanvas(e,a,i)}};return n="CANVAS",o(e,n,t,s,a)}var KLib={};KLib.isFunction=function(e){return"function"==typeof e},KLib.isUndefined=function(e){return void 0===e},KLib.extend=function(e,t){function i(e,t){function i(){return e.apply(this,t)}return i.prototype=e.prototype,new i}var a=i(e,Array.prototype.slice.call(arguments,2));t.base={};for(var s in a)if(KLib.isUndefined(t[s])){var n=a[s];t[s]=n}else t.base[s]=e.prototype[s]};var Karma=function(){function e(e){return s.karma[e]}function t(t){var i=e(t);return void 0===i?!1:!0}function i(){localStorage.karma=JSON.stringify(s.karma)}function a(e,t){s.karma[e]=t,i()}this.karma=_.isUndefined(localStorage.karma)?{}:JSON.parse(localStorage.karma);var s=this;return{get:e,set:a,exists:t}}();setGoogleAnalytics(),Engine2DCanvas.prototype.initBackgroundCanvas=function(){this.backgroundCanvas=document.createElement("canvas");var e=this.camera.realWorldSize,t=1;this.backgroundCanvas.width=e.w*t,this.backgroundCanvas.height=e.h*t,this.backgroundContext=this.backgroundCanvas.getContext("2d"),this.backgroundContext.save(),this.drawBackground(this.backgroundContext),this.drawOutsideWalls(this.backgroundContext),this.drawStaticItems(this.backgroundContext),this.backgroundContext.restore()},Engine2DCanvas.prototype.init=function(){this.ctx=this.canvas.getContext("2d"),this.canvas.width=$("#"+this.canvasID).width(),this.canvas.height=$("#"+this.canvasID).height(),this.camera=new Camera(this.ctx,"#"+this.canvasID),this.camera.setWorldSize(this.gameInstance.world.size),this.loadCarsImages(),this.explosionImage=new Image,this.explosionImage.src="/sprites/explosion.png",this.rocketImage=new Image,this.rocketImage.src="/sprites/rocket.png",this.gunFlameImage=new Image,this.gunFlameImage.src="/sprites/gun_flame.png"},Engine2DCanvas.prototype.loadCarsImages=function(){this.carImages={};for(var e in this.gameInstance.carsImages){var t=this.gameInstance.carsImages[e],i=new Image;i.src=t.path,this.carImages[t.name]=i}},Engine2DCanvas.prototype.loaded=function(){$("#loadingtext").html("")},Engine2DCanvas.prototype.draw=function(){if(this.gameInstance.walls.length>0){this.camera.ctx.canvas.width=$("#"+this.canvasID).width(),this.camera.ctx.canvas.height=$("#"+this.canvasID).height();var e=this.gameInstance.mycar||this.oldCenter;this.camera.update(e),e&&e!=this.oldCenter&&(this.oldCenter=e),this.drawItems()}},Engine2DCanvas.prototype.drawBodies=function(e){var t,i;if(this.debugDraw&&null!==this.gameInstance.bodies){for(i=0;this.gameInstance.bodies.length>i;i++){t=this.gameInstance.bodies[i],e.save(),e.fillStyle=t.color,e.translate(t.x,t.y),e.beginPath(),e.moveTo(t.ul.x,t.ul.y),e.lineTo(t.ur.x,t.ur.y),e.lineTo(t.br.x,t.br.y),e.lineTo(t.bl.x,t.bl.y),e.closePath(),e.fill(),e.restore(),e.save();var a=e.measureText(t.playerName),s=25;e.translate(t.x,t.y),e.fillText(t.playerName,-a.width/2,-s),e.restore()}for(i=0;this.gameInstance.bodies.length>i;i++){t=this.gameInstance.bodies[i],e.save(),e.translate(t.x,t.y);var n=!1;if(n&&!_.isUndefined(t.collision))for(drawAxis(e,t.collision.a1),drawAxis(e,t.collision.a2),drawAxis(e,t.collision.a3),drawAxis(e,t.collision.a4),i=1;4>=i;++i)drawPoint(e,t.collision.axesMinMax[i].minA,"#000"),drawPoint(e,t.collision.axesMinMax[i].maxA,"#F00"),drawPoint(e,t.collision.axesMinMax[i].minB,"#0F0"),drawPoint(e,t.collision.axesMinMax[i].maxB,"#00F");e.restore()}}},Engine2DCanvas.prototype.drawLifeBar=function(e,t){e.save(),e.translate(-t.w/2,-40);var i=t.w;e.fillStyle="#0F0",e.fillRect(0,0,i,5),e.fillStyle="#F00";var a=i*(t.life/t.maxLife);e.fillRect(a,0,i-a,5),e.restore()};var maxFlameTick=12;Engine2DCanvas.prototype.drawSingleGunFlame=function(e,t,i,a){var s=1.5;e.rotate(i);var n=t.w/2,o=t.h/2;t.flame>maxFlameTick/2?e.drawImage(this.gunFlameImage,0,0,135,125,a,-o/2,n,o):e.drawImage(this.gunFlameImage,0,0,135,125,a,-o/2/s,n/s,o/s),e.rotate(-i)},Engine2DCanvas.prototype.drawGunFlame=function(e,t){switch(KLib.isUndefined(this.carFlameTicks[t.id])&&(this.carFlameTicks[t.id]=0),t.flame=this.carFlameTicks[t.id],t.shootingWithWeapon){case"90 angle machine gun":this.drawSingleGunFlame(e,t,0,t.w/2),this.drawSingleGunFlame(e,t,Math.PI/2,t.w/4),this.drawSingleGunFlame(e,t,-Math.PI/2,t.w/4);break;case"super machine gun":this.drawSingleGunFlame(e,t,0,t.w/2),this.drawSingleGunFlame(e,t,Math.PI/4,t.w/4),this.drawSingleGunFlame(e,t,-Math.PI/4,t.w/4);break;case"machine gun":this.drawSingleGunFlame(e,t,0,t.w/2);break;default:this.drawSingleGunFlame(e,t,0,t.w/2)}this.carFlameTicks[t.id]=(this.carFlameTicks[t.id]+1)%maxFlameTick},Engine2DCanvas.prototype.drawCars=function(e){if(null!==this.gameInstance.cars)for(var t=0;this.gameInstance.cars.length>t;t++){var i=this.gameInstance.cars[t];e.save(),e.translate(i.x,i.y),e.rotate(i.r);var a=this.gameInstance.carsImages[i.carImageName];e.drawImage(this.carImages[a.name],0,0,a.w,a.h,-i.w/2,-i.h/2,i.w,i.h),i.shootingWithWeapon&&this.drawGunFlame(e,i),e.restore();var s=e.measureText(i.playerName),n=25;e.save(),e.translate(i.x,i.y),e.font="10px Trebuchet MS",e.fillStyle="white",e.fillText(i.playerName,-s.width/2,-n),this.drawLifeBar(e,i),e.restore(),this.drawBullet(i,e)}};var explosionWidth=56,explosionHeight=51;Engine2DCanvas.prototype.drawExplosions=function(e){if(null!==this.gameInstance.explosions){e.fillStyle="#FFFFFF";for(var t in this.gameInstance.explosions){var i=this.gameInstance.explosions[t];e.save(),e.translate(i.x,i.y),e.rotate(i.r);var a=explosionHeight,s=explosionWidth;e.globalAlpha=i.alpha,e.drawImage(this.explosionImage,0,0,s,a,-a/2,-a/2,s,a),e.restore()}}},Engine2DCanvas.prototype.drawProjectiles=function(e){if(null!==this.gameInstance.projectiles)for(var t=0;this.gameInstance.projectiles.length>t;t++){var i=this.gameInstance.projectiles[t];switch(i.name){case"rocket launcher":this.drawRocket(i,e);break;default:this.drawBullet(i,e)}}},Engine2DCanvas.prototype.drawCollisionPoints=function(){if(this.gameInstance.collisionPoints){var e=this.ctx;for(var t in this.gameInstance.collisionPoints){var i=this.gameInstance.collisionPoints[t];drawPoint(e,i,"#F00")}}},Engine2DCanvas.prototype.drawBullet=function(e,t){t.fillStyle="#0F0";var i=e;t.save(),t.beginPath();var a=i;t.translate(a.x,a.y),t.moveTo(0,0),t.rotate(a.r),t.lineTo(320,0),t.closePath(),t.restore()},Engine2DCanvas.prototype.drawRocket=function(e,t){t.fillStyle="#FFFFFF";var i=e;t.save(),t.translate(i.x,i.y),t.rotate(i.r),t.drawImage(this.rocketImage,-i.w/2,-i.h/2,40,16),t.restore()},Engine2DCanvas.prototype.drawOutsideWalls=function(e){var t=50,i=this.camera.realWorldSize;e.fillStyle=this.debugDraw?"#00FF00":this.gameInstance.itemsInMap.outsideWall.pattern,e.fillRect(-t,i.h,i.w+2*t,t),e.fillRect(-t,-t,i.w+2*t,t),e.fillRect(-t,0,t,i.h),e.fillRect(i.w,0,t,i.h)},Engine2DCanvas.prototype.drawStaticItems=function(e){var t=this;null!==t.gameInstance.walls&&_.each(t.gameInstance.walls,function(i){var a=t.gameInstance.itemsInMap[i.name];KLib.isUndefined(a)||KLib.isUndefined(a.pattern)||(null===a.pattern?e.drawImage(a.img,i.x-i.w/2,i.y-i.h/2,i.w,i.h):(e.fillStyle=a.pattern,e.fillRect(i.x-i.w/2,i.y-i.h/2,i.w,i.h)))})},Engine2DCanvas.prototype.drawBackground=function(e){KLib.isUndefined(this.gameInstance.backgroundPattern)||(this.camera.getCanvasSize(),e.fillStyle=this.gameInstance.backgroundPattern,e.fillRect(0,0,this.camera.realWorldSize.w,this.camera.realWorldSize.h))},Engine2DCanvas.prototype.drawItems=function(){this.drawBackground(this.ctx),this.drawBodies(this.ctx),this.drawOutsideWalls(this.ctx),this.drawStaticItems(this.ctx),this.drawCars(this.ctx),this.drawExplosions(this.ctx),this.drawProjectiles(this.ctx),this.drawCollisionPoints()},Engine2DCanvas.prototype.tick=function(){requestAnimFrame(this.tick.bind(this)),this.gameInstance.drawEngine.draw(),this.frames++;var e=(new Date).getTime();e-this.timer>1e3&&(this.timer=e,$("#fps").html("fps: "+this.frames),this.frames=0)},Camera.prototype.setWorldSize=function(e){this.realWorldSize=e;var t=this.getCanvasSize();this.scaledSized={w:t.w*this.scale,h:t.h*this.scale},this.scaleLimits={min:.1,max:5}},Camera.prototype.updateScale=function(){this.getScreenRatio()},Camera.prototype.getCanvasSize=function(){return{w:this.ctx.canvas.width,h:this.ctx.canvas.height}},Camera.prototype.resizeCanvas=function(e){null!==this.ctx&&(this.ctx.canvas.width=e.w,this.ctx.canvas.height=e.h,$(this.canvasSelector).width(e.w),$(this.canvasSelector).height(e.h))},Camera.prototype.getScreenRatio=function(){var e=this.getCanvasSize(),t=e.w/this.realWorldSize.w,i=e.h/this.realWorldSize.h;return i>t?t:i},Camera.prototype.drawDebug=function(){var e=this.getCanvasSize(),t=[];t.push("<ul>"),t.push("<li>","Canvas Size : ",e.w,", ",e.h,"</li>"),t.push("<li>","Translate X : ",this.translate.x,"</li>"),t.push("<li>","Translate Y : ",this.translate.y,"</li>"),t.push("<li>","Scale : ",this.scale,"</li>"),t.push("<li>","Scaled Size : ",this.scaledSized.w,", ",this.scaledSized.h,"</li>"),t.push("<li>","myCar Pos : ",this.center.x,", ",this.center.y,", r°:",this.center.r,"</li>"),t.push("<li>","Orientation : ",window.orientation,"</li>"),null!==window.orientation,t.push("</ul>"),$("#camera-debug").html(t.join(""))},Camera.prototype.update=function(e){e!==void 0&&(this.center=e),this.updateScale();var t=this.getCanvasSize();this.scaledSized={w:t.w/this.scale,h:t.h/this.scale},this.translate.x=this.scaledSized.w/2-this.center.x,this.translate.y=this.scaledSized.h/2-this.center.y,this.ctx.scale(this.scale,this.scale),this.ctx.translate(this.translate.x,this.translate.y)},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var kFB={};(function(){function e(){FB.getLoginStatus(function(e){"connected"===e.status?a(e):"not_authorized"===e.status?n():n()})}function t(){FB.getLoginStatus(function(e){"not_logged_in"===e.status&&n(),"connected"===e.status&&a()})}function i(e){try{FB.api("/"+e.id+"/scores/"+kFB.conf.appName,function(e){if(!e||e.error)console.error(e);else{var t=0;e.data.length>0&&(t=e.data[0].score),$("#fbHighScore").html('<div title="High Score">High Score : '+t+"</div>"),TopBar.show()}})}catch(t){console.error(t)}}function a(){c()}function s(){FB.Event.subscribe("auth.login",function(){a()}),t(),$("#fb-login").on("click",function(){e(),$(this).off("click")})}function n(){FB.login(function(e){e.authResponse&&a()},{scope:"publish_actions"})}function o(){window.fbAsyncInit=function(){var e="http://"+kFB.host+"/channel.html",t={appId:kFB.conf.appID,channelUrl:e,status:!0,cookie:!0,xfbml:!0};FB.init(t),s()},function(e){var t,i="facebook-jssdk",a=e.getElementsByTagName("script")[0];e.getElementById(i)||(t=e.createElement("script"),t.id=i,t.async=!0,t.src="//connect.facebook.net/en_US/all.js",a.parentNode.insertBefore(t,a))}(document)}function r(e,t){FB.api("/me/picture?width=180&height=180",function(i){return e.html('<img class="fb-picture" src="'+i.data.url+'">'),t(null,i)})}function c(){FB.api("/me",function(e){r($("#fbLoginImage"),function(){});var t=Karma.exists("playerName"),a=Karma.get("playerName");t&&""!==a?$("#playerName").val(a):(Karma.set("playerName",e.name),$("#playerName").val(e.name)),i(e)})}kFB.host=function(){var e=window.location.hostname+":"+window.location.port;return e}(),kFB.conf=function(){var e={appID:"156724717828757",appName:"karmaracer_dev"},t={appID:"512708015460560",appName:"karmaracer"};return-1!==kFB.host.indexOf("localhost")?e:t}(),kFB.setup=o,kFB.getLoginStatus=e,kFB.afterLogin=a,kFB.setup()})();var MiniMap;(function(){MiniMap=function(e){this.$container=e,this.$container.append('<canvas class="miniMap"></canvas>')}})();var TopBar={};(function(){function e(){var e=document.URL,t=e.split("/"),i=t[t.length-1];return-1!==i.indexOf("#")&&(i=i.split("#")[0]),i}function t(){var t=[];t.push('<div id="topBar" class="init"><ul id="topBarBoxes">');var i=e();""!==i&&t.push('<li id="topHelp"><a href="/"><img src="/images/iconHome.png" id="iconHome"/></a></li>'),t.push('<li><form id="playerNameForm" href="#">'),t.push('Welcome to Karma Racer, <input title="change your name here" id="playerName" type="text" placeholder="Your name" required="required" name="playerName" autocomplete="off"></input>'),t.push('<input type="submit" style="display:none"/>'),t.push("</form></li>"),t.push('<li id="fbHighScore"/>'),t.push('<li id="topHelp"><img src="/images/iconHelp.png" id="iconHelp" title="Home"/>'),t.push('<div id="keys"></div>'),t.push("</li>"),t.push('<li id="fbLoginImage"/>'),t.push("</ul>");var s=$(t.join(""));s.hide(),$("body").append(s);var n=$("#keys");$("#iconHelp").hover(function(){n.show()},function(){n.hide()}),$("#keys").html(a()),$playerName=$("#playerName"),$playerName.keyup(function(){Karma.set("playerName",$playerName.val())}),s.children().hide()}function i(e,t){return{key:e,text:t}}function a(){var e=[];e.push(i("&#8593;&nbsp;&#8595;","accelerate / go backward")),e.push(i("&#8592;&nbsp;&#8594;","turn left / right")),e.push(i("&#60;space&#62;","shoot")),e.push(i("L/P","zoom / unzoom")),e.push(i("B","break")),e.push(i("Mouse Click","drive"));for(var t=[],a=0;e.length>a;a++){var s=e[a];t.push('<td class="help_keys">'+s.key+'</td><td class="help_keys_text">'+s.text+"</td>")}var n="<table><tr>"+t.join("</tr><tr>")+"</tr></table>";return n}TopBar.show=function(){$bar=$("#topBar"),$bar.slideDown(function(){$bar.children().fadeIn()}),setTimeout(function(){$bar.removeClass("init")},2500)},TopBar.setTopBar=t})();