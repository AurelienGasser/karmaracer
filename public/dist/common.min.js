/*! karmaracer 2013-05-08 */
function sendMsg(){if(""!==$("#chat_input").val().trim()){var t=Karma.get("playerName")+": "+$("#chat_input").val();G_gameInstance.socketManager.emit("chat",t)}$("#chat_input").val(""),hideChat()}function onChatMsgReceived(t,e){$("#chat_msgs").append('<li id="'+e+'">'+t+"</li>"),setTimeout(function(){$("li#"+e).fadeOut(500,function(){$("li#"+e).remove()})},2e4)}function showChat(){$("#chat_input_label").html(Karma.get("playerName")+" :"),$("#chat_input_wrapper").show(),$("#chat_input").focus(),$("#chat_input_wrapper").addClass("enable")}function hideChat(){$("#chat_input").blur(),$("#chat_input_wrapper").hide(),$("#chat_input_wrapper").removeClass("enable")}function clearChatInputField(){$("#chat_input").val("")}function setGoogleAnalytics(){var t=t||[];t.push(["_setAccount","UA-27170619-1"]),t.push(["_trackPageview"]),function(){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()}function MobileTerminalHandler(t){this.gameInstance=t,this.gameInstance.isMobile=!0}function updateOrientation(t){window.scrollTo(0,0),t.steeringWheel.resize(),null!==t.drawEngine.camera&&t.drawEngine.camera.resizeCanvas({w:$(window).width(),h:$(window).height()})}function Engine2DCanvas(t,e,a){return this.canvas=e,this.canvasID=a,this.gameInstance=t,this.init(),this.loaded(),this.timer=(new Date).getTime(),this.frames=0,this.debugDraw=!1,this.carFlameTicks={},this}function drawAxis(t,e){t.strokeStyle="#000000",t.beginPath(),t.moveTo(-e.x*scale2,-e.y*scale2),t.lineTo(e.x*scale2,e.y*scale2),t.closePath(),t.stroke()}function drawLine(t,e,a){drawPoint(t,a),t.save(),t.strokeStyle="#0000FF",t.fillStyle="#0000FF",t.translate(a.x,a.y),t.rotate(c.r);var n=5;t.fillRect(-n/2,-n/2,n,n),t.restore(),t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(a.x,a.y),t.closePath(),t.stroke()}function drawPoint(t,e,a){t.save(),t.beginPath(),t.fillStyle=a||"#FF0000",t.arc(e.x,e.y,10,0,2*Math.PI,!1),t.fill(),t.closePath(),t.fillStyle=a||"#00FF00",e.name&&t.fillText(e.name,e.x,e.y),t.restore()}function Camera(t,e){this.ctx=t,this.translate={x:0,y:0},this.center={x:0,y:0},this.scale=1.2,this.realWorldSize={w:0,h:0},this.canvasSelector=e}function DrawEngineFactory(t,e,a){var n,i=document.getElementById(e),s=a,r=function(t,e,a,n){switch(e){case"CANVAS":return new Engine2DCanvas(t,n,a)}};return s="CANVAS",r(t,s,e,i,n)}var KLib={};KLib.isFunction=function(t){return"function"==typeof t},KLib.isUndefined=function(t){return void 0===t},KLib.extend=function(t,e){function a(t,e){function a(){return t.apply(this,e)}return a.prototype=t.prototype,new a}var n=a(t,Array.prototype.slice.call(arguments,2));e.base={};for(var i in n)if(KLib.isUndefined(e[i])){var s=n[i];e[i]=s}else e.base[i]=t.prototype[i]};var Karma=function(){function t(t){return i.karma[t]}function e(e){var a=t(e);return void 0===a?!1:!0}function a(){localStorage.karma=JSON.stringify(i.karma)}function n(t,e){i.karma[t]=e,a()}this.karma=_.isUndefined(localStorage.karma)?{}:JSON.parse(localStorage.karma);var i=this;return{get:t,set:n,exists:e}}(),MiniMap;(function(){MiniMap=function(t){this.$container=t,this.$container.append('<canvas class="miniMap"></canvas>')}})(),setGoogleAnalytics(),MobileTerminalHandler.prototype.init=function(){$("#addBot").remove(),$("#removeBot").remove(),$("#left_panel").remove(),$("#player_name_div").remove(),$("head").append('<link rel="apple-touch-icon" href="/images/karmaracer-logo.png"/>'),$("body").attr("onorientationchange","updateOrientation(G_gameInstance)")},MobileTerminalHandler.prototype.addTouchScreenAreas=function(){$("body").append('<div id="touch-debug">toto</div>')},MobileTerminalHandler.prototype.touchEventTurn=function(t){t.originalEvent.targetTouches[0].pageY<t.target.offsetTop||t.originalEvent.targetTouches[0].pageY>t.target.offsetTop+t.target.clientHeight||t.originalEvent.targetTouches[0].pageX<t.target.offsetLeft||t.originalEvent.targetTouches[0].pageX>t.target.offsetLeft+t.target.clientWidth?this.userTurn("stop"):t.originalEvent.targetTouches[0].pageX<t.target.offsetLeft+t.target.clientWidth/2?this.userTurn("left"):this.userTurn("right")},MobileTerminalHandler.prototype.touchEventAccelerate=function(t){t.originalEvent.targetTouches[0].pageY<t.target.offsetTop||t.originalEvent.targetTouches[0].pageY>t.target.offsetTop+t.target.clientHeight||t.originalEvent.targetTouches[0].pageX<t.target.offsetLeft||t.originalEvent.targetTouches[0].pageX>t.target.offsetLeft+t.target.clientWidth?this.userAccelerate("stop"):t.originalEvent.targetTouches[0].pageY<t.target.offsetTop+t.target.clientHeight/2?this.userAccelerate("forward"):this.userAccelerate("backward")},MobileTerminalHandler.prototype.userTurn=function(t){switch(t){case"stop":this.touch.left&&this.gameInstance.keyboardHandler.event("left","end"),this.touch.right&&this.gameInstance.keyboardHandler.event("right","end");break;case"left":this.touch.right&&this.gameInstance.keyboardHandler.event("right","end"),this.touch.left||this.gameInstance.keyboardHandler.event("left","start");break;case"right":this.touch.left&&this.gameInstance.keyboardHandler.event("left","end"),this.touch.right||this.gameInstance.keyboardHandler.event("right","start")}this.touch.left=!1,this.touch.right=!1,"stop"!=t&&(this.touch[t]=!0)},MobileTerminalHandler.prototype.userAccelerate=function(t){switch(t){case"stop":this.touch.forward&&this.gameInstance.keyboardHandler.event("forward","end"),this.touch.backward&&this.gameInstance.keyboardHandler.event("backward","end");break;case"forward":this.touch.backward&&this.gameInstance.keyboardHandler.event("backward","end"),this.touch.forward||this.gameInstance.keyboardHandler.event("forward","start");break;case"backward":this.touch.forward&&this.gameInstance.keyboardHandler.event("forward","end"),this.touch.backward||this.gameInstance.keyboardHandler.event("backward","start")}this.touch.forward=!1,this.touch.backward=!1,"stop"!=t&&(this.touch[t]=!0)},MobileTerminalHandler.prototype.initTouchScreenEvents=function(){window.ontouchmove=function(t){t.preventDefault()},window.touchstart=function(t){t.preventDefault()},$("#pad-accelerate").bind("touchstart",function(t){this.touchEventAccelerate(t)}.bind(this)),$("#pad-accelerate").bind("touchend",function(){this.userAccelerate("stop")}.bind(this)),$("#pad-accelerate").bind("touchmove",function(t){this.touchEventAccelerate(t)}.bind(this)),$("#pad-turn").bind("touchstart",function(t){this.touchEventTurn(t)}.bind(this)),$("#pad-turn").bind("touchend",function(){this.userTurn("stop")}.bind(this)),$("#pad-turn").bind("touchmove",function(t){this.touchEventTurn(t)}.bind(this)),$("#pad-zoom").bind("touchstart",function(t){this.zoomLevel=t.pageX}),$("#pad-zoom").bind("touchmove",function(t){var e;e=0>this.zoomLevel-t.pageX?1.05:.95,this.gameInstance.drawEngine.camera.scale*=e})},Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var e=Array.prototype.slice,a=e.call(arguments,1),n=this,i=function(){},s=function(){return n.apply(this instanceof i?this:t||window,a.concat(e.call(arguments)))};return i.prototype=this.prototype,s.prototype=new i,s});var TopBar={};(function(){function t(){var t=document.URL,e=t.split("/"),a=e[e.length-1];return-1!==a.indexOf("#")&&(a=a.split("#")[0]),a}function e(){var e=[];e.push('<div id="topBar" class="init"><ul id="topBarBoxes">');var a=t();""!==a&&e.push('<li id="topHelp"><a href="/"><img src="/images/iconHome.png" id="iconHome"/></a></li>'),e.push('<li><form id="playerNameForm" href="#">'),e.push('Welcome to Karma Racer, <input title="change your name here" id="playerName" type="text" placeholder="Your name" required="required" name="playerName" autocomplete="off"></input>'),e.push('<input type="submit" style="display:none"/>'),e.push("</form></li>"),e.push('<li id="fbHighScore"/>'),e.push('<li id="topHelp"><img src="/images/iconHelp.png" id="iconHelp" title="Home"/>'),e.push('<div id="keys"></div>'),e.push("</li>"),e.push('<li id="fbLoginImage"/>'),e.push("</ul>");var i=$(e.join(""));i.hide(),$("body").append(i);var s=$("#keys");$("#iconHelp").hover(function(){s.show()},function(){s.hide()}),$("#keys").html(n()),$playerName=$("#playerName"),$playerName.keyup(function(){Karma.set("playerName",$playerName.val())}),i.children().hide()}function a(t,e){return{key:t,text:e}}function n(){var t=[];t.push(a("&#8593;&nbsp;&#8595;","accelerate / go backward")),t.push(a("&#8592;&nbsp;&#8594;","turn left / right")),t.push(a("&#60;space&#62;","shoot")),t.push(a("L/P","zoom / unzoom")),t.push(a("B","break")),t.push(a("Mouse Click","drive"));for(var e=[],n=0;t.length>n;n++){var i=t[n];e.push('<td class="help_keys">'+i.key+'</td><td class="help_keys_text">'+i.text+"</td>")}var s="<table><tr>"+e.join("</tr><tr>")+"</tr></table>";return s}TopBar.show=function(){$bar=$("#topBar"),$bar.slideDown(function(){$bar.children().fadeIn()}),setTimeout(function(){$bar.removeClass("init")},2500)},TopBar.setTopBar=e})(),Engine2DCanvas.prototype.initBackgroundCanvas=function(){this.backgroundCanvas=document.createElement("canvas");var t=this.camera.realWorldSize,e=1;this.backgroundCanvas.width=t.w*e,this.backgroundCanvas.height=t.h*e,this.backgroundContext=this.backgroundCanvas.getContext("2d"),this.backgroundContext.save(),this.drawBackground(this.backgroundContext),this.drawOutsideWalls(this.backgroundContext),this.drawStaticItems(this.backgroundContext),this.backgroundContext.restore()},Engine2DCanvas.prototype.init=function(){this.ctx=this.canvas.getContext("2d"),this.canvas.width=$("#"+this.canvasID).width(),this.canvas.height=$("#"+this.canvasID).height(),this.camera=new Camera(this.ctx,"#"+this.canvasID),this.camera.setWorldSize(this.gameInstance.world.size),this.loadCarsImages(),this.explosionImage=new Image,this.explosionImage.src="/sprites/explosion.png",this.rocketImage=new Image,this.rocketImage.src="/images/rocket.png",this.gunFlameImage=new Image,this.gunFlameImage.src="/sprites/gun_flame.png"},Engine2DCanvas.prototype.loadCarsImages=function(){this.carImages={};for(var t in this.gameInstance.carsImages){var e=this.gameInstance.carsImages[t],a=new Image;a.src=e.path,this.carImages[e.name]=a}},Engine2DCanvas.prototype.loaded=function(){$("#loadingtext").html("")},Engine2DCanvas.prototype.draw=function(){if(this.gameInstance.walls.length>0){this.camera.ctx.canvas.width=$("#"+this.canvasID).width(),this.camera.ctx.canvas.height=$("#"+this.canvasID).height();var t=this.gameInstance.mycar||this.oldCenter;this.camera.update(t),t&&t!=this.oldCenter&&(this.oldCenter=t),this.drawItems()}},Engine2DCanvas.prototype.drawBodies=function(t){var e,a;if(this.debugDraw&&null!==this.gameInstance.bodies){for(a=0;this.gameInstance.bodies.length>a;a++){e=this.gameInstance.bodies[a],t.save(),t.fillStyle=e.color,t.translate(e.x,e.y),t.beginPath(),t.moveTo(e.ul.x,e.ul.y),t.lineTo(e.ur.x,e.ur.y),t.lineTo(e.br.x,e.br.y),t.lineTo(e.bl.x,e.bl.y),t.closePath(),t.fill(),t.restore(),t.save();var n=t.measureText(e.playerName),i=25;t.translate(e.x,e.y),t.fillText(e.playerName,-n.width/2,-i),t.restore()}for(a=0;this.gameInstance.bodies.length>a;a++){e=this.gameInstance.bodies[a],t.save(),t.translate(e.x,e.y);var s=!1;if(s&&!_.isUndefined(e.collision))for(drawAxis(t,e.collision.a1),drawAxis(t,e.collision.a2),drawAxis(t,e.collision.a3),drawAxis(t,e.collision.a4),a=1;4>=a;++a)drawPoint(t,e.collision.axesMinMax[a].minA,"#000"),drawPoint(t,e.collision.axesMinMax[a].maxA,"#F00"),drawPoint(t,e.collision.axesMinMax[a].minB,"#0F0"),drawPoint(t,e.collision.axesMinMax[a].maxB,"#00F");t.restore()}}},Engine2DCanvas.prototype.drawLifeBar=function(t,e){t.save(),t.translate(-e.w/2,-40);var a=e.w;t.fillStyle="#0F0",t.fillRect(0,0,a,5),t.fillStyle="#F00";var n=a*(e.life/e.maxLife);t.fillRect(n,0,a-n,5),t.restore()};var maxFlameTick=12;Engine2DCanvas.prototype.drawSingleGunFlame=function(t,e,a,n){var i=1.5;t.rotate(a);var s=e.w/2,r=e.h/2;e.flame>maxFlameTick/2?t.drawImage(this.gunFlameImage,0,0,135,125,n,-r/2,s,r):t.drawImage(this.gunFlameImage,0,0,135,125,n,-r/2/i,s/i,r/i),t.rotate(-a)},Engine2DCanvas.prototype.drawGunFlame=function(t,e){switch(KLib.isUndefined(this.carFlameTicks[e.id])&&(this.carFlameTicks[e.id]=0),e.flame=this.carFlameTicks[e.id],e.shootingWithWeapon){case"90 angle machine gun":this.drawSingleGunFlame(t,e,0,e.w/2),this.drawSingleGunFlame(t,e,Math.PI/2,e.w/4),this.drawSingleGunFlame(t,e,-Math.PI/2,e.w/4);break;case"super machine gun":this.drawSingleGunFlame(t,e,0,e.w/2),this.drawSingleGunFlame(t,e,Math.PI/4,e.w/4),this.drawSingleGunFlame(t,e,-Math.PI/4,e.w/4);break;case"machine gun":this.drawSingleGunFlame(t,e,0,e.w/2);break;default:this.drawSingleGunFlame(t,e,0,e.w/2)}this.carFlameTicks[e.id]=(this.carFlameTicks[e.id]+1)%maxFlameTick},Engine2DCanvas.prototype.drawCars=function(t){if(null!==this.gameInstance.cars)for(var e=0;this.gameInstance.cars.length>e;e++){var a=this.gameInstance.cars[e];t.save(),t.translate(a.x,a.y),t.rotate(a.r);var n=this.gameInstance.carsImages[a.carImageName];t.drawImage(this.carImages[n.name],0,0,n.w,n.h,-a.w/2,-a.h/2,a.w,a.h),a.shootingWithWeapon&&this.drawGunFlame(t,a),t.restore();var i=t.measureText(a.playerName),s=25;t.save(),t.translate(a.x,a.y),t.font="10px Trebuchet MS",t.fillStyle="white",t.fillText(a.playerName,-i.width/2,-s),this.drawLifeBar(t,a),t.restore(),this.drawBullet(a,t)}};var explosionWidth=56,explosionHeight=51;Engine2DCanvas.prototype.drawExplosions=function(t){if(null!==this.gameInstance.explosions){t.fillStyle="#FFFFFF";for(var e in this.gameInstance.explosions){var a=this.gameInstance.explosions[e];t.save(),t.translate(a.x,a.y),t.rotate(a.r);var n=explosionHeight,i=explosionWidth;t.globalAlpha=a.alpha,t.drawImage(this.explosionImage,0,0,i,n,-n/2,-n/2,i,n),t.restore()}}},Engine2DCanvas.prototype.drawProjectiles=function(t){if(null!==this.gameInstance.projectiles)for(var e=0;this.gameInstance.projectiles.length>e;e++){var a=this.gameInstance.projectiles[e];switch(a.name){case"rocket launcher":this.drawRocket(a,t);break;default:this.drawBullet(a,t)}}},Engine2DCanvas.prototype.drawCollisionPoints=function(){if(this.gameInstance.collisionPoints){var t=this.ctx;for(var e in this.gameInstance.collisionPoints){var a=this.gameInstance.collisionPoints[e];drawPoint(t,a,"#F00")}}},Engine2DCanvas.prototype.drawBullet=function(t,e){e.fillStyle="#0F0";var a=t;e.save(),e.beginPath();var n=a;e.translate(n.x,n.y),e.moveTo(0,0),e.rotate(n.r),e.lineTo(320,0),e.closePath(),e.restore()},Engine2DCanvas.prototype.drawRocket=function(t,e){e.fillStyle="#FFFFFF";var a=t;e.save(),e.translate(a.x,a.y),e.rotate(a.r),e.drawImage(this.rocketImage,-a.w/2,-a.h/2,40,16),e.restore()},Engine2DCanvas.prototype.drawOutsideWalls=function(t){var e=50,a=this.camera.realWorldSize;t.fillStyle=this.debugDraw?"#00FF00":this.gameInstance.itemsInMap.outsideWall.pattern,t.fillRect(-e,a.h,a.w+2*e,e),t.fillRect(-e,-e,a.w+2*e,e),t.fillRect(-e,0,e,a.h),t.fillRect(a.w,0,e,a.h)},Engine2DCanvas.prototype.drawStaticItems=function(t){var e=this;null!==e.gameInstance.walls&&_.each(e.gameInstance.walls,function(a){var n=e.gameInstance.itemsInMap[a.name];KLib.isUndefined(n)||KLib.isUndefined(n.pattern)||(null===n.pattern?t.drawImage(n.img,a.x-a.w/2,a.y-a.h/2,a.w,a.h):(t.fillStyle=n.pattern,t.fillRect(a.x-a.w/2,a.y-a.h/2,a.w,a.h)))})},Engine2DCanvas.prototype.drawBackground=function(t){KLib.isUndefined(this.gameInstance.backgroundPattern)||(this.camera.getCanvasSize(),t.fillStyle=this.gameInstance.backgroundPattern,t.fillRect(0,0,this.camera.realWorldSize.w,this.camera.realWorldSize.h))},Engine2DCanvas.prototype.drawItems=function(){this.drawBackground(this.ctx),this.drawBodies(this.ctx),this.drawOutsideWalls(this.ctx),this.drawStaticItems(this.ctx),this.drawCars(this.ctx),this.drawExplosions(this.ctx),this.drawProjectiles(this.ctx),this.drawCollisionPoints()},Engine2DCanvas.prototype.tick=function(){requestAnimFrame(this.tick.bind(this)),this.gameInstance.drawEngine.draw(),this.frames++;var t=(new Date).getTime();t-this.timer>1e3&&(this.timer=t,$("#fps").html("fps: "+this.frames),this.frames=0)},Camera.prototype.setWorldSize=function(t){this.realWorldSize=t;var e=this.getCanvasSize();this.scaledSized={w:e.w*this.scale,h:e.h*this.scale},this.scaleLimits={min:.1,max:5}},Camera.prototype.updateScale=function(){this.getScreenRatio()},Camera.prototype.getCanvasSize=function(){return{w:this.ctx.canvas.width,h:this.ctx.canvas.height}},Camera.prototype.resizeCanvas=function(t){null!==this.ctx&&(this.ctx.canvas.width=t.w,this.ctx.canvas.height=t.h,$(this.canvasSelector).width(t.w),$(this.canvasSelector).height(t.h))},Camera.prototype.getScreenRatio=function(){var t=this.getCanvasSize(),e=t.w/this.realWorldSize.w,a=t.h/this.realWorldSize.h;return a>e?e:a},Camera.prototype.drawDebug=function(){var t=this.getCanvasSize(),e=[];e.push("<ul>"),e.push("<li>","Canvas Size : ",t.w,", ",t.h,"</li>"),e.push("<li>","Translate X : ",this.translate.x,"</li>"),e.push("<li>","Translate Y : ",this.translate.y,"</li>"),e.push("<li>","Scale : ",this.scale,"</li>"),e.push("<li>","Scaled Size : ",this.scaledSized.w,", ",this.scaledSized.h,"</li>"),e.push("<li>","myCar Pos : ",this.center.x,", ",this.center.y,", r°:",this.center.r,"</li>"),e.push("<li>","Orientation : ",window.orientation,"</li>"),null!==window.orientation,e.push("</ul>"),$("#camera-debug").html(e.join(""))},Camera.prototype.update=function(t){t!==void 0&&(this.center=t),this.updateScale();var e=this.getCanvasSize();this.scaledSized={w:e.w/this.scale,h:e.h/this.scale},this.translate.x=this.scaledSized.w/2-this.center.x,this.translate.y=this.scaledSized.h/2-this.center.y,this.ctx.scale(this.scale,this.scale),this.ctx.translate(this.translate.x,this.translate.y)},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}();var kFB={};(function(){function t(){FB.getLoginStatus(function(t){"connected"===t.status?n(t):"not_authorized"===t.status?s():s()})}function e(){FB.getLoginStatus(function(t){"not_logged_in"===t.status&&s(),"connected"===t.status&&n()})}function a(t){try{FB.api("/"+t.id+"/scores/"+kFB.conf.appName,function(t){if(!t||t.error)console.error(t);else{var e=0;t.data.length>0&&(e=t.data[0].score),$("#fbHighScore").html('<div title="High Score">High Score : '+e+"</div>"),TopBar.show()}})}catch(e){console.error(e)}}function n(){c()}function i(){FB.Event.subscribe("auth.login",function(){n()}),e(),$("#fb-login").on("click",function(){t(),$(this).off("click")})}function s(){FB.login(function(t){t.authResponse&&n()},{scope:"publish_actions"})}function r(){window.fbAsyncInit=function(){var t="http://"+kFB.host+"/channel.html",e={appId:kFB.conf.appID,channelUrl:t,status:!0,cookie:!0,xfbml:!0};FB.init(e),i()},function(t){var e,a="facebook-jssdk",n=t.getElementsByTagName("script")[0];t.getElementById(a)||(e=t.createElement("script"),e.id=a,e.async=!0,e.src="//connect.facebook.net/en_US/all.js",n.parentNode.insertBefore(e,n))}(document)}function o(t,e){FB.api("/me/picture?width=180&height=180",function(a){return t.html('<img class="fb-picture" src="'+a.data.url+'">'),e(null,a)})}function c(){FB.api("/me",function(t){o($("#fbLoginImage"),function(){});var e=Karma.exists("playerName"),n=Karma.get("playerName");e&&""!==n?$("#playerName").val(n):(Karma.set("playerName",t.name),$("#playerName").val(t.name)),a(t)})}kFB.host=function(){var t=window.location.hostname+":"+window.location.port;return t}(),kFB.conf=function(){var t={appID:"156724717828757",appName:"karmaracer_dev"},e={appID:"512708015460560",appName:"karmaracer"};return-1!==kFB.host.indexOf("localhost")?t:e}(),kFB.setup=r,kFB.getLoginStatus=t,kFB.afterLogin=n,kFB.setup()})();