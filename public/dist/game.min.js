/*! karmaracer 2013-05-08 */
function GameInstance(){function e(){for(var e in n.explosions)n.explosions[e].alpha-=.1,0>n.explosions[e].alpha&&delete n.explosions[e]}TopBar.setTopBar(),this.cars=[],this.explosions={},this.mycar=void 0,this.walls=[],this.drawEngine=void 0,this.socketManager=new SocketManager(this,this.onInitReceived.bind(this)),this.setUIEvents(),this.isMobile=!1,this.scoresTable=$("tbody#scores"),this.projectiles=[],this.loadCars();var n=this;setInterval(e,60)}function SocketManager(e,n){function t(){var e=(new Date).getTime();e-s.timestamp>1e3&&(s.timestamp=e,$("#socketps").html("socket/ps: "+s.socketCounter),s.socketCounter=0),s.socketCounter+=1}function a(e,n,t){KLib.isUndefined(t)&&(t=""),$("#announce").remove();var a=$('<div id="announce" class=" '+t+" announce-"+n+'"><span>'+e+"</span></div>");a.appendTo($("body")),setTimeout(function(){$("#announce").fadeOut(function(){$("#announce").remove()})},4e3)}function o(e,n,t,o,i){setTimeout(function(){return a(e,n,o),KLib.isFunction(i)?i(null):void 0},1e3*t)}var i=window.location.hostname;connection=io.connect(i),this.gameInstance=e,this.init_done=!1,this.socketCounter=0,this.timestamp=(new Date).getTime(),this.msg_id=0,this.gameInstance.bodies=[];var s=this;$("#debug").append('<div id="socketps" class="info"></div>'),$("#debug").append('<div id="debug-sockets" class="info">sockets</div>'),connection.on("connect",function(){_.isUndefined(G_mapName)||(connection.emit("enter_map",G_mapName),a("Shoot them all !","blue"))}),connection.on("init",function(e){n(null,e),Karma.get("playerName")&&0!==Karma.get("playerName").length||Karma.set("playerName",prompt("Welcome to Karmaracer !\nWhat's your name ?")),connection.emit("init_done",{playerName:Karma.get("playerName")}),this.init_done=!0}),connection.on("chat_msg",function(e){var n="msg_"+s.msg_id;onChatMsgReceived(e,n),++s.msg_id}),connection.on("dead",function(){a("You' re dead !","red")}),connection.on("game end",function(e){$("table.scores").addClass("big").removeClass("default");var n=function(){$("table.scores").removeClass("big").addClass("default")};a(e.winnerName+" wins the game !!!!","black","freeze"),o("2","red",3,"freeze"),o("1","orange",4,"freeze",n),o("GO","green",5,"")}),connection.on("objects",function(n){e.cars=n.cars,e.mycar=n.myCar,e.projectiles=n.projectiles,e.collisionPoints=n.collisionPoints,e.updateScoresHTML(),$("#debug-sockets").html(JSON.stringify(_.map(n,function(e){return e?e.length:0}))),t()}),connection.on("explosion",function(n){e.addExplosion(n)}),this.connection=connection}function KeyboardHandler(e){return this.gameInstance=e,this}var KLib={};KLib.isFunction=function(e){return"function"==typeof e},KLib.isUndefined=function(e){return void 0===e},GameInstance.prototype.loadCars=function(){var e=this,n=function(e,n,t,a){return{name:e,path:"/sprites/"+n,w:t,h:a}},t=function(n){e.carsImages[n.name]=n};this.carsImages={},t(n("c1","car.png",128,64)),t(n("c2","car2.png",82,36)),t(n("c3","car3.png",72,32)),t(n("c4","car4.png",74,34)),t(n("c5","car5.png",81,35))},GameInstance.prototype.setSound=function(e,n){var t;this.play_html5_audio?(t=new Audio(n),t.load()):(t=$("<embed id='"+e+"' type='audio/mpeg' />"),t.attr("src",n),t.attr("loop",!1),t.attr("hidden",!0),t.attr("autostart",!1),t.attr("enablejavascript",!0),$("body").append(t)),this.sounds[e]=t},GameInstance.prototype.play_sound=function(e){if(this.play_html5_audio){var n=new Audio(e);n.load(),n.play()}else{$("#sound").remove();var t=$("<embed type='audio/mpeg' />");t.attr("src",e),t.attr("loop",!1),t.attr("hidden",!0),t.attr("autostart",!0),$("body").append(t)}},GameInstance.prototype.updateScoresHTML=function(){function e(){var e=_.map(n.cars,function(e){return{score:e.s,level:e.l,name:e.playerName,highScore:e.highScore,id:e.id}});return e=_.sortBy(e,function(e){return e.score}).reverse()}for(var n=this,t=e(),a=[],o=0;t.length>o;o++){var i=t[o],s=null!==n.mycar&&n.mycar.id===i.id?"userCar":"";a.push('<tr class="',s,'"><td>',i.name,"</td><td>",i.score,"</td><td>",i.level,"</td><td>",i.highScore,"</td></tr>")}this.scoresTable.html(a.join(""))},GameInstance.prototype.updatePlayerName=function(e){this.socketManager.emit("updatePlayerName",e),Karma.set("playerName",e)},GameInstance.prototype.setUIEvents=function(){var e=this;$("#playerName").keyup(function(){e.updatePlayerName($(this).val())})},GameInstance.prototype.loadImages=function(e){function n(){return o===a-1?e():(o+=1,void 0)}var t=this,a=Object.keys(this.itemsInMap).length+1,o=0,i=new Image;i.src=t.worldInfo.background.path;var s=this;i.onload=function(){var e=s.drawEngine.ctx.createPattern(this,"repeat");s.backgroundPattern=e,n()},_.each(this.itemsInMap,function(e,t){var a=new Image;a.src=e.image.path,a.onload=function(){if("none"!==e.patternType){var o=this.drawEngine.ctx.createPattern(a,"repeat");this.itemsInMap[t].pattern=o}else this.itemsInMap[t].pattern=null,this.itemsInMap[t].img=a;n()}.bind(this)}.bind(this))},GameInstance.prototype.onInitReceived=function(e,n){var t=this;this.world={},this.worldInfo=n,this.world.size=n.size,this.walls=n.staticItems,this.itemsInMap=n.itemsInMap,this.bullets=[],this.rockets=[],t.drawEngine=DrawEngineFactory(t,"game-canvas",G_defaultDrawEngineType),t.loadImages(function(){t.keyboardHandler=new KeyboardHandler(t),document.onkeydown=t.keyboardHandler.handleKeyDown.bind(t.keyboardHandler),document.onkeyup=t.keyboardHandler.handleKeyUp.bind(t.keyboardHandler),t.drawEngine.tick()})},GameInstance.prototype.addExplosion=function(e){var n=Math.random();this.explosions[n]={x:e.x,y:e.y,r:3.14/6*Math.random()-3.14,alpha:.4*Math.random()-.2+.25}},$(window).on("beforeunload",function(){connection.emit("disconnect")});var connection;SocketManager.prototype.getConnection=function(){return this.connection},SocketManager.prototype.emit=function(e,n){this.connection.emit(e,n)},$(function(){$("#addBot").click(function(){connection.emit("add bot")}),$("#removeBot").click(function(){connection.emit("remove bot")})});var SteeringWheelController=function(){};SteeringWheelController.prototype.init=function(e){function n(e){return null===e?0:(a={x:0,y:0},res=Math.atan2(e.y,e.x)-Math.atan2(a.y,a.x),_.isNaN(res)&&(res=0),res)}this.m=$('<div id="SteeringWheelController"/>'),this.acc=$('<div id="SteeringWheelControllerAcc"/>'),this.m.append(this.acc),this.enable=!1,$("body").append(this.m),this.gameInstance=e,this.gameInstance.steeringWheel=this,this.resize(),this.accSize={w:this.acc.width(),h:this.acc.height()},this.force={x:0,y:0},this.updateCenter();var t=this,o=function(){var e=$(this);e.toggleClass("enable"),t.enable=e.hasClass("enable")};t.m.click(o),$(window).resize(function(){t.resize()}),window.onorientationchange=function(){t.resize()},window.webkitfullscreenchange=function(){};var i=null,s=function(){t.enable&&t.gameInstance.socketManager.emit("move_car",{force:t.force,angle:n(t.force)})},r=function(){null===i&&(i=setInterval(s,62.5))},c=function(){clearInterval(i),i=null},d=function(e){var n={x:e.pageX,y:e.pageY};t.gameInstance.isMobile&&(n.x=e.originalEvent.touches[0].pageX,n.y=e.originalEvent.touches[0].pageY);var a=n.x-t.mCenter.x,o=n.y-t.mCenter.y;t.acc.css("left",n.x-t.m.position().left-t.accSize.w/2),t.acc.css("top",n.y-t.m.position().top-t.accSize.h/2);var i={x:a/(t.mSize.w/2),y:o/(t.mSize.h/2)},s=10;t.gameInstance.isMobile&&(s=5),i.x*=s,i.y*=s,t.force=i};console.info("is mobile",t.gameInstance.isMobile),t.gameInstance.isMobile?(t.m.bind("touchstart",r),t.m.bind("touchend",c),t.m.bind("touchmove",d),t.enable=!0):(t.m.mousemove(d),t.m.hover(r,c)),t.acc.mousemove(function(e){return e.preventDefault(),!1})},SteeringWheelController.prototype.setMSize=function(e,n){var t=this;t.m.css("width",e+"px"),t.m.css("height",n+"px"),t.mSize={w:t.m.width(),h:t.m.height()},t.updateCenter()},SteeringWheelController.prototype.updateCenter=function(){var e=this;e.mSize={w:e.m.width(),h:e.m.height()},e.mCenter={x:e.mSize.w/2+e.m.position().left,y:e.mSize.h/2+e.m.position().top}},SteeringWheelController.prototype.setMPosition=function(e,n){var t=this,a=e-t.mSize.w/2,o=n-t.mSize.h/2;t.m.css("left",a+"px"),t.m.css("top",o+"px"),t.updateCenter()},SteeringWheelController.prototype.resize=function(){this.m.css({width:"100%",height:"100%"})},KEY_ENTER=13,KEY_SPACE=32,KEY_LEFT=37,KEY_RIGHT=39,KEY_UP=38,KEY_DOWN=40,KEY_ESCAPE=27,KEY_L=76,KEY_P=80,KEY_B=66,KeyboardHandler.prototype.sendKeyboardEvent=function(e,n){connection&&connection.emit("drive",e,n)},KeyboardHandler.prototype.handleKey=function(e,n){switch(e){case KEY_B:this.sendKeyboardEvent("break",n);break;case KEY_SPACE:this.sendKeyboardEvent("shoot",n);break;case KEY_LEFT:this.sendKeyboardEvent("left",n);break;case KEY_RIGHT:this.sendKeyboardEvent("right",n);break;case KEY_UP:this.sendKeyboardEvent("forward",n);break;case KEY_DOWN:this.sendKeyboardEvent("backward",n);break;case KEY_L:"start"==n&&(this.gameInstance.drawEngine.camera.scale*=1.05);break;case KEY_P:"start"==n&&(this.gameInstance.drawEngine.camera.scale*=.95);break;default:}},KeyboardHandler.prototype.handleKeyDown=function(e){switch(e.keyCode){case KEY_ESCAPE:clearChatInputField(),hideChat();break;case KEY_UP:case KEY_DOWN:$("#chat_input").is(":focus")&&hideChat(),this.handleKey(e.keyCode,"start");break;case KEY_ENTER:$("#chat_input").is(":focus")?sendMsg():showChat();break;case KEY_L:case KEY_P:case KEY_SPACE:$("#chat_input").is(":focus")||this.handleKey(e.keyCode,"start");break;default:this.handleKey(e.keyCode,"start")}},KeyboardHandler.prototype.handleKeyUp=function(e){this.handleKey(e.keyCode,"end")},document.ontouchstart=function(e){e.preventDefault()};var G_gameInstance;Modernizr.load([{complete:function(){Modernizr.load([{test:$("html.touch").length,yep:["/dist/mobile.js","/dist/mobile.css"],nope:["src/mobile/no-touch.css"],complete:function(){if(G_gameInstance=new GameInstance,"function"==typeof MobileTerminalHandler){var e=new MobileTerminalHandler(G_gameInstance);e.init()}new SteeringWheelController(G_gameInstance)}}])}}]);