/*! karmaracer 2013-05-09 */
(function(){"use strict";Modernizr.load([{complete:function(){Modernizr.load([{test:$("html.touch").length,yep:["/dist/mobile.js","/dist/mobile.css"],nope:["src/mobile/no-touch.css"],complete:function(){if(Karma.gameInstance=new Karma.GameInstance,"function"==typeof Karma.MobileTerminalHandler){var e=new Karma.MobileTerminalHandler(Karma.gameInstance);e.init()}new Karma.SteeringWheelController(Karma.gameInstance)}}])}}])})(),function(e){"use strict";function t(t,n){function a(){var e=(new Date).getTime();e-r.timestamp>1e3&&(r.timestamp=e,$("#socketps").html("socket/ps: "+r.socketCounter),r.socketCounter=0),r.socketCounter+=1}function o(e,t,n){KLib.isUndefined(n)&&(n=""),$("#announce").remove();var a=$('<div id="announce" class=" '+n+" announce-"+t+'"><span>'+e+"</span></div>");a.appendTo($("body")),setTimeout(function(){$("#announce").fadeOut(function(){$("#announce").remove()})},4e3)}function i(e,t,n,a,i){setTimeout(function(){return o(e,t,a),KLib.isFunction(i)?i(null):void 0},1e3*n)}var s=window.location.hostname;this.connection=e.connect(s),this.gameInstance=t,this.init_done=!1,this.socketCounter=0,this.timestamp=(new Date).getTime(),this.msg_id=0,this.gameInstance.bodies=[];var r=this;$(window).on("beforeunload",function(){r.connection.emit("disconnect")}),$(function(){$("#addBot").click(function(){r.connection.emit("add bot")}),$("#removeBot").click(function(){r.connection.emit("remove bot")})}),$("#debug").append('<div id="socketps" class="info"></div>'),$("#debug").append('<div id="debug-sockets" class="info">sockets</div>'),r.connection.on("connect",function(){_.isUndefined(G_mapName)||(r.connection.emit("enter_map",G_mapName),o("Shoot them all !","blue"))}),this.connection.on("init",function(e){n(null,e),Karma.LocalStorage.get("playerName")&&0!==Karma.LocalStorage.get("playerName").length||Karma.LocalStorage.set("playerName",prompt("Welcome to Karmaracer !\nWhat's your name ?")),r.connection.emit("init_done",{playerName:Karma.LocalStorage.get("playerName")}),this.init_done=!0}),this.connection.on("chat_msg",function(e){var t="msg_"+r.msg_id;Karma.Chat.onChatMsgReceived(e,t),++r.msg_id}),this.connection.on("dead",function(){o("You' re dead !","red")}),this.connection.on("game end",function(e){$("table.scores").addClass("big").removeClass("default");var t=function(){$("table.scores").removeClass("big").addClass("default")};o(e.winnerName+" wins the game !!!!","black","freeze"),i("2","red",3,"freeze"),i("1","orange",4,"freeze",t),i("GO","green",5,"")}),r.connection.on("objects",function(e){t.cars=e.cars,t.mycar=e.myCar,t.projectiles=e.projectiles,t.collisionPoints=e.collisionPoints,t.updateScoresHTML(),$("#debug-sockets").html(JSON.stringify(_.map(e,function(e){return e?e.length:0}))),a()}),r.connection.on("explosion",function(e){t.addExplosion(e)})}t.prototype.getConnection=function(){return this.connection},t.prototype.emit=function(e,t){this.connection.emit(e,t)},Karma.SocketManager=t}(io),function(){"use strict";var e=function(){};e.prototype.init=function(e){function t(e){if(null===e)return 0;var t={x:0,y:0},n=Math.atan2(e.y,e.x)-Math.atan2(t.y,t.x);return _.isNaN(n)&&(n=0),n}this.m=$('<div id="SteeringWheelController"/>'),this.acc=$('<div id="SteeringWheelControllerAcc"/>'),this.m.append(this.acc),this.enable=!1,$("body").append(this.m),this.gameInstance=e,this.gameInstance.steeringWheel=this,this.resize(),this.accSize={w:this.acc.width(),h:this.acc.height()},this.force={x:0,y:0},this.updateCenter();var n=this,a=function(){var e=$(this);e.toggleClass("enable"),n.enable=e.hasClass("enable")};n.m.click(a),$(window).resize(function(){n.resize()}),window.onorientationchange=function(){n.resize()},window.webkitfullscreenchange=function(){};var o=null,i=function(){n.enable&&n.gameInstance.socketManager.emit("move_car",{force:n.force,angle:t(n.force)})},s=function(){null===o&&(o=setInterval(i,62.5))},r=function(){clearInterval(o),o=null},c=function(e){var t={x:e.pageX,y:e.pageY};n.gameInstance.isMobile&&(t.x=e.originalEvent.touches[0].pageX,t.y=e.originalEvent.touches[0].pageY);var a=t.x-n.mCenter.x,o=t.y-n.mCenter.y;n.acc.css("left",t.x-n.m.position().left-n.accSize.w/2),n.acc.css("top",t.y-n.m.position().top-n.accSize.h/2);var i={x:a/(n.mSize.w/2),y:o/(n.mSize.h/2)},s=10;n.gameInstance.isMobile&&(s=5),i.x*=s,i.y*=s,n.force=i};n.gameInstance.isMobile?(n.m.bind("touchstart",s),n.m.bind("touchend",r),n.m.bind("touchmove",c),n.enable=!0):(n.m.mousemove(c),n.m.hover(s,r)),n.acc.mousemove(function(e){return e.preventDefault(),!1})},e.prototype.setMSize=function(e,t){var n=this;n.m.css("width",e+"px"),n.m.css("height",t+"px"),n.mSize={w:n.m.width(),h:n.m.height()},n.updateCenter()},e.prototype.updateCenter=function(){var e=this;e.mSize={w:e.m.width(),h:e.m.height()},e.mCenter={x:e.mSize.w/2+e.m.position().left,y:e.mSize.h/2+e.m.position().top}},e.prototype.setMPosition=function(e,t){var n=this,a=e-n.mSize.w/2,o=t-n.mSize.h/2;n.m.css("left",a+"px"),n.m.css("top",o+"px"),n.updateCenter()},e.prototype.resize=function(){this.m.css({width:"100%",height:"100%"})},Karma.SteeringWheelController=e}(),function(){"use strict";function e(e){return this.gameInstance=e,this}var t=13,n=32,a=37,o=39,i=38,s=40,r=27,c=76,d=80,h=66;e.prototype.sendKeyboardEvent=function(e,t){this.gameInstance.socketManager.getConnection()&&this.gameInstance.socketManager.getConnection().emit("drive",e,t)},e.prototype.handleKey=function(e,t){switch(e){case h:this.sendKeyboardEvent("break",t);break;case n:this.sendKeyboardEvent("shoot",t);break;case a:this.sendKeyboardEvent("left",t);break;case o:this.sendKeyboardEvent("right",t);break;case i:this.sendKeyboardEvent("forward",t);break;case s:this.sendKeyboardEvent("backward",t);break;case c:"start"==t&&(this.gameInstance.drawEngine.camera.scale*=1.05);break;case d:"start"==t&&(this.gameInstance.drawEngine.camera.scale*=.95);break;default:}},e.prototype.handleKeyDown=function(e){switch(e.keyCode){case r:Karma.Chat.clearChatInputField(),Karma.Chat.hideChat();break;case i:case s:$("#chat_input").is(":focus")&&Karma.Chat.hideChat(),this.handleKey(e.keyCode,"start");break;case t:$("#chat_input").is(":focus")?Karma.Chat.sendMsg():Karma.Chat.showChat();break;case c:case d:case n:$("#chat_input").is(":focus")||this.handleKey(e.keyCode,"start");break;default:this.handleKey(e.keyCode,"start")}},e.prototype.handleKeyUp=function(e){this.handleKey(e.keyCode,"end")},Karma.KeyboardHandler=e}(),function(){"use strict";function e(){function e(){for(var e in t.explosions)t.explosions[e].alpha-=.1,0>t.explosions[e].alpha&&delete t.explosions[e]}Karma.TopBar.setTopBar(),this.cars=[],this.explosions={},this.mycar=void 0,this.walls=[],this.drawEngine=void 0,this.socketManager=new Karma.SocketManager(this,this.onInitReceived.bind(this)),this.setUIEvents(),this.isMobile=!1,this.scoresTable=$("tbody#scores"),this.projectiles=[],this.loadCars();var t=this;setInterval(e,60)}e.prototype.loadCars=function(){var e=this,t=function(e,t,n,a){return{name:e,path:"/sprites/"+t,w:n,h:a}},n=function(t){e.carsImages[t.name]=t};this.carsImages={},n(t("c1","car.png",128,64)),n(t("c2","car2.png",82,36)),n(t("c3","car3.png",72,32)),n(t("c4","car4.png",74,34)),n(t("c5","car5.png",81,35))},e.prototype.updateScoresHTML=function(){function e(){var e=_.map(t.cars,function(e){return{score:e.s,level:e.l,name:e.playerName,highScore:e.highScore,id:e.id}});return e=_.sortBy(e,function(e){return e.score}).reverse()}for(var t=this,n=e(),a=[],o=0;n.length>o;o++){var i=n[o],s=null!==t.mycar&&t.mycar.id===i.id?"userCar":"";a.push('<tr class="',s,'"><td>',i.name,"</td><td>",i.score,"</td><td>",i.level,"</td><td>",i.highScore,"</td></tr>")}this.scoresTable.html(a.join(""))},e.prototype.updatePlayerName=function(e){this.socketManager.emit("updatePlayerName",e),Karma.LocalStorage.set("playerName",e)},e.prototype.setUIEvents=function(){var e=this;$("#playerName").keyup(function(){e.updatePlayerName($(this).val())})},e.prototype.loadImages=function(e){function t(){return o===a-1?e():(o+=1,void 0)}var n=this,a=Object.keys(this.itemsInMap).length+1,o=0,i=new Image;i.src=n.worldInfo.background.path;var s=this;i.onload=function(){var e=s.drawEngine.ctx.createPattern(this,"repeat");s.backgroundPattern=e,t()},_.each(this.itemsInMap,function(e,n){var a=new Image;a.src=e.image.path,a.onload=function(){if("none"!==e.patternType){var o=this.drawEngine.ctx.createPattern(a,"repeat");this.itemsInMap[n].pattern=o}else this.itemsInMap[n].pattern=null,this.itemsInMap[n].img=a;t()}.bind(this)}.bind(this))},e.prototype.onInitReceived=function(e,t){var n=this;this.world={},this.worldInfo=t,this.world.size=t.size,this.walls=t.staticItems,this.itemsInMap=t.itemsInMap,this.bullets=[],this.rockets=[];var a="CANVAS";n.drawEngine=Karma.getDrawEngine(n,"game-canvas",a),n.loadImages(function(){n.keyboardHandler=new Karma.KeyboardHandler(n),document.onkeydown=n.keyboardHandler.handleKeyDown.bind(n.keyboardHandler),document.onkeyup=n.keyboardHandler.handleKeyUp.bind(n.keyboardHandler),n.drawEngine.tick()})},e.prototype.addExplosion=function(e){var t=Math.random();this.explosions[t]={x:e.x,y:e.y,r:3.14/6*Math.random()-3.14,alpha:.4*Math.random()-.2+.25}},Karma.GameInstance=e}(),function(){"use strict";Karma.GameInstance.prototype.setupSound=function(){},Karma.GameInstance.prototype.setSound=function(e,t){var n;this.play_html5_audio?(n=new Audio(t),n.load()):(n=$("<embed id='"+e+"' type='audio/mpeg' />"),n.attr("src",t),n.attr("loop",!1),n.attr("hidden",!0),n.attr("autostart",!1),n.attr("enablejavascript",!0),$("body").append(n)),this.sounds[e]=n},Karma.GameInstance.prototype.play_sound=function(e){if(this.play_html5_audio){var t=new Audio(e);t.load(),t.play()}else{$("#sound").remove();var n=$("<embed type='audio/mpeg' />");n.attr("src",e),n.attr("loop",!1),n.attr("hidden",!0),n.attr("autostart",!0),$("body").append(n)}}}();