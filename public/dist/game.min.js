/*! karmaracer 2013-05-08 */
function GameInstance(){function e(){for(var e in t.explosions)t.explosions[e].alpha-=.1,0>t.explosions[e].alpha&&delete t.explosions[e]}TopBar.setTopBar(),this.cars=[],this.explosions={},this.mycar=void 0,this.walls=[],this.drawEngine=void 0,this.socketManager=new SocketManager(this,this.onInitReceived.bind(this)),this.setUIEvents(),this.isMobile=!1,this.scoresTable=$("tbody#scores"),this.projectiles=[],this.loadCars();var t=this;setInterval(e,60)}function SocketManager(e,t){function a(){var e=(new Date).getTime();e-s.timestamp>1e3&&(s.timestamp=e,$("#socketps").html("socket/ps: "+s.socketCounter),s.socketCounter=0),s.socketCounter+=1}function n(e,t,a){KLib.isUndefined(a)&&(a=""),$("#announce").remove();var n=$('<div id="announce" class=" '+a+" announce-"+t+'"><span>'+e+"</span></div>");n.appendTo($("body")),setTimeout(function(){$("#announce").fadeOut(function(){$("#announce").remove()})},4e3)}function i(e,t,a,i,o){setTimeout(function(){return n(e,t,i),KLib.isFunction(o)?o(null):void 0},1e3*a)}var o=window.location.hostname;connection=io.connect(o),this.gameInstance=e,this.init_done=!1,this.socketCounter=0,this.timestamp=(new Date).getTime(),this.msg_id=0,this.gameInstance.bodies=[];var s=this;$("#debug").append('<div id="socketps" class="info"></div>'),$("#debug").append('<div id="debug-sockets" class="info">sockets</div>'),connection.on("connect",function(){_.isUndefined(G_mapName)||(connection.emit("enter_map",G_mapName),n("Shoot them all !","blue"))}),connection.on("init",function(e){t(null,e),Karma.get("playerName")&&0!==Karma.get("playerName").length||Karma.set("playerName",prompt("Welcome to Karmaracer !\nWhat's your name ?")),connection.emit("init_done",{playerName:Karma.get("playerName")}),this.init_done=!0}),connection.on("chat_msg",function(e){var t="msg_"+s.msg_id;onChatMsgReceived(e,t),++s.msg_id}),connection.on("dead",function(){n("You' re dead !","red")}),connection.on("game end",function(e){$("table.scores").addClass("big").removeClass("default");var t=function(){$("table.scores").removeClass("big").addClass("default")};n(e.winnerName+" wins the game !!!!","black","freeze"),i("2","red",3,"freeze"),i("1","orange",4,"freeze",t),i("GO","green",5,"")}),connection.on("objects",function(t){e.cars=t.cars,e.mycar=t.myCar,e.projectiles=t.projectiles,e.collisionPoints=t.collisionPoints,e.updateScoresHTML(),$("#debug-sockets").html(JSON.stringify(_.map(t,function(e){return e?e.length:0}))),a()}),connection.on("explosion",function(t){e.addExplosion(t)}),this.connection=connection}function KeyboardHandler(e){return this.gameInstance=e,this}var KLib={};KLib.isFunction=function(e){return"function"==typeof e},KLib.isUndefined=function(e){return void 0===e},GameInstance.prototype.loadCars=function(){var e=this,t=function(e,t,a,n){return{name:e,path:"/sprites/"+t,w:a,h:n}},a=function(t){e.carsImages[t.name]=t};this.carsImages={},a(t("c1","car.png",128,64)),a(t("c2","car2.png",82,36)),a(t("c3","car3.png",72,32)),a(t("c4","car4.png",74,34)),a(t("c5","car5.png",81,35))},GameInstance.prototype.setSound=function(e,t){var a;this.play_html5_audio?(a=new Audio(t),a.load()):(a=$("<embed id='"+e+"' type='audio/mpeg' />"),a.attr("src",t),a.attr("loop",!1),a.attr("hidden",!0),a.attr("autostart",!1),a.attr("enablejavascript",!0),$("body").append(a)),this.sounds[e]=a},GameInstance.prototype.play_sound=function(e){if(this.play_html5_audio){var t=new Audio(e);t.load(),t.play()}else{$("#sound").remove();var a=$("<embed type='audio/mpeg' />");a.attr("src",e),a.attr("loop",!1),a.attr("hidden",!0),a.attr("autostart",!0),$("body").append(a)}},GameInstance.prototype.updateScoresHTML=function(){function e(){var e=_.map(t.cars,function(e){return{score:e.s,level:e.l,name:e.playerName,highScore:e.highScore,id:e.id}});return e=_.sortBy(e,function(e){return e.score}).reverse()}for(var t=this,a=e(),n=[],i=0;a.length>i;i++){var o=a[i],s=null!==t.mycar&&t.mycar.id===o.id?"userCar":"";n.push('<tr class="',s,'"><td>',o.name,"</td><td>",o.score,"</td><td>",o.level,"</td><td>",o.highScore,"</td></tr>")}this.scoresTable.html(n.join(""))},GameInstance.prototype.updatePlayerName=function(e){this.socketManager.emit("updatePlayerName",e),Karma.set("playerName",e)},GameInstance.prototype.setUIEvents=function(){var e=this;$("#playerName").keyup(function(){e.updatePlayerName($(this).val())})},GameInstance.prototype.loadImages=function(e){function t(){return i===n-1?e():(i+=1,void 0)}var a=this,n=Object.keys(this.itemsInMap).length+1,i=0,o=new Image;o.src=a.worldInfo.background.path;var s=this;o.onload=function(){var e=s.drawEngine.ctx.createPattern(this,"repeat");s.backgroundPattern=e,t()},_.each(this.itemsInMap,function(e,a){var n=new Image;n.src=e.image.path,n.onload=function(){if("none"!==e.patternType){var i=this.drawEngine.ctx.createPattern(n,"repeat");this.itemsInMap[a].pattern=i}else this.itemsInMap[a].pattern=null,this.itemsInMap[a].img=n;t()}.bind(this)}.bind(this))},GameInstance.prototype.onInitReceived=function(e,t){var a=this;this.world={},this.worldInfo=t,this.world.size=t.size,this.walls=t.staticItems,this.itemsInMap=t.itemsInMap,this.bullets=[],this.rockets=[],a.drawEngine=DrawEngineFactory(a,"game-canvas",G_defaultDrawEngineType),a.loadImages(function(){a.keyboardHandler=new KeyboardHandler(a),document.onkeydown=a.keyboardHandler.handleKeyDown.bind(a.keyboardHandler),document.onkeyup=a.keyboardHandler.handleKeyUp.bind(a.keyboardHandler),a.drawEngine.tick()})},GameInstance.prototype.addExplosion=function(e){var t=Math.random();this.explosions[t]={x:e.x,y:e.y,r:3.14/6*Math.random()-3.14,alpha:.4*Math.random()-.2+.25}},$(window).on("beforeunload",function(){connection.emit("disconnect")});var connection;SocketManager.prototype.getConnection=function(){return this.connection},SocketManager.prototype.emit=function(e,t){this.connection.emit(e,t)},$(function(){$("#addBot").click(function(){connection.emit("add bot")}),$("#removeBot").click(function(){connection.emit("remove bot")})});var SteeringWheelController=function(){};SteeringWheelController.prototype.init=function(e){function t(e){return null===e?0:(a={x:0,y:0},res=Math.atan2(e.y,e.x)-Math.atan2(a.y,a.x),_.isNaN(res)&&(res=0),res)}this.m=$('<div id="SteeringWheelController"/>'),this.acc=$('<div id="SteeringWheelControllerAcc"/>'),this.m.append(this.acc),this.enable=!1,$("body").append(this.m),this.gameInstance=e,this.gameInstance.steeringWheel=this,this.resize(),this.accSize={w:this.acc.width(),h:this.acc.height()},this.force={x:0,y:0},this.updateCenter();var n=this,i=function(){var e=$(this);e.toggleClass("enable"),n.enable=e.hasClass("enable")};n.m.click(i),$(window).resize(function(){n.resize()}),window.onorientationchange=function(){n.resize()},window.webkitfullscreenchange=function(){};var o=null,s=function(){n.enable&&n.gameInstance.socketManager.emit("move_car",{force:n.force,angle:t(n.force)})},r=function(){null===o&&(o=setInterval(s,62.5))},c=function(){clearInterval(o),o=null},l=function(e){var t={x:e.pageX,y:e.pageY};n.gameInstance.isMobile&&(t.x=e.originalEvent.touches[0].pageX,t.y=e.originalEvent.touches[0].pageY);var a=t.x-n.mCenter.x,i=t.y-n.mCenter.y;n.acc.css("left",t.x-n.m.position().left-n.accSize.w/2),n.acc.css("top",t.y-n.m.position().top-n.accSize.h/2);var o={x:a/(n.mSize.w/2),y:i/(n.mSize.h/2)},s=10;n.gameInstance.isMobile&&(s=5),o.x*=s,o.y*=s,n.force=o};console.info("is mobile",n.gameInstance.isMobile),n.gameInstance.isMobile?(n.m.bind("touchstart",r),n.m.bind("touchend",c),n.m.bind("touchmove",l),n.enable=!0):(n.m.mousemove(l),n.m.hover(r,c)),n.acc.mousemove(function(e){return e.preventDefault(),!1})},SteeringWheelController.prototype.setMSize=function(e,t){var a=this;a.m.css("width",e+"px"),a.m.css("height",t+"px"),a.mSize={w:a.m.width(),h:a.m.height()},a.updateCenter()},SteeringWheelController.prototype.updateCenter=function(){var e=this;e.mSize={w:e.m.width(),h:e.m.height()},e.mCenter={x:e.mSize.w/2+e.m.position().left,y:e.mSize.h/2+e.m.position().top}},SteeringWheelController.prototype.setMPosition=function(e,t){var a=this,n=e-a.mSize.w/2,i=t-a.mSize.h/2;a.m.css("left",n+"px"),a.m.css("top",i+"px"),a.updateCenter()},SteeringWheelController.prototype.resize=function(){this.m.css({width:"100%",height:"100%"})},KEY_ENTER=13,KEY_SPACE=32,KEY_LEFT=37,KEY_RIGHT=39,KEY_UP=38,KEY_DOWN=40,KEY_ESCAPE=27,KEY_L=76,KEY_P=80,KEY_B=66,KeyboardHandler.prototype.sendKeyboardEvent=function(e,t){connection&&connection.emit("drive",e,t)},KeyboardHandler.prototype.handleKey=function(e,t){switch(e){case KEY_B:this.sendKeyboardEvent("break",t);break;case KEY_SPACE:this.sendKeyboardEvent("shoot",t);break;case KEY_LEFT:this.sendKeyboardEvent("left",t);break;case KEY_RIGHT:this.sendKeyboardEvent("right",t);break;case KEY_UP:this.sendKeyboardEvent("forward",t);break;case KEY_DOWN:this.sendKeyboardEvent("backward",t);break;case KEY_L:"start"==t&&(this.gameInstance.drawEngine.camera.scale*=1.05);break;case KEY_P:"start"==t&&(this.gameInstance.drawEngine.camera.scale*=.95);break;default:}},KeyboardHandler.prototype.handleKeyDown=function(e){switch(e.keyCode){case KEY_ESCAPE:clearChatInputField(),hideChat();break;case KEY_UP:case KEY_DOWN:$("#chat_input").is(":focus")&&hideChat(),this.handleKey(e.keyCode,"start");break;case KEY_ENTER:$("#chat_input").is(":focus")?sendMsg():showChat();break;case KEY_L:case KEY_P:case KEY_SPACE:$("#chat_input").is(":focus")||this.handleKey(e.keyCode,"start");break;default:this.handleKey(e.keyCode,"start")}},KeyboardHandler.prototype.handleKeyUp=function(e){this.handleKey(e.keyCode,"end")},document.ontouchstart=function(e){e.preventDefault()};var G_gameInstance;Modernizr.load([{load:"/js/libs/jquery-1.6.4.min.js",complete:function(){Modernizr.load([{test:$("html.touch").length,yep:["/js/mobile.js","/js/mobile_compatibility.js","/css/mobile.css"],nope:["css/no-touch.css"],complete:function(){if(G_gameInstance=new GameInstance,"function"==typeof MobileTerminalHandler){var e=new MobileTerminalHandler(G_gameInstance);e.init()}new SteeringWheelController(G_gameInstance)}}])}}]);