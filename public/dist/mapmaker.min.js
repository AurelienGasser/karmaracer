/*! karmaracer 2013-05-10 */
(function(){"use strict";function t(t,e,i){this.id=i,this.jsonItem=t,this.position={x:0,y:0},this.size={w:this.jsonItem.image.size,h:this.jsonItem.image.size},this.name=this.jsonItem.name,this.patternType=this.jsonItem.patternType,this.pattern=void 0,this.zIndex=0,this.path=this.jsonItem.image.path,this.ctx=e,this.image=null}t.prototype.initImage=function(t){this.image=new Image,this.image.src=this.jsonItem.image.path,this.image.crop=this.jsonItem.image.crop;var e=this;e.image.onerror=function(){},e.image.onload=function(){return"none"===e.patternType||KLib.isUndefined(e.ctx)||(e.pattern=e.ctx.createPattern(e.image,"repeat")),t(null,e)}},t.prototype.scale=function(t,e,i){var s,a=t.x-e.x,n=t.y-e.y;if(i.shift){var o=Math.min(a,n);s={x:o,y:o}}else s={x:a,y:n};"vertical"==this.patternType?this.size.w=this.image.crop.w:this.size.w+=s.x,"horizontal"==this.patternType?this.size.h=this.image.crop.h:this.size.h+=s.y,this.size.w=Math.max(this.size.w,1),this.size.h=Math.max(this.size.h,1)},Karma.MapItem=t})(),function(){"use strict";function t(t){e(t),s(t),i(t)}function e(t){var e=$("#map-name");e.keyup(function(){t.mapName=e.val(),t.loadMap(t.mapName)}),e.val(t.mapName)}function i(t){function e(){var e=parseInt(i.val(),10)*t.gScale,a=parseInt(s.val(),10)*t.gScale;t.realWorldSize.w=e,t.realWorldSize.h=a,t.resize()}var i=$("#map-width"),s=$("#map-height");i.change(e),s.change(e)}function s(t){var e=$("#map-bg"),i=[];i.push('<datalist id="bg-list">');for(var s=0;t.backgroundItems.length>s;s++){var a=t.backgroundItems[s];i.push('<option value="',a.name,'">'),i.push(a.name,"</option>")}i.push("</datalist>"),e.after(i.join("")),e.keyup(function(){t.mapBackgroundName=e.val(),t.svgDrawBackground()}),e.val(t.mapBackgroundName)}function a(){var e="map-canvas",i=new Karma.Map("#"+e);i.connection.emit("get_items",function(s,a){var n=[];for(var o in a)n.push(a[o]);i.loadItems(n,function(){i.loadMap(i.mapName,function(){t(i),i.svgInit(e)})})}),$("#save-map-node").click(function(){i.saveMap()})}$(function(){a()})}(),function(t){"use strict";function e(e){var i=window.location.hostname;this.connection=t.connect(i),this.MapItems={},this.selectedItems=[],this.canvasMousePosition={x:0,y:0},this.mouseDownPosition={x:0,y:0},this.translateMousePosition={x:0,y:0},this.idCount=0,this.keyPress={shift:!1},this.selectedZone={x:0,y:0,w:0,h:0},this.keyboardHandler=new Karma.KeyboardHandlerMap(this),this.scale=1,this.gScale=16,this.translate={x:0,y:0},this.realWorldSize={w:64*this.gScale,h:32*this.gScale},this.mapName=G_mapName,this.mapBackgroundName="",this.itemsByName={},this.zoomBox=null,this.enable=!1,this.backgroundItems=[],this.$map=$(e),this.$map.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h),this.itemsGlow={}}function i(t,e,i){function s(){return n===a-1&&_.isFunction(i)?i(null):(n+=1,void 0)}for(var a=t.length,n=0,o=0;t.length>o;o++){var c=t[o];e(c,s)}}e.prototype.resize=function(){this.$map.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h)},e.prototype.loadMap=function(t,e){var i=this;i.connection.emit("get_map",t,function(s,a){if(null!==s)return Karma.Log.error("no map with name",t),e({msg:"no map with name",type:"warn"});i.mapBackgroundName=a.background.name,i.enable=a.enable,$("#map-width").val(a.size.w),$("#map-height").val(a.size.h);var n=$("#map-enable");a.enable===!0&&n.prop("checked",!0),n.click(function(){i.enable=this.checked}),i.realWorldSize.w=a.size.w*i.gScale,i.realWorldSize.h=a.size.h*i.gScale,i.resize();for(var o=0;a.staticItems.length>o;o++){var c=a.staticItems[o],r=i.itemsByName[c.name],h=i.createMapItem(r);h.position.x=c.position.x*i.gScale,h.position.y=c.position.y*i.gScale,h.size.w=c.size.w*i.gScale,h.size.h=c.size.h*i.gScale}return _.isFunction(e)?e(null):void 0})},e.prototype.startTick=function(){var t=new Date;this.tickStart=t.getTime(),this.tickCount=0,this.tick()},e.prototype.outputDebug=function(){var t=[];t.push("<li>Canvas Mouse Pos : ",this.canvasMousePosition.x,", ",this.canvasMousePosition.y,"</li>"),t.push("<li>Canvas Down Pos : ",this.mouseDownPosition.x,", ",this.mouseDownPosition.y,"</li>"),t.push("<li>Translate Down Pos : ",this.translateMousePosition.x,", ",this.translateMousePosition.y,"</li>"),t.push("<li>Action : ",this.action,"</li>"),t.push("<li>ScaleCanvas : ",this.scale,"</li>"),t.push("<li>TranslateCanvas : ",this.translate.x,", ",this.translate.y,"</li>"),t.push("<li>--------</li>"),t.push("<li>Help</li>"),t.push("<li>Arrows (move canvas)</li>"),t.push("<li>R (release items)</li>"),t.push("<li>P/L (zoom/unzoom)</li>"),t.push("<li>S (set scale to 1)</li>"),t.push("<li>Z (zoom to selected items)</li>"),$("#canvas-debug").html(t.join(""))},e.prototype.tick=function(){this.tickCount++;var t=new Date,e=t.getTime()-this.tickStart;e>1e3&&($("#fps").html("fps:"+this.tickCount),this.tickCount=0,this.tickStart=t.getTime()),requestAnimFrame(this.tick.bind(this)),this.outputDebug()},e.prototype.loadItems=function(t,e){var s=this;i(t,function(t,e){s.loadItemFromServer(t,function(){return e()})},e)},e.prototype.addMapItemInDoForSelection=function(t,e){function i(){c.css("background-image",'url("'+e.image.src+'")')}var s=this,a="item-"+e.name,n=$('<li class="item" id="'+a+'"></li>'),o=$('<ul class="item-properties"/>');n.append(o);var c=$('<li class="kr-mm-demo"/>');switch(e.patternType){case"both":var r={name:e.name,path:e.image.src};s.backgroundItems.push(r),i();break;case"horizontal":i();break;case"vertical":i();break;default:c.append('<img class="kr-item-demo" src="'+e.image.src+'"/>')}c.addClass("kr-mm-demo-"+e.patternType),o.append('<li class="kr-pp-item-name">'+e.name+"</li>"),o.append(c),t.append(n),$("#"+a).click(function(){var t=s.itemsByName[e.name];Karma.Log.info("add map item",t);var i=s.createMapItem(t);i.size.w=t.size.w*s.gScale,i.size.h=t.size.h*s.gScale,s.svgRaphaelAddItem(i)})},e.prototype.createMapItem=function(t){var e=this,i=e.idCount++,s=new Karma.MapItem(t,e.ctx,i);return s.image=t.image,s.pattern=t.pattern,e.MapItems[i]=s,s},e.prototype.removeMapItem=function(t){delete this.MapItems[t]},e.prototype.loadItemFromServer=function(t,e){var i=this,s=$("#items");if(_.isFunction(e)){var a=new Karma.MapItem(t,i.ctx,t.name);a.initImage(function(t,n){return i.addMapItemInDoForSelection(s,n),i.itemsByName[a.name]=n,e(null,n)})}},Karma.Map=e}(io),function(t){"use strict";t.prototype.startTranslating=function(){this.action="translate",this.translateMousePosition=this.mouseDownPosition},t.prototype.translateSelectedItemsUsingMousePosition=function(){var t={x:this.canvasMousePosition.x-this.translateMousePosition.x,y:this.canvasMousePosition.y-this.translateMousePosition.y};_.each(this.selectedItems,function(e){var i=this.MapItems[e];i.position={x:i.position.x+t.x,y:i.position.y+t.y}}.bind(this)),this.translateMousePosition=this.canvasMousePosition},t.prototype.startScaling=function(){this.action="scale",this.scaleMousePosition=this.mouseDownPosition},t.prototype.scaleItemsUsingCanvasMouse=function(){_.each(this.selectedItems,function(t){var e=this.MapItems[t];e.scale(this.canvasMousePosition,this.scaleMousePosition,this.keyPress)}.bind(this)),this.scaleMousePosition=this.canvasMousePosition}}(Karma.Map),function(t){"use strict";t.prototype.canvasInit=function(t){var e="canvas-map";this.canvasTag=$('<canvas id="'+e+'"/>'),$(t).append(this.canvasTag),this.canvas=$(t).children("canvas")[0],this.ctx=this.canvas.getContext("2d"),this.canvas.onmousemove=this.mouseMove.bind(this),this.canvas.onmousedown=this.mouseDown.bind(this),this.canvas.onmouseup=this.mouseUp.bind(this),this.canvasTag.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h)},t.prototype.canvasDrawBackground=function(){if(""!==this.mapBackgroundName){var t=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(t)||(this.ctx.fillStyle=t.pattern,this.ctx.fillRect(0,0,this.realWorldSize.w,this.realWorldSize.h))}},t.prototype.canvasDraw=function(){this.ctx.canvas.width=$(this.canvas).width(),this.ctx.canvas.height=$(this.canvas).height(),this.ctx.save(),this.ctx.scale(this.scale,this.scale),this.canvasDrawBackground(),this.ctx.fillStyle="00f",this.ctx.strokeRect(0,0,this.realWorldSize.w,this.realWorldSize.h),this.ctx.translate(this.translate.x,this.translate.y),this.ctx.scale(this.scale,this.scale);for(var t in this.MapItems){var e=this.MapItems[t];this.canvasDrawItem(e)}"selectZone"==this.action&&this.canvasDrawSelectedZone(),this.ctx.restore(),null!==this.zoomBox&&(this.scale=this.realWorldSize.w*this.scale/this.zoomBox.w,this.translate.x=-this.zoomBox.x*this.scale,this.translate.y=-this.zoomBox.y*this.scale,this.zoomBox=null)},t.prototype.canvasDrawItem=function(t){var e=_.include(this.selectedItems,t.id);e?(this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2,this.ctx.shadowBlur=4,this.ctx.shadowColor="rgba(0, 0, 0, 0.5)"):(this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0),"none"!==t.patternType?(this.ctx.fillStyle=t.pattern,this.ctx.save(),this.ctx.translate(t.position.x,t.position.y),this.ctx.fillRect(0,0,t.size.w,t.size.h),this.ctx.restore()):this.ctx.drawImage(t.image,t.position.x,t.position.y,t.size.w,t.size.h),e&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(t.position.x+.8*t.size.w,t.position.y+.8*t.size.h,.2*t.size.w,.2*t.size.h))},t.prototype.canvasDrawSelectedZone=function(){this.selectedZone.x=this.mouseDownPosition.x,this.selectedZone.y=this.mouseDownPosition.y,this.selectedZone.w=this.canvasMousePosition.x-this.mouseDownPosition.x,this.selectedZone.h=this.canvasMousePosition.y-this.mouseDownPosition.y,0>this.selectedZone.w&&(this.selectedZone.x+=this.selectedZone.w,this.selectedZone.w*=-1),0>this.selectedZone.h&&(this.selectedZone.y+=this.selectedZone.h,this.selectedZone.h*=-1),this.ctx.strokeStyle="f00",this.ctx.strokeRect(this.selectedZone.x,this.selectedZone.y,this.selectedZone.w,this.selectedZone.h)}}(Karma.Map||{}),function(t){"use strict";t.prototype.svgRaphaelAddItem=function(t){function e(t){var e=$('<div><a href="#">'+t+"</a></div>");return e}function i(t){var i=e(t);i.click(function(e){return"toFront"===t?(o[t](),r[t]()):(r[t](),o[t](),s.bgImg.toBack()),e.preventDefault(),!1}),h.append(i)}t.position.x-=t.size.w/2,t.position.y-=t.size.h/2;var s=this,a=1,n=.5,o=this.R.rect(t.position.x,t.position.y,t.size.w,t.size.h).attr({fill:"url('"+t.image.src+"')",stroke:"none",opacity:a,cursor:"move"}),c=32,r=this.R.rect(t.position.x+t.size.w-c,t.position.y+t.size.h-c,c,c).attr({fill:"hsb(0.8, 0.5, .5)",stroke:"none",opacity:a}),h=$("<li></li>");i("toFront"),i("toBack");var l=e("removeItem");h.append(l),l.click(function(){s.removeMapItem(t.id),$(o.node).remove(),$(r.node).remove()}),o.li=h,$("#canvas-debug").append(h),$("#canvas-debug").children().hide();var m=function(){this.ox=this.attr("x"),this.oy=this.attr("y"),this.attr({opacity:n}),this.sizer.ox=this.sizer.attr("x"),this.sizer.oy=this.sizer.attr("y"),this.sizer.attr({opacity:a})},p=function(e,i){this.attr({x:this.ox+e,y:this.oy+i}),t.position.x=this.ox+e,t.position.y=this.oy+i,this.sizer.attr({x:this.sizer.ox+e,y:this.sizer.oy+i}),0>t.position.x&&(t.position.x=0),0>t.position.y&&(t.position.y=0)},d=function(){this.attr({opacity:a}),this.sizer.attr({opacity:a})},u=function(){this.ox=this.attr("x"),this.oy=this.attr("y"),this.box.ow=this.box.attr("width"),this.box.oh=this.box.attr("height")},y=function(e,i){this.attr({x:this.ox+e,y:this.oy+i}),this.box.attr({width:this.box.ow+e,height:this.box.oh+i}),t.size.w=this.box.attr("width"),t.size.h=this.box.attr("height")};return $(o.node).click(function(e){return $("#canvas-debug").children().hide(),o.li.show(),h.find("div.mm-clean").remove(),h.append('<div class="mm-clean">pos : '+JSON.stringify(t.position)+"</div>"),h.append('<div class="mm-clean">size : '+JSON.stringify(t.size)+"</div>"),e.preventDefault(),!1}),o.drag(p,m,d),o.sizer=r,r.drag(y,u),r.box=o,o},t.prototype.svgInit=function(t){this.R=new Raphael(t,this.realWorldSize.w,this.realWorldSize.h),$(this.R.canvas).click(function(t){return $("#canvas-debug").children().hide(),t.preventDefault(),!1}),this.svgLoad()},t.prototype.svgLoad=function(){this.svgDraw()},t.prototype.svgDraw=function(){this.svgDrawBackground();for(var t in this.MapItems){var e=this.MapItems[t];this.svgRaphaelAddItem(e)}},t.prototype.svgDrawBackground=function(){if(KLib.isUndefined(this.bgImg)||$(this.bgImg.node).remove(),""!==this.mapBackgroundName){var t=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(t)||(this.bgImg=this.R.rect(0,0,this.realWorldSize.w,this.realWorldSize.h),this.bgImg.attr({fill:"url('"+t.path+"')"}))}}}(Karma.Map||{}),function(){"use strict";function t(t){this.canvasMap=t,document.onkeydown=this.handleKeyDown.bind(this),document.onkeyup=this.handleKeyUp.bind(this)}t.prototype.handleKey=function(t,e){switch(t){case 37:this.canvasMap.translate.x+=5;break;case 39:this.canvasMap.translate.x-=5;break;case 38:this.canvasMap.translate.y+=5;break;case 40:this.canvasMap.translate.y-=5;break;case 90:if(!e)break;this.canvasMap.zoomToSelectedItems();break;case 83:if(!e)break;this.canvasMap.scale=1,this.canvasMap.translate={x:0,y:0};break;case 76:if(!e)break;this.canvasMap.scale*=1.1;break;case 77:this.canvasMap.actionTranslate=e,e&&(this.canvasMap.mouseDownPosition=this.canvasMap.canvasMousePosition);break;case 80:if(!e)break;this.canvasMap.scale*=.9;break;case 82:e&&this.canvasMap.deselectAllItems();break;case 16:this.canvasMap.keyPress.shift=e;break;default:}},t.prototype.handleKeyDown=function(t){this.handleKey(t.keyCode,!0)},t.prototype.handleKeyUp=function(t){this.handleKey(t.keyCode,!1)},Karma.KeyboardHandlerMap=t}(),function(t){"use strict";t.prototype.mouseDown=function(){this.mouseDownPosition=this.canvasMousePosition,this.action="",this.keyPress.shift?_.each(this.MapItems,function(t){this.isMousePositionInItem(t)&&(this.isItemSelected(t.id)?this.deselectItem(t.id):this.selectItem(t.id))}.bind(this)):(_.each(this.MapItems,function(t){this.isMousePositionInItem(t)&&(this.isItemSelected(t.id)||(this.deselectAllItems(),this.selectItem(t.id)),this.mouseDownOnItem=t,this.mouseDownInItemScaleZone(t,.8)?this.startScaling():this.startTranslating())}.bind(this)),"translate"!=this.action&&"scale"!=this.action&&(this.deselectAllItems(),this.action="selectZone"))},t.prototype.mouseMove=function(t){this.canvasMousePosition={x:t.pageX-this.canvas.offsetLeft-this.translate.x,y:t.pageY-this.canvas.offsetTop-this.translate.y},this.canvasMousePosition.x*=1/this.scale,this.canvasMousePosition.y*=1/this.scale;var e="s-resize";if("scale"==this.action)document.body.style.cursor=e;else{var i=!1;_.each(this.MapItems,function(t){i||this.mouseDownInItemScaleZone(t,.9)&&(i=!0)}.bind(this)),document.body.style.cursor=i?e:"default"}if(0===t.button&&1===t.which)switch(this.action){case"translate":this.translateSelectedItemsUsingMousePosition();break;case"scale":this.scaleItemsUsingCanvasMouse()}},t.prototype.mouseUp=function(){switch(this.action){case"selectZone":this.selectItemsInSelectedZone();break;case"scale":case"translate":break;default:}this.action=""}}(Karma.Map),function(t){"use strict";t.prototype.saveMap=function(){var t=this,e=this.realWorldSize.w,i=this.realWorldSize.h,s={name:$("#map-name").val(),enable:t.enable,size:{w:parseInt(e/this.gScale,10),h:i/this.gScale}},a="/sprites/bg_grass1.png",n=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(n)||(a=n.path),KLib.isUndefined(a)||(s.background={path:a,name:this.mapBackgroundName}),s.staticItems=[],$.each(this.MapItems,function(e,i){var a={};a.name=i.name,a.position={x:(i.position.x+i.size.w/2)/t.gScale,y:(i.position.y+i.size.h/2)/t.gScale},a.size={w:parseInt(i.size.w/t.gScale,10),h:parseInt(i.size.h/t.gScale,10)},s.staticItems.push(a)}),this.connection.emit("saveMap",s)}}(Karma.Map),function(t){"use strict";t.prototype.zoomToSelectedItems=function(){var t,e,i,s;_.each(this.selectedItems,function(a){var n=this.MapItems[a];t===void 0&&(t=n),e===void 0&&(e=n),i===void 0&&(i=n),s===void 0&&(s=n),n.position.x<t.position.x&&(t=n),n.position.x+n.size.w>e.position.x+e.size.w&&(e=n),n.position.y<i.position.y&&(i=n),n.position.y+n.size.h>s.position.y+s.size.h&&(s=n)}.bind(this));var a=20;this.selectedItems.length>0&&(this.zoomBox={x:t.position.x-a,y:i.position.y-a,w:e.position.x+e.size.w-t.position.x+2*a,h:s.position.y+s.size.h-i.position.y+2*a})},t.prototype.mouseDownInItemScaleZone=function(t,e){return this.canvasMousePosition.x<t.position.x+t.size.w*e?!1:this.canvasMousePosition.x>t.position.x+t.size.w?!1:this.canvasMousePosition.y<t.position.y+t.size.h*e?!1:this.canvasMousePosition.y>t.position.y+t.size.h?!1:!0},t.prototype.selectItemsInSelectedZone=function(){_.each(this.MapItems,function(t){t.position.x<this.selectedZone.x||t.position.y<this.selectedZone.y||t.position.x+t.size.w>this.selectedZone.x+this.selectedZone.w||t.position.y+t.size.h>this.selectedZone.y+this.selectedZone.h||this.selectItem(t.id)}.bind(this))},t.prototype.isMousePositionInItem=function(t){return this.canvasMousePosition.x<t.position.x?!1:this.canvasMousePosition.x>t.position.x+t.size.w?!1:this.canvasMousePosition.y<t.position.y?!1:this.canvasMousePosition.y>t.position.y+t.size.h?!1:!0},t.prototype.deselectAllItems=function(){for(var t in this.itemsGlow)this.deselectItem(t);this.selectedItems=[]},t.prototype.isItemSelected=function(t){return _.include(this.selectedItems,t)},t.prototype.selectItem=function(t,e){this.selectedItems.push(t),KLib.isUndefined(e)||(e.isSelected=!0,this.itemsGlow[t]=e,$(e).attr("stroke","#000"),$(e.rectSelected).show())},t.prototype.deselectItem=function(t){this.selectedItems.splice(this.selectedItems.indexOf(t),1);var e=this.itemsGlow[t];KLib.isUndefined(e)||(e.isSelected=!1,$(e.rectSelected).hide(),$(e).attr("stroke","transparent"))}}(Karma.Map);