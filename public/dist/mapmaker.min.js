/*! karmaracer 2013-05-08 */
function MapItem(e,t,i){this.id=i,this.jsonItem=e,this.position={x:0,y:0},this.size={w:this.jsonItem.image.size,h:this.jsonItem.image.size},this.name=this.jsonItem.name,this.patternType=this.jsonItem.patternType,this.pattern=void 0,this.zIndex=0,this.path=this.jsonItem.image.path,this.ctx=t,this.image=null}function addProperties(e){setNameEvents(e),setBackgroundItemsEvents(e),setSizeEvents(e)}function setNameEvents(e){var t=$("#map-name");t.keyup(function(){e.mapName=t.val(),e.loadMap(e.mapName)}),t.val(e.mapName)}function setSizeEvents(e){function t(){var t=parseInt(i.val(),10)*e.gScale,a=parseInt(s.val(),10)*e.gScale;e.realWorldSize.w=t,e.realWorldSize.h=a,e.resize()}var i=$("#map-width"),s=$("#map-height");i.change(t),s.change(t)}function setBackgroundItemsEvents(e){var t=$("#map-bg"),i=[];i.push('<datalist id="bg-list">');for(var s=0;e.backgroundItems.length>s;s++){var a=e.backgroundItems[s];i.push('<option value="',a.name,'">'),i.push(a.name,"</option>")}i.push("</datalist>"),t.after(i.join("")),t.keyup(function(){e.mapBackgroundName=t.val(),e.svgDrawBackground()}),t.val(e.mapBackgroundName)}function start(){var e="map-canvas",t=new Map("#"+e);t.connection.emit("get_items",function(i,s){var a=[];for(var n in s)a.push(s[n]);t.loadItems(a,function(){t.loadMap(t.mapName,function(){addProperties(t),t.svgInit(e)})})}),$("#save-map-node").click(function(){t.saveMap()})}function Map(e){var t=window.location.hostname;this.connection=io.connect(t),this.MapItems={},this.selectedItems=[],this.canvasMousePosition={x:0,y:0},this.mouseDownPosition={x:0,y:0},this.translateMousePosition={x:0,y:0},this.idCount=0,this.keyPress={shift:!1},this.selectedZone={x:0,y:0,w:0,h:0},this.keyboardHandler=new KeyboardHandlerMap(this),this.scale=1,this.gScale=16,this.translate={x:0,y:0},this.realWorldSize={w:64*this.gScale,h:32*this.gScale},this.mapName=G_mapName,this.mapBackgroundName="",this.itemsByName={},this.zoomBox=null,this.enable=!1,this.backgroundItems=[],this.$map=$(e),this.$map.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h),this.itemsGlow={}}function Step(e,t,i){function s(){return n===a-1&&_.isFunction(i)?i(null):(n+=1,void 0)}for(var a=e.length,n=0,o=0;e.length>o;o++){var r=e[o];t(r,s)}}function createSVGElement(e){var t="http://www.w3.org/2000/svg",i=document.createElementNS(t,e);return i}function KeyboardHandlerMap(e){this.canvasMap=e,document.onkeydown=this.handleKeyDown.bind(this),document.onkeyup=this.handleKeyUp.bind(this)}MapItem.prototype.initImage=function(e){this.image=new Image,this.image.src=this.jsonItem.image.path,this.image.crop=this.jsonItem.image.crop;var t=this;t.image.onerror=function(){console.error("error on load image",this.src)},t.image.onload=function(){return"none"===t.patternType||KLib.isUndefined(t.ctx)||(t.pattern=t.ctx.createPattern(t.image,"repeat")),e(null,t)}},MapItem.prototype.scale=function(e,t,i){var s,a=e.x-t.x,n=e.y-t.y;if(i.shift){var o=Math.min(a,n);s={x:o,y:o}}else s={x:a,y:n};"vertical"==this.patternType?this.size.w=this.image.crop.w:this.size.w+=s.x,"horizontal"==this.patternType?this.size.h=this.image.crop.h:this.size.h+=s.y,this.size.w=Math.max(this.size.w,1),this.size.h=Math.max(this.size.h,1)},$(function(){start()}),Map.prototype.resize=function(){this.$map.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h)},Map.prototype.loadMap=function(e,t){var i=this;i.connection.emit("get_map",e,function(s,a){if(null!==s)return console.error("no map with name",e),t({msg:"no map with name",type:"warn"});i.mapBackgroundName=a.background.name,i.enable=a.enable,$("#map-width").val(a.size.w),$("#map-height").val(a.size.h),$enable=$("#map-enable"),a.enable===!0&&$enable.prop("checked",!0),$enable.click(function(){i.enable=this.checked}),i.realWorldSize.w=a.size.w*i.gScale,i.realWorldSize.h=a.size.h*i.gScale,i.resize();for(var n=0;a.staticItems.length>n;n++){var o=a.staticItems[n],r=i.itemsByName[o.name],c=i.createMapItem(r);c.position.x=o.position.x*i.gScale,c.position.y=o.position.y*i.gScale,c.size.w=o.size.w*i.gScale,c.size.h=o.size.h*i.gScale}return _.isFunction(t)?t(null):void 0})},Map.prototype.startTick=function(){var e=new Date;this.tickStart=e.getTime(),this.tickCount=0,this.tick()},Map.prototype.outputDebug=function(){var e=[];e.push("<li>Canvas Mouse Pos : ",this.canvasMousePosition.x,", ",this.canvasMousePosition.y,"</li>"),e.push("<li>Canvas Down Pos : ",this.mouseDownPosition.x,", ",this.mouseDownPosition.y,"</li>"),e.push("<li>Translate Down Pos : ",this.translateMousePosition.x,", ",this.translateMousePosition.y,"</li>"),e.push("<li>Action : ",this.action,"</li>"),e.push("<li>ScaleCanvas : ",this.scale,"</li>"),e.push("<li>TranslateCanvas : ",this.translate.x,", ",this.translate.y,"</li>"),e.push("<li>--------</li>"),e.push("<li>Help</li>"),e.push("<li>Arrows (move canvas)</li>"),e.push("<li>R (release items)</li>"),e.push("<li>P/L (zoom/unzoom)</li>"),e.push("<li>S (set scale to 1)</li>"),e.push("<li>Z (zoom to selected items)</li>"),$("#canvas-debug").html(e.join(""))},Map.prototype.tick=function(){this.tickCount++;var e=new Date,t=e.getTime()-this.tickStart;t>1e3&&($("#fps").html("fps:"+this.tickCount),this.tickCount=0,this.tickStart=e.getTime()),requestAnimFrame(this.tick.bind(this)),this.outputDebug()},Map.prototype.loadItems=function(e,t){var i=this;Step(e,function(e,t){i.loadItemFromServer(e,function(){return t()})},t)},Map.prototype.addMapItemInDoForSelection=function(e,t){function i(){r.css("background-image",'url("'+t.image.src+'")')}var s=this,a="item-"+t.name,n=$('<li class="item" id="'+a+'"></li>'),o=$('<ul class="item-properties"/>');n.append(o);var r=$('<li class="kr-mm-demo"/>');switch(t.patternType){case"both":var c={name:t.name,path:t.image.src};s.backgroundItems.push(c),i();break;case"horizontal":i();break;case"vertical":i();break;default:r.append('<img class="kr-item-demo" src="'+t.image.src+'"/>')}r.addClass("kr-mm-demo-"+t.patternType),o.append('<li class="kr-pp-item-name">'+t.name+"</li>"),o.append(r),e.append(n),$("#"+a).click(function(){var e=s.itemsByName[t.name];console.info("add map item",e);var i=s.createMapItem(e);i.size.w=e.size.w*s.gScale,i.size.h=e.size.h*s.gScale,s.svgRaphaelAddItem(i)})},Map.prototype.createMapItem=function(e){var t=this,i=t.idCount++,s=new MapItem(e,t.ctx,i);return s.image=e.image,s.pattern=e.pattern,t.MapItems[i]=s,s},Map.prototype.removeMapItem=function(e){delete this.MapItems[e]},Map.prototype.loadItemFromServer=function(e,t){var i=this,s=$("#items");if(_.isFunction(t)){var a=new MapItem(e,i.ctx,e.name);a.initImage(function(e,n){return i.addMapItemInDoForSelection(s,n),i.itemsByName[a.name]=n,t(null,n)})}},Map.prototype.startTranslating=function(){this.action="translate",this.translateMousePosition=this.mouseDownPosition},Map.prototype.translateSelectedItemsUsingMousePosition=function(){var e={x:this.canvasMousePosition.x-this.translateMousePosition.x,y:this.canvasMousePosition.y-this.translateMousePosition.y};_.each(this.selectedItems,function(t){var i=this.MapItems[t];i.position={x:i.position.x+e.x,y:i.position.y+e.y}}.bind(this)),this.translateMousePosition=this.canvasMousePosition},Map.prototype.startScaling=function(){this.action="scale",this.scaleMousePosition=this.mouseDownPosition},Map.prototype.scaleItemsUsingCanvasMouse=function(){_.each(this.selectedItems,function(e){var t=this.MapItems[e];t.scale(this.canvasMousePosition,this.scaleMousePosition,this.keyPress)}.bind(this)),this.scaleMousePosition=this.canvasMousePosition},Map.prototype.canvasInit=function(e){var t="canvas-map";this.canvasTag=$('<canvas id="'+t+'"/>'),$(e).append(this.canvasTag),this.canvas=$(e).children("canvas")[0],this.ctx=this.canvas.getContext("2d"),this.canvas.onmousemove=this.mouseMove.bind(this),this.canvas.onmousedown=this.mouseDown.bind(this),this.canvas.onmouseup=this.mouseUp.bind(this),this.canvasTag.css("width",this.realWorldSize.w).css("height",this.realWorldSize.h)},Map.prototype.canvasDrawBackground=function(){if(""!==this.mapBackgroundName){var e=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(e)||(this.ctx.fillStyle=e.pattern,this.ctx.fillRect(0,0,this.realWorldSize.w,this.realWorldSize.h))}},Map.prototype.canvasDraw=function(){this.ctx.canvas.width=$(this.canvas).width(),this.ctx.canvas.height=$(this.canvas).height(),this.ctx.save(),this.ctx.scale(this.scale,this.scale),this.canvasDrawBackground(),this.ctx.fillStyle="00f",this.ctx.strokeRect(0,0,this.realWorldSize.w,this.realWorldSize.h),this.ctx.translate(this.translate.x,this.translate.y),this.ctx.scale(this.scale,this.scale);for(var e in this.MapItems){var t=this.MapItems[e];this.canvasDrawItem(t)}"selectZone"==this.action&&this.canvasDrawSelectedZone(),this.ctx.restore(),null!==this.zoomBox&&(this.scale=this.realWorldSize.w*this.scale/this.zoomBox.w,this.translate.x=-this.zoomBox.x*this.scale,this.translate.y=-this.zoomBox.y*this.scale,this.zoomBox=null)},Map.prototype.canvasDrawItem=function(e){var t=_.include(this.selectedItems,e.id);t?(this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2,this.ctx.shadowBlur=4,this.ctx.shadowColor="rgba(0, 0, 0, 0.5)"):(this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0),"none"!==e.patternType?(this.ctx.fillStyle=e.pattern,this.ctx.save(),this.ctx.translate(e.position.x,e.position.y),this.ctx.fillRect(0,0,e.size.w,e.size.h),this.ctx.restore()):this.ctx.drawImage(e.image,e.position.x,e.position.y,e.size.w,e.size.h),t&&(this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.fillRect(e.position.x+.8*e.size.w,e.position.y+.8*e.size.h,.2*e.size.w,.2*e.size.h))},Map.prototype.canvasDrawSelectedZone=function(){this.selectedZone.x=this.mouseDownPosition.x,this.selectedZone.y=this.mouseDownPosition.y,this.selectedZone.w=this.canvasMousePosition.x-this.mouseDownPosition.x,this.selectedZone.h=this.canvasMousePosition.y-this.mouseDownPosition.y,0>this.selectedZone.w&&(this.selectedZone.x+=this.selectedZone.w,this.selectedZone.w*=-1),0>this.selectedZone.h&&(this.selectedZone.y+=this.selectedZone.h,this.selectedZone.h*=-1),this.ctx.strokeStyle="f00",this.ctx.strokeRect(this.selectedZone.x,this.selectedZone.y,this.selectedZone.w,this.selectedZone.h)},Map.prototype.svgRaphaelAddItem=function(e){function t(e){var t=$('<div><a href="#">'+e+"</a></div>");return t}function i(e){var i=t(e);i.click(function(t){return"toFront"===e?(o[e](),c[e]()):(c[e](),o[e](),s.bgImg.toBack()),t.preventDefault(),!1}),h.append(i)}e.position.x-=e.size.w/2,e.position.y-=e.size.h/2;var s=this,a=1,n=.5,o=this.R.rect(e.position.x,e.position.y,e.size.w,e.size.h).attr({fill:"url('"+e.image.src+"')",stroke:"none",opacity:a,cursor:"move"}),r=32,c=this.R.rect(e.position.x+e.size.w-r,e.position.y+e.size.h-r,r,r).attr({fill:"hsb(0.8, 0.5, .5)",stroke:"none",opacity:a}),h=$("<li></li>");i("toFront"),i("toBack");var l=t("removeItem");h.append(l),l.click(function(){s.removeMapItem(e.id),$(o.node).remove(),$(c.node).remove()}),o.li=h,$("#canvas-debug").append(h),$("#canvas-debug").children().hide();var p=function(){this.ox=this.attr("x"),this.oy=this.attr("y"),this.attr({opacity:n}),this.sizer.ox=this.sizer.attr("x"),this.sizer.oy=this.sizer.attr("y"),this.sizer.attr({opacity:a})},m=function(t,i){this.attr({x:this.ox+t,y:this.oy+i}),e.position.x=this.ox+t,e.position.y=this.oy+i,this.sizer.attr({x:this.sizer.ox+t,y:this.sizer.oy+i}),0>e.position.x&&(e.position.x=0),0>e.position.y&&(e.position.y=0)},d=function(){this.attr({opacity:a}),this.sizer.attr({opacity:a})},u=function(){this.ox=this.attr("x"),this.oy=this.attr("y"),this.box.ow=this.box.attr("width"),this.box.oh=this.box.attr("height")},y=function(t,i){this.attr({x:this.ox+t,y:this.oy+i}),this.box.attr({width:this.box.ow+t,height:this.box.oh+i}),e.size.w=this.box.attr("width"),e.size.h=this.box.attr("height")};return $(o.node).click(function(t){return $("#canvas-debug").children().hide(),o.li.show(),h.find("div.mm-clean").remove(),h.append('<div class="mm-clean">pos : '+JSON.stringify(e.position)+"</div>"),h.append('<div class="mm-clean">size : '+JSON.stringify(e.size)+"</div>"),t.preventDefault(),!1}),o.drag(m,p,d),o.sizer=c,c.drag(y,u),c.box=o,o},Map.prototype.svgInit=function(e){this.R=Raphael(e,this.realWorldSize.w,this.realWorldSize.h),$(this.R.canvas).click(function(e){return $("#canvas-debug").children().hide(),e.preventDefault(),!1}),this.svgLoad()},Map.prototype.svgLoad=function(){this.svgDraw()},Map.prototype.svgDraw=function(){this.svgDrawBackground();for(var e in this.MapItems){var t=this.MapItems[e];this.svgRaphaelAddItem(t)}},Map.prototype.svgDrawBackground=function(){if(KLib.isUndefined(this.bgImg)||$(this.bgImg.node).remove(),""!==this.mapBackgroundName){var e=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(e)||(this.bgImg=this.R.rect(0,0,this.realWorldSize.w,this.realWorldSize.h),this.bgImg.attr({fill:"url('"+e.path+"')"}))}},KeyboardHandlerMap.prototype.handleKey=function(e,t){switch(e){case 37:this.canvasMap.translate.x+=5;break;case 39:this.canvasMap.translate.x-=5;break;case 38:this.canvasMap.translate.y+=5;break;case 40:this.canvasMap.translate.y-=5;break;case 90:if(!t)break;this.canvasMap.zoomToSelectedItems();break;case 83:if(!t)break;this.canvasMap.scale=1,this.canvasMap.translate={x:0,y:0};break;case 76:if(!t)break;this.canvasMap.scale*=1.1;break;case 77:this.canvasMap.actionTranslate=t,t&&(this.canvasMap.mouseDownPosition=this.canvasMap.canvasMousePosition);break;case 80:if(!t)break;this.canvasMap.scale*=.9;break;case 82:t&&this.canvasMap.deselectAllItems();break;case 16:this.canvasMap.keyPress.shift=t;break;default:}},KeyboardHandlerMap.prototype.handleKeyDown=function(e){this.handleKey(e.keyCode,!0)},KeyboardHandlerMap.prototype.handleKeyUp=function(e){this.handleKey(e.keyCode,!1)},Map.prototype.mouseDown=function(){this.mouseDownPosition=this.canvasMousePosition,this.action="",this.keyPress.shift?_.each(this.MapItems,function(e){this.isMousePositionInItem(e)&&(this.isItemSelected(e.id)?this.deselectItem(e.id):this.selectItem(e.id))}.bind(this)):(_.each(this.MapItems,function(e){this.isMousePositionInItem(e)&&(this.isItemSelected(e.id)||(this.deselectAllItems(),this.selectItem(e.id)),this.mouseDownOnItem=e,this.mouseDownInItemScaleZone(e,.8)?this.startScaling():this.startTranslating())}.bind(this)),"translate"!=this.action&&"scale"!=this.action&&(this.deselectAllItems(),this.action="selectZone"))},Map.prototype.mouseMove=function(e){this.canvasMousePosition={x:e.pageX-this.canvas.offsetLeft-this.translate.x,y:e.pageY-this.canvas.offsetTop-this.translate.y},this.canvasMousePosition.x*=1/this.scale,this.canvasMousePosition.y*=1/this.scale;var t="s-resize";if("scale"==this.action)document.body.style.cursor=t;else{var i=!1;_.each(this.MapItems,function(e){i||this.mouseDownInItemScaleZone(e,.9)&&(i=!0)}.bind(this)),document.body.style.cursor=i?t:"default"}if(0===e.button&&1===e.which)switch(this.action){case"translate":this.translateSelectedItemsUsingMousePosition();break;case"scale":this.scaleItemsUsingCanvasMouse()}},Map.prototype.mouseUp=function(){switch(this.action){case"selectZone":this.selectItemsInSelectedZone();break;case"scale":case"translate":break;default:}this.action=""},Map.prototype.saveMap=function(){var e=this,t=this.realWorldSize.w,i=this.realWorldSize.h,s={name:$("#map-name").val(),enable:e.enable,size:{w:parseInt(t/this.gScale,10),h:i/this.gScale}},a="/sprites/bg_grass1.png",n=this.itemsByName[this.mapBackgroundName];KLib.isUndefined(n)||(a=n.path),KLib.isUndefined(a)||(s.background={path:a,name:this.mapBackgroundName}),s.staticItems=[],$.each(this.MapItems,function(t,i){var a={};a.name=i.name,a.position={x:(i.position.x+i.size.w/2)/e.gScale,y:(i.position.y+i.size.h/2)/e.gScale},a.size={w:parseInt(i.size.w/e.gScale,10),h:parseInt(i.size.h/e.gScale,10)},s.staticItems.push(a)}),JSON.stringify(s),this.connection.emit("saveMap",s)},Map.prototype.zoomToSelectedItems=function(){var e,t,i,s;_.each(this.selectedItems,function(a){var n=this.MapItems[a];e===void 0&&(e=n),t===void 0&&(t=n),i===void 0&&(i=n),s===void 0&&(s=n),n.position.x<e.position.x&&(e=n),n.position.x+n.size.w>t.position.x+t.size.w&&(t=n),n.position.y<i.position.y&&(i=n),n.position.y+n.size.h>s.position.y+s.size.h&&(s=n)}.bind(this));var a=20;this.selectedItems.length>0&&(this.zoomBox={x:e.position.x-a,y:i.position.y-a,w:t.position.x+t.size.w-e.position.x+2*a,h:s.position.y+s.size.h-i.position.y+2*a})},Map.prototype.mouseDownInItemScaleZone=function(e,t){return this.canvasMousePosition.x<e.position.x+e.size.w*t?!1:this.canvasMousePosition.x>e.position.x+e.size.w?!1:this.canvasMousePosition.y<e.position.y+e.size.h*t?!1:this.canvasMousePosition.y>e.position.y+e.size.h?!1:!0},Map.prototype.selectItemsInSelectedZone=function(){_.each(this.MapItems,function(e){e.position.x<this.selectedZone.x||e.position.y<this.selectedZone.y||e.position.x+e.size.w>this.selectedZone.x+this.selectedZone.w||e.position.y+e.size.h>this.selectedZone.y+this.selectedZone.h||this.selectItem(e.id)}.bind(this))},Map.prototype.isMousePositionInItem=function(e){return this.canvasMousePosition.x<e.position.x?!1:this.canvasMousePosition.x>e.position.x+e.size.w?!1:this.canvasMousePosition.y<e.position.y?!1:this.canvasMousePosition.y>e.position.y+e.size.h?!1:!0},Map.prototype.deselectAllItems=function(){for(var e in this.itemsGlow)this.deselectItem(e);this.selectedItems=[]},Map.prototype.isItemSelected=function(e){return _.include(this.selectedItems,e)},Map.prototype.selectItem=function(e,t){this.selectedItems.push(e),KLib.isUndefined(t)||(t.isSelected=!0,this.itemsGlow[e]=t,$(t).attr("stroke","#000"),$(t.rectSelected).show())},Map.prototype.deselectItem=function(e){this.selectedItems.splice(this.selectedItems.indexOf(e),1);var t=this.itemsGlow[e];KLib.isUndefined(t)||(t.isSelected=!1,$(t.rectSelected).hide(),$(t).attr("stroke","transparent"))};